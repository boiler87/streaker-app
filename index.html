<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        /* Simple transition for form visibility */
        .form-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .form-container.open {
            max-height: 500px; /* Adjust as needed */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- App Container -->
    <div id="app-container">
        <!-- Loading State -->
        <div id="loading-state" class="min-h-screen flex items-center justify-center">Loading...</div>

        <!-- Auth Page -->
        <div id="auth-page" class="hidden">
            <div class="min-h-screen flex items-center justify-center bg-gray-50">
                <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-md">
                    <div class="flex items-center justify-center mb-6">
                        <img src="https://github.com/rynwynk/streaker-app/blob/main/logo%20only.png?raw=true" alt="Streaker Logo" class="h-10 w-10 mr-3" />
                        <h1 class="text-3xl font-bold text-gray-800">Streaker</h1>
                    </div>
                    <h2 id="auth-title" class="text-2xl font-bold text-center text-gray-700 mb-6">Sign In</h2>
                    <form id="auth-form">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="email">Email</label>
                            <input id="email" type="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="password">Password</label>
                            <input id="password" type="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-2 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                        </div>
                        <p id="auth-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                        <div class="flex items-center justify-between">
                            <button id="auth-submit-button" type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">Sign In</button>
                        </div>
                    </form>
                    <p class="text-center text-gray-500 text-sm mt-6">
                        <span id="auth-toggle-text">Don't have an account?</span>
                        <button id="auth-toggle-button" class="font-bold text-blue-500 hover:text-blue-800 ml-1">Sign Up</button>
                    </p>
                </div>
            </div>
        </div>

        <!-- Main App Page -->
        <div id="main-app" class="hidden">
            <nav class="bg-white shadow-md">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex items-center">
                            <img src="https://github.com/rynwynk/streaker-app/blob/main/logo%20only.png?raw=true" alt="Streaker Logo" class="h-8 w-8 mr-2" />
                            <span class="font-bold text-xl text-gray-800">Streaker</span>
                        </div>
                        <div class="hidden md:block">
                            <div class="ml-10 flex items-baseline space-x-4">
                                <button id="nav-dashboard" class="px-3 py-2 rounded-md text-sm font-medium bg-blue-500 text-white">Dashboard</button>
                                <button id="nav-journal" class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200">Journal</button>
                            </div>
                        </div>
                        <div>
                            <button id="sign-out-button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md text-sm font-medium">Sign Out</button>
                        </div>
                    </div>
                </div>
            </nav>
            <main id="page-content" class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <!-- Content will be injected here -->
            </main>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, query, orderBy, updateDoc, deleteDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
              apiKey: "AIzaSyBJR-2vWmIfGCYElJDY5W77phjJJMnEhuI",
              authDomain: "counter-a29f8.firebaseapp.com",
              projectId: "counter-a29f8",
              storageBucket: "counter-a29f8.firebasestorage.app",
              messagingSenderId: "881872302339",
              appId: "1:881872302339:web:3359545d32d6508f713936"
            };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentUser = null;
        let currentStreakStart = null;
        let goalDate = null;
        let logbook = [];
        let journalEntries = [];
        let isSignUp = false;
        let unsubscribeListeners = []; // To detach listeners on sign-out

        // --- DOM Elements ---
        const loadingState = document.getElementById('loading-state');
        const authPage = document.getElementById('auth-page');
        const mainApp = document.getElementById('main-app');
        const pageContent = document.getElementById('page-content');

        // --- Helper Functions ---
        const formatDate = (date) => {
            if (!date) return 'N/A';
            const d = date instanceof Date ? date : date.toDate();
            return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
        };

        const formatInputDate = (date) => {
            if (!date) return '';
            const d = date instanceof Date ? date : date.toDate();
            return d.toISOString().split('T')[0];
        };
        
        const parseInputDateAsLocal = (dateString) => {
            if (!dateString) return null;
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        };

        const calculateDuration = (start, end) => {
            if (!start || !end) return 0;
            let startDate = start instanceof Date ? start : start.toDate();
            let endDate = end instanceof Date ? end : end.toDate();
            const utcStart = Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate());
            const utcEnd = Date.UTC(endDate.getUTCFullYear(), endDate.getUTCMonth(), endDate.getUTCDate());
            const diffTime = utcEnd - utcStart;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays >= 0 ? diffDays : 0;
        };

        // --- UI Rendering ---
        const showPage = (page, message = "Loading...") => {
            loadingState.textContent = message;
            loadingState.classList.toggle('hidden', page !== 'loading');
            authPage.classList.toggle('hidden', page !== 'auth');
            mainApp.classList.toggle('hidden', page !== 'app');
        };

        const renderDashboard = () => {
            // Calculate stats
            const currentYear = new Date().getFullYear();
            let totalDaysFromLogbook = 0;
            let longestStreak = 0;
            logbook.forEach(entry => {
                if (entry.duration > longestStreak) longestStreak = entry.duration;
                const endDate = entry.endDate.toDate();
                if (endDate.getFullYear() === currentYear) {
                    const startDate = entry.startDate.toDate();
                    let daysInYear = (startDate.getFullYear() < currentYear) ? calculateDuration(new Date(currentYear, 0, 1), endDate) : entry.duration;
                    totalDaysFromLogbook += daysInYear;
                }
            });
            let finalTotalDays = totalDaysFromLogbook;
            if (currentStreakStart) {
                const streakStartDate = currentStreakStart.toDate();
                const today = new Date();
                const startOfYear = new Date(currentYear, 0, 1);
                const effectiveStartDate = streakStartDate > startOfYear ? streakStartDate : startOfYear;
                if (today >= startOfYear) finalTotalDays += calculateDuration(effectiveStartDate, today);
            }
            const avgStreak = logbook.length > 0 ? Math.round(logbook.reduce((acc, log) => acc + log.duration, 0) / logbook.length) : 0;
            const currentStreakDuration = currentStreakStart ? calculateDuration(currentStreakStart.toDate(), new Date()) : 0;
            
            // Goal progress
            let progress = 0;
            if (goalDate && currentStreakStart) {
                const totalDuration = calculateDuration(currentStreakStart.toDate(), goalDate.toDate());
                progress = totalDuration > 0 ? Math.min((currentStreakDuration / totalDuration) * 100, 100) : 100;
            }

            pageContent.innerHTML = `
                <div class="space-y-8">
                    <!-- Counter and Controls -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-semibold text-gray-700 mb-4">Current Streak</h2>
                            <div class="text-center">
                                <p class="text-7xl md:text-8xl font-bold text-blue-600">${currentStreakDuration}</p>
                                <p class="text-2xl text-gray-500">Days</p>
                            </div>
                            <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                                ${!currentStreakStart ? 
                                    `<button id="start-streak-btn" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300">Start a New Streak</button>` :
                                    `<button id="record-failure-btn" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300">Record Failure</button>`
                                }
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-between">
                            <div>
                                <div id="start-date-display" class="flex items-center mb-4"></div>
                                <div id="goal-date-display" class="flex items-center"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Goal Progress Bar -->
                    ${goalDate && currentStreakStart ? `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Progress Toward Goal</h3>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-blue-500 h-4 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        <p class="text-right text-sm text-gray-600 mt-1">${Math.round(progress)}% complete</p>
                    </div>` : ''}
                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <p class="text-3xl font-bold text-gray-800">${finalTotalDays}</p>
                            <p class="text-gray-500">Total Days This Year</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <p class="text-3xl font-bold text-gray-800">${longestStreak}</p>
                            <p class="text-gray-500">Longest Streak</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md text-center">
                            <p class="text-3xl font-bold text-gray-800">${avgStreak}</p>
                            <p class="text-gray-500">Average Streak Length</p>
                        </div>
                    </div>
                    <!-- Log Book -->
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-700">Log Book</h2>
                            <button id="manual-entry-btn" class="flex items-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                Manual Entry
                            </button>
                        </div>
                        <!-- Inline Form Container for Log Entry -->
                        <div id="log-form-container" class="form-container mb-4"></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="p-3 font-semibold text-gray-600">Start Date</th>
                                        <th class="p-3 font-semibold text-gray-600">End Date</th>
                                        <th class="p-3 font-semibold text-gray-600">Duration</th>
                                        <th class="p-3 font-semibold text-gray-600">Reason</th>
                                        <th class="p-3 font-semibold text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="logbook-body">
                                    ${logbook.map(entry => `
                                    <tr key=${entry.id} class="border-b hover:bg-gray-50">
                                        <td class="p-3">${formatDate(entry.startDate)}</td>
                                        <td class="p-3">${formatDate(entry.endDate)}</td>
                                        <td class="p-3">${entry.duration} days</td>
                                        <td class="p-3 truncate max-w-xs">${entry.reason || ''}</td>
                                        <td class="p-3">
                                            <div class="flex items-center gap-2">
                                                <button class="edit-log-btn text-blue-500 hover:text-blue-700" data-id="${entry.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                                <button class="delete-log-btn text-red-500 hover:text-red-700" data-id="${entry.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                                            </div>
                                        </td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            renderDatePickers();
            addDashboardEventListeners();
        };

        const renderJournal = (showAll = false) => {
            const visibleCount = showAll ? journalEntries.length : 5;
            pageContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Journal</h1>
                    <button id="new-journal-entry-btn" class="flex items-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        New Entry
                    </button>
                </div>
                <!-- Inline Form Container for Journal Entry -->
                <div id="journal-form-container" class="form-container mb-6"></div>
                <div id="journal-entries-container" class="space-y-6">
                    ${journalEntries.slice(0, visibleCount).map(entry => `
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <p class="text-gray-500 text-sm mb-2">${formatDate(entry.createdAt)}</p>
                        <p class="text-gray-700 whitespace-pre-wrap">${entry.content}</p>
                        <div class="flex justify-end items-center gap-2 mt-4">
                            <button class="edit-journal-btn text-blue-500 hover:text-blue-700" data-id="${entry.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                            <button class="delete-journal-btn text-red-500 hover:text-red-700" data-id="${entry.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                        </div>
                    </div>`).join('')}
                </div>
                ${journalEntries.length > 5 && !showAll ? `
                <div class="text-center mt-8">
                    <button id="view-more-journal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">View More</button>
                </div>` : ''}
            `;
            addJournalEventListeners();
        };

        const renderDatePickers = (editing = null) => {
            const startDateDisplay = document.getElementById('start-date-display');
            const goalDateDisplay = document.getElementById('goal-date-display');

            // Render Start Date Section
            if (editing === 'start') {
                startDateDisplay.innerHTML = `
                    <div class="flex items-center w-full">
                        <input type="date" id="new-start-date-input" value="${formatInputDate(currentStreakStart?.toDate())}" class="w-full p-1 border rounded-md focus:ring-blue-500 focus:border-blue-500" />
                        <button id="save-start-date-btn" class="ml-2 text-green-500 hover:text-green-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button>
                        <button id="cancel-start-date-btn" class="ml-2 text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </div>`;
            } else {
                startDateDisplay.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-5 w-5 text-gray-500"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <p class="font-semibold text-gray-600 mr-2">Start Date: ${formatDate(currentStreakStart?.toDate())}</p>
                    ${currentStreakStart ? `<button id="edit-start-date-btn" class="text-blue-500 hover:text-blue-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>` : ''}`;
            }

            // Render Goal Date Section
            if (editing === 'goal') {
                goalDateDisplay.innerHTML = `
                     <div class="flex items-center w-full">
                        <input type="date" id="new-goal-date-input" value="${formatInputDate(goalDate?.toDate())}" class="w-full p-1 border rounded-md focus:ring-blue-500 focus:border-blue-500" />
                        <button id="save-goal-date-btn" class="ml-2 text-green-500 hover:text-green-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button>
                        <button id="cancel-goal-date-btn" class="ml-2 text-red-500 hover:text-red-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </div>`;
            } else {
                goalDateDisplay.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-5 w-5 text-gray-500"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                    <p class="font-semibold text-gray-600 mr-2">Goal Date: ${formatDate(goalDate?.toDate())}</p>
                    <button id="edit-goal-date-btn" class="text-blue-500 hover:text-blue-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>`;
            }

            // Attach event listeners to the newly rendered elements
            const editStartBtn = document.getElementById('edit-start-date-btn');
            if(editStartBtn) editStartBtn.addEventListener('click', () => renderDatePickers('start'));
            const saveStartBtn = document.getElementById('save-start-date-btn');
            if(saveStartBtn) saveStartBtn.addEventListener('click', async () => {
                const newDate = parseInputDateAsLocal(document.getElementById('new-start-date-input').value);
                if (newDate && newDate <= new Date()) {
                    await setDoc(doc(db, 'users', currentUser.uid), { currentStreakStart: newDate }, { merge: true });
                }
            });
            const cancelStartBtn = document.getElementById('cancel-start-date-btn');
            if(cancelStartBtn) cancelStartBtn.addEventListener('click', () => renderDatePickers());

            const editGoalBtn = document.getElementById('edit-goal-date-btn');
            if(editGoalBtn) editGoalBtn.addEventListener('click', () => renderDatePickers('goal'));
            const saveGoalBtn = document.getElementById('save-goal-date-btn');
            if(saveGoalBtn) saveGoalBtn.addEventListener('click', async () => {
                const newDateStr = document.getElementById('new-goal-date-input').value;
                const newDate = newDateStr ? parseInputDateAsLocal(newDateStr) : null;
                if (newDate && currentStreakStart && newDate < currentStreakStart.toDate()) return;
                await setDoc(doc(db, 'users', currentUser.uid), { goalDate: newDate }, { merge: true });
            });
            const cancelGoalBtn = document.getElementById('cancel-goal-date-btn');
            if(cancelGoalBtn) cancelGoalBtn.addEventListener('click', () => renderDatePickers());
        };
        
        // --- Inline Form Logic ---
        const showLogForm = (entry = null) => {
            const container = document.getElementById('log-form-container');
            container.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h3 class="text-lg font-semibold mb-4">${entry ? 'Edit Streak Log' : 'Manually Record Streak'}</h3>
                    <form id="log-form">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="log-start-date">Start Date</label>
                                <input type="date" id="log-start-date" value="${entry ? formatInputDate(entry.startDate) : ''}" class="w-full p-2 border rounded" required />
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="log-end-date">End Date</label>
                                <input type="date" id="log-end-date" value="${entry ? formatInputDate(entry.endDate) : ''}" class="w-full p-2 border rounded" required />
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="log-reason">Reason (Optional)</label>
                            <textarea id="log-reason" class="w-full p-2 border rounded" rows="2">${entry ? entry.reason || '' : ''}</textarea>
                        </div>
                        <p id="log-form-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                        <div class="flex justify-end">
                            <button type="button" id="cancel-log-form" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mr-2">Cancel</button>
                            <button type="submit" id="submit-log-form" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Submit</button>
                        </div>
                    </form>
                </div>
            `;
            container.classList.add('open');

            document.getElementById('cancel-log-form').addEventListener('click', () => {
                container.classList.remove('open');
                container.innerHTML = '';
            });
            document.getElementById('log-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = document.getElementById('submit-log-form');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                const startDate = parseInputDateAsLocal(document.getElementById('log-start-date').value);
                const endDate = parseInputDateAsLocal(document.getElementById('log-end-date').value);
                const reason = document.getElementById('log-reason').value;
                if (startDate > endDate) {
                    document.getElementById('log-form-error').textContent = 'End date cannot be before start date.';
                    document.getElementById('log-form-error').classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                    return;
                }
                const logData = { startDate, endDate, reason, duration: calculateDuration(startDate, endDate) };
                try {
                    if (entry) {
                        await updateDoc(doc(db, `users/${currentUser.uid}/streaks`, entry.id), logData);
                    } else {
                        await addDoc(collection(db, `users/${currentUser.uid}/streaks`), logData);
                    }
                    container.classList.remove('open');
                    container.innerHTML = '';
                } catch (err) {
                    document.getElementById('log-form-error').textContent = 'Failed to save. Please try again.';
                    document.getElementById('log-form-error').classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                }
            });
        };

        const showJournalForm = (entry = null) => {
            const container = document.getElementById('journal-form-container');
            container.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-4">${entry ? 'Edit Journal Entry' : 'New Journal Entry'}</h3>
                    <form id="journal-form">
                        <div class="mb-4">
                            <textarea id="journal-content" class="w-full p-2 border rounded" rows="8" maxLength="1000" placeholder="Write your thoughts here...">${entry ? entry.content : ''}</textarea>
                            <p id="char-count" class="text-right text-sm text-gray-500 mt-1">${entry ? entry.content.length : 0} / 1000</p>
                        </div>
                        <p id="journal-form-error" class="text-red-500 text-xs italic mb-4 hidden"></p>
                        <div class="flex justify-end">
                            <button type="button" id="cancel-journal-form" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mr-2">Cancel</button>
                            <button type="submit" id="submit-journal-form" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Save Entry</button>
                        </div>
                    </form>
                </div>
            `;
            container.classList.add('open');
            
            const contentArea = document.getElementById('journal-content');
            const charCount = document.getElementById('char-count');
            contentArea.addEventListener('input', () => charCount.textContent = `${contentArea.value.length} / 1000`);
            document.getElementById('cancel-journal-form').addEventListener('click', () => {
                container.classList.remove('open');
                container.innerHTML = '';
            });
            document.getElementById('journal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = document.getElementById('submit-journal-form');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';

                const content = contentArea.value;
                if (content.trim() === '') {
                    document.getElementById('journal-form-error').textContent = 'Entry cannot be empty.';
                    document.getElementById('journal-form-error').classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Entry';
                    return;
                }
                const entryData = { content, updatedAt: serverTimestamp() };
                try {
                    if (entry) {
                        await updateDoc(doc(db, `users/${currentUser.uid}/journal`, entry.id), entryData);
                    } else {
                        entryData.createdAt = serverTimestamp();
                        await addDoc(collection(db, `users/${currentUser.uid}/journal`), entryData);
                    }
                    container.classList.remove('open');
                    container.innerHTML = '';
                } catch (err) {
                    document.getElementById('journal-form-error').textContent = 'Failed to save. Please try again.';
                    document.getElementById('journal-form-error').classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Entry';
                }
            });
        };


        // --- Event Listeners ---
        function addDashboardEventListeners() {
            // Main controls
            const startBtn = document.getElementById('start-streak-btn');
            if (startBtn) startBtn.addEventListener('click', () => setDoc(doc(db, 'users', currentUser.uid), { currentStreakStart: new Date() }, { merge: true }));
            const failureBtn = document.getElementById('record-failure-btn');
            if (failureBtn) failureBtn.addEventListener('click', async () => {
                const endDate = new Date();
                const newLog = {
                    startDate: currentStreakStart.toDate(),
                    endDate: endDate,
                    duration: calculateDuration(currentStreakStart.toDate(), endDate),
                    reason: 'Current streak ended.'
                };
                await addDoc(collection(db, `users/${currentUser.uid}/streaks`), newLog);
                await setDoc(doc(db, 'users', currentUser.uid), { currentStreakStart: null }, { merge: true });
            });
            
            // Logbook controls
            document.getElementById('manual-entry-btn').addEventListener('click', () => showLogForm());
            document.querySelectorAll('.edit-log-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const entry = logbook.find(item => item.id === e.currentTarget.dataset.id);
                showLogForm(entry);
            }));
            document.querySelectorAll('.delete-log-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                if (confirm('Are you sure you want to delete this log entry?')) {
                    await deleteDoc(doc(db, `users/${currentUser.uid}/streaks`, e.currentTarget.dataset.id));
                }
            }));
        }

        function addJournalEventListeners() {
            document.getElementById('new-journal-entry-btn').addEventListener('click', () => showJournalForm());
            const viewMoreBtn = document.getElementById('view-more-journal-btn');
            if (viewMoreBtn) viewMoreBtn.addEventListener('click', () => renderJournal(true));

            document.querySelectorAll('.edit-journal-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const entry = journalEntries.find(item => item.id === e.currentTarget.dataset.id);
                showJournalForm(entry);
            }));
            document.querySelectorAll('.delete-journal-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                if (confirm('Are you sure you want to delete this journal entry?')) {
                    await deleteDoc(doc(db, `users/${currentUser.uid}/journal`, e.currentTarget.dataset.id));
                }
            }));
        }

        // --- App Initialization ---
        async function initializeAppLogic(user) {
            currentUser = user;
            showPage('loading', 'Fetching your data...');

            // Detach any old listeners
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            // Fetch all data initially to prevent race conditions
            const userDocRef = doc(db, 'users', user.uid);
            const streaksQuery = query(collection(db, `users/${user.uid}/streaks`), orderBy('endDate', 'desc'));
            const journalQuery = query(collection(db, `users/${user.uid}/journal`), orderBy('createdAt', 'desc'));

            try {
                const [userDocSnap, streaksSnap, journalSnap] = await Promise.all([
                    getDoc(userDocRef),
                    getDocs(streaksQuery),
                    getDocs(journalQuery)
                ]);

                // Process initial data
                if (userDocSnap.exists()) {
                    const data = userDocSnap.data();
                    currentStreakStart = data.currentStreakStart || null;
                    goalDate = data.goalDate || null;
                }
                logbook = streaksSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                journalEntries = journalSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Now that we have data, render the UI
                renderDashboard();
                showPage('app');

                // Attach real-time listeners for subsequent updates
                const unsubUser = onSnapshot(userDocRef, (docSnap) => {
                    const data = docSnap.exists() ? docSnap.data() : {};
                    currentStreakStart = data.currentStreakStart || null;
                    goalDate = data.goalDate || null;
                    if (document.getElementById('nav-dashboard').classList.contains('bg-blue-500')) {
                        renderDashboard();
                    }
                });
                const unsubStreaks = onSnapshot(streaksQuery, (snapshot) => {
                    logbook = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     if (document.getElementById('nav-dashboard').classList.contains('bg-blue-500')) {
                        renderDashboard();
                    }
                });
                const unsubJournal = onSnapshot(journalQuery, (snapshot) => {
                    journalEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (document.getElementById('nav-journal').classList.contains('bg-blue-500')) {
                        renderJournal();
                    }
                });
                unsubscribeListeners = [unsubUser, unsubStreaks, unsubJournal];

            } catch (error) {
                console.error("Failed to fetch initial data:", error);
                showPage('auth'); // Fallback to auth page on error
            }
        }

        async function initializeAuth() {
            try {
                await setPersistence(auth, browserLocalPersistence);
            } catch (error) {
                console.error("Error setting auth persistence:", error);
            }

            onAuthStateChanged(auth, user => {
                if (user) {
                    initializeAppLogic(user);
                } else {
                    currentUser = null;
                    unsubscribeListeners.forEach(unsub => unsub());
                    unsubscribeListeners = [];
                    showPage('auth');
                }
            });
        }

        // --- Auth Form Logic ---
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            authError.classList.add('hidden');
            try {
                if (isSignUp) {
                    await createUserWithEmailAndPassword(auth, email, password);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (err) {
                authError.textContent = err.message;
                authError.classList.remove('hidden');
            }
        });

        const authToggleButton = document.getElementById('auth-toggle-button');
        authToggleButton.addEventListener('click', () => {
            isSignUp = !isSignUp;
            document.getElementById('auth-title').textContent = isSignUp ? 'Create Account' : 'Sign In';
            document.getElementById('auth-submit-button').textContent = isSignUp ? 'Sign Up' : 'Sign In';
            document.getElementById('auth-toggle-text').textContent = isSignUp ? 'Already have an account?' : "Don't have an account?";
            authToggleButton.textContent = isSignUp ? 'Sign In' : 'Sign Up';
        });
        
        // --- Navigation ---
        document.getElementById('nav-dashboard').addEventListener('click', () => {
            document.getElementById('nav-dashboard').classList.add('bg-blue-500', 'text-white');
            document.getElementById('nav-journal').classList.remove('bg-blue-500', 'text-white');
            renderDashboard();
        });
        document.getElementById('nav-journal').addEventListener('click', () => {
            document.getElementById('nav-journal').classList.add('bg-blue-500', 'text-white');
            document.getElementById('nav-dashboard').classList.remove('bg-blue-500', 'text-white');
            renderJournal();
        });
        document.getElementById('sign-out-button').addEventListener('click', () => signOut(auth));

        // Start the app
        initializeAuth();

    </script>

</body>
</html>
