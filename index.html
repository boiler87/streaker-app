<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3-3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 700px;
        }
        .form-container, .dashboard-container {
            display: none; /* Hide sections by default */
        }
        .form-container.active, .dashboard-container.active {
            display: block; /* Show active section */
        }
        input, button, textarea {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
        }
        button {
            background-color: #4f46e5;
            color: #ffffff;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #4338ca;
        }
        .message-box {
            background-color: #e5e7eb;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #4b5563;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }
        .section-header {
            font-weight: 700;
            font-size: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            color: #374151;
        }
        .journal-entry {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            text-align: left;
            margin-bottom: 0.75rem;
            cursor: pointer;
        }
        .journal-entry:hover {
            background-color: #f3f4f6;
        }
        .tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 1rem;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.3s;
        }
        .tab-btn.active {
            color: #4f46e5;
            border-bottom: 2px solid #4f46e5;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            text-align: left;
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover, .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* Table Styles */
        .sortable-table {
            width: 100%;
            border-collapse: collapse;
        }
        .sortable-table th, .sortable-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        .sortable-table th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #f2f2f2;
            cursor: pointer;
        }
        .sortable-table th.sorted-asc::after {
            content: " ▲";
        }
        .sortable-table th.sorted-desc::after {
            content: " ▼";
        }
        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            height: 2rem;
            margin-top: 1rem;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            background-color: #4f46e5;
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-weight: 600;
        }
        .logout-btn-header {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 3rem;
            height: 3rem;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            background-color: #ef4444;
            color: white;
            font-size: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="auth-forms" class="form-container active">
            <h1 class="text-3xl font-bold mb-4 text-center">Streaker</h1>
            <!-- Login Form -->
            <div id="login-form" class="active">
                <p class="text-gray-600 mb-6 text-center">Log in to your account</p>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button id="login-btn">Log In</button>
                <p class="mt-4 text-sm text-gray-500 text-center">
                    Don't have an account? <a href="#" id="show-register" class="text-blue-600 hover:underline">Register here</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden">
                <p class="text-gray-600 mb-6 text-center">Create a new account</p>
                <input type="email" id="register-email" placeholder="Email" required>
                <input type="password" id="register-password" placeholder="Password" required>
                <button id="register-btn">Register</button>
                <p class="mt-4 text-sm text-gray-500 text-center">
                    Already have an account? <a href="#" id="show-login" class="text-blue-600 hover:underline">Log in here</a>
                </p>
            </div>
        </div>

        <!-- Main Dashboard View -->
        <div id="dashboard-view" class="dashboard-container">
            <div class="flex justify-between items-center relative">
                <h1 id="app-title" class="text-3xl font-bold mb-4">Streaker</h1>
                <button id="logout-btn" class="logout-btn-header">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
            
            <div class="tabs">
                <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
                <button class="tab-btn" data-tab="journal">Journal</button>
            </div>

            <!-- Dashboard Tab Content -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="card">
                    <h3 class="section-header">Current Streak</h3>
                    <div id="streak-timer" class="text-4xl font-mono text-purple-600 my-4">00:00:00:00</div>
                    <p id="start-date-display" class="text-sm text-gray-500"></p>
                    <div class="my-4">
                        <input type="date" id="start-date-picker" class="w-auto mr-2">
                        <button id="set-start-date-btn" class="w-auto px-4 py-2">Set Start Date</button>
                        <button id="record-failure-btn" class="w-auto px-4 py-2 bg-red-500 hover:bg-red-600">Record Failure</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="text-left">
                        <p class="text-lg">Total Days This Year: <span id="total-days-this-year">0</span></p>
                        <p class="text-lg">Longest Streak: <span id="longest-streak">0 days</span></p>
                        <p class="text-lg">Average Streak: <span id="average-streak">0 days</span></p>
                    </div>

                    <h4 class="section-header text-xl">Progress</h4>
                    <p id="goal-date-display" class="text-sm text-gray-500"></p>
                    <div class="my-4">
                        <input type="date" id="goal-date-picker" class="w-auto mr-2">
                        <button id="set-goal-date-btn" class="w-auto px-4 py-2">Set Goal Date</button>
                    </div>
                    <div class="progress-bar-container">
                        <div id="goal-progress-bar" class="progress-bar" style="width: 0%;">0%</div>
                    </div>

                    <h4 class="section-header text-xl">Log Book</h4>
                    <table id="streaks-table" class="sortable-table w-full">
                        <thead>
                            <tr>
                                <th data-sort-by="startDate">Start Date</th>
                                <th data-sort-by="endDate">End Date</th>
                                <th data-sort-by="duration">Duration</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody id="streaks-table-body">
                            <!-- Streak data will be populated here -->
                        </tbody>
                    </table>
                    <button id="add-manual-streak-btn" class="w-auto px-4 py-2 mt-4">Manually Add Streak</button>
                </div>
            </div>

            <!-- Journal Tab Content -->
            <div id="journal-tab" class="tab-content">
                <div class="card">
                    <h3 class="section-header">Journal</h3>
                    <div class="text-left">
                        <p class="text-lg">Journal Entries: <span id="journal-count">0</span></p>
                    </div>
                    <div class="journal-form">
                        <textarea id="journal-text" rows="4" placeholder="Write about your day..."></textarea>
                        <button id="add-journal-btn">Add Journal Entry</button>
                    </div>
                    <div id="journal-list" class="mt-4">
                        <!-- Journal entries will be displayed here -->
                    </div>
                    <button id="view-all-journals-btn" class="w-auto px-4 py-2 mt-4">View More</button>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Failure Modal -->
    <div id="failure-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 class="text-xl font-bold mb-4">Record a Failure</h3>
            <p class="text-gray-600 mb-4">Please provide a reason for the streak failure. This will reset your current streak.</p>
            <textarea id="failure-reason-text" rows="4" class="w-full"></textarea>
            <div class="flex justify-end space-x-4 mt-4">
                <button id="modal-cancel-btn" class="w-auto px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800">Cancel</button>
                <button id="modal-submit-btn" class="w-auto px-6 py-2 bg-red-500 hover:bg-red-600 text-white">Submit</button>
            </div>
        </div>
    </div>

    <!-- Manual Streak Modal -->
    <div id="manual-streak-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 class="text-xl font-bold mb-4">Manually Add Streak</h3>
            <div class="mb-4">
                <label for="manual-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                <input type="date" id="manual-start-date" class="mt-1 block w-full">
            </div>
            <div class="mb-4">
                <label for="manual-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                <input type="date" id="manual-end-date" class="mt-1 block w-full">
            </div>
            <div class="mb-4">
                <label for="manual-reason" class="block text-sm font-medium text-gray-700">Reason for Ending</label>
                <textarea id="manual-reason" rows="4" class="mt-1 block w-full"></textarea>
            </div>
            <div class="flex justify-end space-x-4 mt-4">
                <button id="manual-cancel-btn" class="w-auto px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800">Cancel</button>
                <button id="manual-submit-btn" class="w-auto px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white">Submit</button>
            </div>
        </div>
    </div>

    <!-- Journal Entry Modal -->
    <div id="journal-entry-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 class="text-xl font-bold mb-4">Journal Entry</h3>
            <p class="text-sm text-gray-400 mb-2" id="journal-modal-date"></p>
            <div class="mb-4">
                <textarea id="journal-modal-text" rows="10" class="w-full"></textarea>
            </div>
            <div class="flex justify-between space-x-4 mt-4">
                <button id="journal-modal-delete-btn" class="w-auto px-6 py-2 bg-red-500 hover:bg-red-600 text-white">Delete</button>
                <div class="flex space-x-4">
                    <button id="journal-modal-cancel-btn" class="w-auto px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800">Cancel</button>
                    <button id="journal-modal-save-btn" class="w-auto px-6 py-2 bg-green-500 hover:bg-green-600 text-white">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyBJR-2vWmIfGCYElJDY5W77phjJJMnEhuI",
            authDomain: "counter-a29f8.firebaseapp.com",
            projectId: "counter-a29f8",
            storageBucket: "counter-a29f8.firebasestorage.app",
            messagingSenderId: "881872302339",
            appId: "1:881872302339:web:3359545d32d6508f713936"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            collection,
            addDoc,
            onSnapshot,
            query,
            getDoc,
            updateDoc,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM elements
        const authForms = document.getElementById('auth-forms');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const dashboardView = document.getElementById('dashboard-view');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const streakTimerEl = document.getElementById('streak-timer');
        const startDateDisplayEl = document.getElementById('start-date-display');
        const startDatePickerEl = document.getElementById('start-date-picker');
        const setStartDateBtn = document.getElementById('set-start-date-btn');
        const recordFailureBtn = document.getElementById('record-failure-btn');
        const goalDatePickerEl = document.getElementById('goal-date-picker');
        const goalDateDisplayEl = document.getElementById('goal-date-display');
        const setGoalDateBtn = document.getElementById('set-goal-date-btn');
        const journalTextEl = document.getElementById('journal-text');
        const addJournalBtn = document.getElementById('add-journal-btn');
        const journalListEl = document.getElementById('journal-list');
        const totalDaysEl = document.getElementById('total-days-this-year');
        const longestStreakEl = document.getElementById('longest-streak');
        const averageStreakEl = document.getElementById('average-streak');
        const journalCountEl = document.getElementById('journal-count');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const failureModal = document.getElementById('failure-modal');
        const modalCloseBtn = failureModal.querySelector('.close-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalSubmitBtn = document.getElementById('modal-submit-btn');
        const failureReasonTextarea = document.getElementById('failure-reason-text');
        const streaksTableBody = document.getElementById('streaks-table-body');
        const streaksTableHeaders = document.querySelectorAll('#streaks-table th');
        const viewAllJournalsBtn = document.getElementById('view-all-journals-btn');
        const addManualStreakBtn = document.getElementById('add-manual-streak-btn');
        const manualStreakModal = document.getElementById('manual-streak-modal');
        const manualModalCloseBtn = manualStreakModal.querySelector('.close-btn');
        const manualCancelBtn = document.getElementById('manual-cancel-btn');
        const manualSubmitBtn = document.getElementById('manual-submit-btn');
        const manualStartDateInput = document.getElementById('manual-start-date');
        const manualEndDateInput = document.getElementById('manual-end-date');
        const manualReasonInput = document.getElementById('manual-reason');
        const goalProgressBarEl = document.getElementById('goal-progress-bar');
        const logoutBtn = document.getElementById('logout-btn');
        const journalEntryModal = document.getElementById('journal-entry-modal');
        const journalModalCloseBtn = journalEntryModal.querySelector('.close-btn');
        const journalModalDateEl = document.getElementById('journal-modal-date');
        const journalModalTextEl = document.getElementById('journal-modal-text');
        const journalModalSaveBtn = document.getElementById('journal-modal-save-btn');
        const journalModalDeleteBtn = document.getElementById('journal-modal-delete-btn');
        const journalModalCancelBtn = document.getElementById('journal-modal-cancel-btn');


        // Firebase services
        let app, auth, db;
        let currentUser;
        let streakInterval;
        let pastStreaks = [];
        let allJournalEntries = [];
        let currentStreakStartDate;
        let goalDate;
        const DEFAULT_START_DATE = '2025-08-14';
        const ENTRIES_PER_PAGE = 5;

        // A map to store event listeners for cleanup
        const listeners = {};

        function addListener(element, event, handler) {
            if (element) {
                element.addEventListener(event, handler);
                if (!listeners[event]) listeners[event] = new Map();
                listeners[event].set(element, handler);
            }
        }

        function removeAllListeners() {
            for (const event in listeners) {
                for (const [element, handler] of listeners[event]) {
                    if (element && handler) {
                        element.removeEventListener(event, handler);
                    }
                }
                listeners[event].clear();
            }
        }
        
        /**
         * Toggles between login and register forms.
         * @param {Event} e The click event.
         */
        function toggleForms(e) {
            e.preventDefault();
            if (e.target.id === 'show-register') {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            } else {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            }
        }

        /**
         * Handles user registration.
         */
        async function handleRegister() {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            if (!email || !password) {
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Registration error:', error);
            }
        }

        /**
         * Handles user login.
         */
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) {
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
            }
        }
        
        /**
         * Handles user logout.
         */
        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        /**
         * Loads and displays the user's start date and goal from Firestore.
         * @param {Object} user The Firebase user object.
         */
        function loadUserStreakInfo(user) {
            const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/streak/info`);
            return onSnapshot(userDocRef, async (docSnap) => {
                let startDateString;
                let goalDateString;
                if (docSnap.exists()) {
                    startDateString = docSnap.data().startDate || DEFAULT_START_DATE;
                    goalDateString = docSnap.data().goalDate;
                } else {
                    startDateString = DEFAULT_START_DATE;
                    try {
                        await setDoc(userDocRef, { startDate: startDateString });
                    } catch (error) {
                        console.error('Error setting default start date:', error);
                        return;
                    }
                }
                
                const parts = startDateString.split('-');
                currentStreakStartDate = new Date(parts[0], parts[1] - 1, parts[2]);

                startDateDisplayEl.textContent = `Start Date: ${currentStreakStartDate.toLocaleDateString()}`;
                
                if (goalDateString) {
                    const goalParts = goalDateString.split('-');
                    goalDate = new Date(goalParts[0], goalParts[1] - 1, goalParts[2]);
                    goalDateDisplayEl.textContent = `Goal Date: ${goalDate.toLocaleDateString()}`;
                } else {
                    goalDate = null;
                    goalDateDisplayEl.textContent = 'No goal date set.';
                }
                
                startCountdown(currentStreakStartDate);
                updateGoalProgress();
            }, (error) => {
                console.error('Error loading streak info:', error);
            });
        }

        /**
         * Handles setting a new start date for the streak.
         */
        async function handleSetStartDate() {
            if (!currentUser) return;
            const selectedDate = startDatePickerEl.value;
            if (!selectedDate) {
                return;
            }
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/streak/info`);
                await setDoc(userDocRef, { startDate: selectedDate }, { merge: true });
            } catch (error) {
                console.error('Error setting start date:', error);
            }
        }
        
        /**
         * Handles setting a new goal date.
         */
        async function handleSetGoalDate() {
            if (!currentUser) return;
            const selectedDate = goalDatePickerEl.value;
            if (!selectedDate) {
                return;
            }
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/streak/info`);
                await setDoc(userDocRef, { goalDate: selectedDate }, { merge: true });
            } catch (error) {
                console.error('Error setting goal date:', error);
            }
        }

        /**
         * Formats a number with leading zeros.
         * @param {number} num The number to format.
         * @returns {string} The formatted string.
         */
        function pad(num) {
            return num < 10 ? `0${num}` : num;
        }

        /**
         * Starts the visual countdown timer.
         * @param {Date} startDate The date to count up from.
         */
        function startCountdown(startDate) {
            if (streakInterval) clearInterval(streakInterval);

            const updateTimer = () => {
                const now = new Date();
                const diff = now - startDate;

                if (diff < 0) {
                    streakTimerEl.textContent = '00:00:00:00';
                    return;
                }

                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                streakTimerEl.textContent = `${pad(days)}:${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
            };

            updateTimer();
            streakInterval = setInterval(updateTimer, 1000);
        }

        /**
         * Updates the goal progress bar on the stats page.
         */
        function updateGoalProgress() {
            if (!currentStreakStartDate || !goalDate) {
                goalProgressBarEl.style.width = '0%';
                goalProgressBarEl.textContent = '0%';
                return;
            }
            
            const now = new Date();
            const totalDuration = goalDate.getTime() - currentStreakStartDate.getTime();
            const elapsedDuration = now.getTime() - currentStreakStartDate.getTime();
            
            let percent = 0;
            if (totalDuration > 0) {
                percent = Math.min(100, (elapsedDuration / totalDuration) * 100);
            }
            
            goalProgressBarEl.style.width = `${percent.toFixed(0)}%`;
            goalProgressBarEl.textContent = `${percent.toFixed(0)}%`;
        }


        /**
         * Handles adding a new journal entry.
         */
        async function handleAddJournalEntry() {
            if (!currentUser) return;
            const journalText = journalTextEl.value.trim();
            if (!journalText) {
                return;
            }

            try {
                const journalCollectionRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/journal`);
                await addDoc(journalCollectionRef, {
                    content: journalText,
                    timestamp: new Date().toISOString()
                });
                journalTextEl.value = ''; // Clear the input
            } catch (error) {
                console.error('Error adding journal entry:', error);
            }
        }
        
        /**
         * Renders journal entries to the page.
         * @param {Array<Object>} entries The journal entries to render.
         * @param {boolean} fullView Whether to render the full entry or a truncated preview.
         */
        function renderJournalEntries(entries, fullView = false) {
            journalListEl.innerHTML = '';
            if (entries.length === 0) {
                journalListEl.innerHTML = '<p class="text-gray-500">No journal entries yet. Add one to get started!</p>';
            } else {
                entries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'journal-entry';
                    entryDiv.dataset.entryId = entry.id;
                    const date = new Date(entry.timestamp).toLocaleDateString();

                    const contentPreview = entry.content.split('. ')[0];
                    entryDiv.innerHTML = `
                        <p class="text-sm text-gray-400 mb-1">${date}</p>
                        <p class="text-gray-700">${contentPreview}...</p>
                    `;
                    journalListEl.appendChild(entryDiv);
                });
            }
        }
        
        /**
         * Loads and displays journal entries from Firestore.
         * @param {Object} user The Firebase user object.
         */
        function loadJournalEntries(user) {
            const journalCollectionRef = collection(db, `artifacts/${appId}/users/${user.uid}/journal`);
            const q = query(journalCollectionRef);
            
            return onSnapshot(q, (snapshot) => {
                allJournalEntries = [];
                snapshot.forEach(doc => {
                    allJournalEntries.push({ id: doc.id, ...doc.data() });
                });
                
                allJournalEntries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                journalCountEl.textContent = allJournalEntries.length;
                
                const recentEntries = allJournalEntries.slice(0, ENTRIES_PER_PAGE);
                renderJournalEntries(recentEntries);
                
                if (allJournalEntries.length > ENTRIES_PER_PAGE) {
                    viewAllJournalsBtn.classList.remove('hidden');
                } else {
                    viewAllJournalsBtn.classList.add('hidden');
                }
            }, (error) => {
                console.error('Error loading journal entries:', error);
            });
        }
        
        /**
         * Displays all journal entries.
         */
        function handleViewMoreJournals() {
            renderJournalEntries(allJournalEntries, true);
            viewAllJournalsBtn.classList.add('hidden');
        }

        /**
         * Shows the selected tab content and hides the others.
         * @param {string} tabId The ID of the tab to show.
         */
        function showTab(tabId) {
            tabContents.forEach(tab => {
                tab.classList.remove('active');
            });
            tabBtns.forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[data-tab="${tabId.replace('-tab', '')}"]`).classList.add('active');
        }

        /**
         * Toggles the visibility of a modal.
         * @param {Element} modal The modal element to toggle.
         * @param {boolean} show Whether to show or hide the modal.
         */
        function toggleModal(modal, show) {
            modal.style.display = show ? 'flex' : 'none';
        }

        /**
         * Handles recording a streak failure.
         */
        async function handleRecordFailure() {
            if (!currentUser) return;
            toggleModal(failureModal, true);
        }

        /**
         * Submits the failure reason and resets the streak.
         */
        async function submitFailure() {
            const reason = failureReasonTextarea.value.trim();
            if (!reason) {
                return;
            }

            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/streak/info`);
                const docSnap = await getDoc(userDocRef);
                const startDate = docSnap.exists() ? docSnap.data().startDate : DEFAULT_START_DATE;

                const pastStreaksRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/pastStreaks`);
                await addDoc(pastStreaksRef, {
                    startDate: startDate,
                    endDate: new Date().toISOString().slice(0, 10),
                    reason: reason
                });

                await setDoc(userDocRef, { startDate: new Date().toISOString().slice(0, 10) });

                failureReasonTextarea.value = '';
                toggleModal(failureModal, false);
            } catch (error) {
                console.error('Error recording failure:', error);
            }
        }
        
        /**
         * Handles manually adding a streak.
         */
        async function handleAddManualStreak() {
            if (!currentUser) return;
            toggleModal(manualStreakModal, true);
        }

        /**
         * Submits the manually entered streak data.
         */
        async function submitManualStreak() {
            const startDate = manualStartDateInput.value;
            const endDate = manualEndDateInput.value;
            const reason = manualReasonInput.value.trim();

            if (!startDate || !endDate) {
                return;
            }

            try {
                const pastStreaksRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/pastStreaks`);
                await addDoc(pastStreaksRef, {
                    startDate: startDate,
                    endDate: endDate,
                    reason: reason || 'No reason provided.'
                });

                manualStartDateInput.value = '';
                manualEndDateInput.value = '';
                manualReasonInput.value = '';
                toggleModal(manualStreakModal, false);
            } catch (error) {
                console.error('Error adding manual streak:', error);
            }
        }

        /**
         * Handles viewing a specific journal entry.
         * @param {string} entryId The ID of the journal entry.
         */
        function handleViewJournalEntry(entryId) {
            const entry = allJournalEntries.find(e => e.id === entryId);
            if (entry) {
                journalModalDateEl.textContent = new Date(entry.timestamp).toLocaleString();
                journalModalTextEl.value = entry.content;
                journalModalSaveBtn.dataset.entryId = entryId;
                journalModalDeleteBtn.dataset.entryId = entryId;
                toggleModal(journalEntryModal, true);
            }
        }

        /**
         * Handles saving an edited journal entry.
         */
        async function handleSaveJournalEntry() {
            if (!currentUser) return;
            const entryId = journalModalSaveBtn.dataset.entryId;
            const updatedContent = journalModalTextEl.value;

            try {
                const entryDocRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/journal`, entryId);
                await updateDoc(entryDocRef, {
                    content: updatedContent,
                    timestamp: new Date().toISOString()
                });
                toggleModal(journalEntryModal, false);
            } catch (error) {
                console.error('Error saving journal entry:', error);
            }
        }

        /**
         * Handles deleting a journal entry.
         */
        async function handleDeleteJournalEntry() {
            if (!currentUser) return;
            const entryId = journalModalDeleteBtn.dataset.entryId;
            
            try {
                const entryDocRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/journal`, entryId);
                await deleteDoc(entryDocRef);
                toggleModal(journalEntryModal, false);
            } catch (error) {
                console.error('Error deleting journal entry:', error);
            }
        }

        /**
         * Calculates the duration between two dates in days and hours, with rounding.
         * @param {string} startISO The start date in ISO format.
         * @param {string} endISO The end date in ISO format.
         * @returns {number} The total duration in days (rounded).
         */
        function calculateDurationInDays(startISO, endISO) {
            const startDate = new Date(startISO);
            const endDate = new Date(endISO);
            const diffMs = endDate - startDate;
            const totalHours = diffMs / (1000 * 60 * 60);
            const days = Math.floor(totalHours / 24);
            const hours = totalHours % 24;
            return hours >= 12 ? days + 1 : days;
        }

        /**
         * Calculates the duration between two dates in days and hours, with rounding.
         * @param {string} startISO The start date in ISO format.
         * @param {string} endISO The end date in ISO format.
         * @returns {string} The formatted duration string.
         */
        function calculateDuration(startISO, endISO) {
            const startDate = new Date(startISO);
            const endDate = new Date(endISO);
            const diffMs = endDate - startDate;
            
            const totalHours = diffMs / (1000 * 60 * 60);
            const days = Math.floor(totalHours / 24);
            const hours = Math.round(totalHours % 24);

            return `${days} days, ${hours} hours`;
        }

        /**
         * Renders the streaks table with data.
         * @param {Array<Object>} data The array of streak objects.
         */
        function renderStreaksTable(data) {
            streaksTableBody.innerHTML = '';
            data.forEach(streak => {
                const row = document.createElement('tr');
                const duration = calculateDuration(streak.startDate, streak.endDate);
                
                row.innerHTML = `
                    <td>${streak.startDate}</td>
                    <td>${streak.endDate}</td>
                    <td>${duration}</td>
                    <td><button class="view-reason-btn" data-reason="${streak.reason}">View</button></td>
                `;
                streaksTableBody.appendChild(row);
            });
        }
        
        /**
         * Loads and displays past streaks from Firestore.
         * @param {Object} user The Firebase user object.
         */
        function loadPastStreaks(user) {
            const pastStreaksRef = collection(db, `artifacts/${appId}/users/${user.uid}/pastStreaks`);
            const q = query(pastStreaksRef);

            return onSnapshot(q, (snapshot) => {
                pastStreaks = [];
                let totalDaysInLogBook = 0;
                let longestStreak = 0;
                let currentYear = new Date().getFullYear();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    pastStreaks.push({
                        id: doc.id,
                        startDate: data.startDate,
                        endDate: data.endDate,
                        reason: data.reason
                    });
                    
                    const durationInDays = calculateDurationInDays(data.startDate, data.endDate);
                    totalDaysInLogBook += durationInDays;

                    if (durationInDays > longestStreak) {
                        longestStreak = durationInDays;
                    }
                });

                // Calculate total days for the current calendar year
                let totalDaysThisYear = 0;
                
                // Add days from past streaks that fall within the current year
                pastStreaks.forEach(streak => {
                    const startDate = new Date(streak.startDate);
                    const endDate = new Date(streak.endDate);
                    
                    if (startDate.getFullYear() === currentYear && endDate.getFullYear() === currentYear) {
                        totalDaysThisYear += calculateDurationInDays(streak.startDate, streak.endDate);
                    } else if (startDate.getFullYear() < currentYear && endDate.getFullYear() === currentYear) {
                        const startOfYear = new Date(currentYear, 0, 1);
                        totalDaysThisYear += calculateDurationInDays(startOfYear.toISOString().slice(0, 10), streak.endDate);
                    } else if (startDate.getFullYear() === currentYear && endDate.getFullYear() > currentYear) {
                        const endOfYear = new Date(currentYear, 11, 31);
                        totalDaysThisYear += calculateDurationInDays(streak.startDate, endOfYear.toISOString().slice(0, 10));
                    }
                });

                // Add days from the current active streak
                if (currentStreakStartDate) {
                    const now = new Date();
                    const startOfYear = new Date(now.getFullYear(), 0, 1);
                    if (currentStreakStartDate.getFullYear() === currentYear) {
                        totalDaysThisYear += calculateDurationInDays(currentStreakStartDate.toISOString().slice(0, 10), now.toISOString().slice(0, 10));
                    } else if (currentStreakStartDate.getFullYear() < currentYear) {
                        totalDaysThisYear += calculateDurationInDays(startOfYear.toISOString().slice(0, 10), now.toISOString().slice(0, 10));
                    }
                }
                
                totalDaysEl.textContent = totalDaysThisYear;
                longestStreakEl.textContent = `${longestStreak} days`;
                const averageStreak = pastStreaks.length > 0 ? Math.round(totalDaysInLogBook / pastStreaks.length) : 0;
                averageStreakEl.textContent = `${averageStreak} days`;
                
                renderStreaksTable(pastStreaks);
            }, (error) => {
                console.error('Error loading past streaks:', error);
            });
        }

        /**
         * Sorts the streaks table by the selected column.
         * @param {string} sortBy The column to sort by.
         */
        function sortStreaksTable(sortBy) {
            const headers = Array.from(streaksTableHeaders);
            headers.forEach(header => header.classList.remove('sorted-asc', 'sorted-desc'));
            const currentHeader = document.querySelector(`[data-sort-by="${sortBy}"]`);
            const isAsc = currentHeader.classList.contains('sorted-asc');
            currentHeader.classList.toggle('sorted-asc', !isAsc);
            currentHeader.classList.toggle('sorted-desc', isAsc);

            pastStreaks.sort((a, b) => {
                let aVal, bVal;
                switch (sortBy) {
                    case 'startDate':
                    case 'endDate':
                        aVal = new Date(a[sortBy]);
                        bVal = new Date(b[sortBy]);
                        break;
                    case 'duration':
                        const startA = new Date(a.startDate);
                        const endA = new Date(a.endDate);
                        const startB = new Date(b.startDate);
                        const endB = new Date(b.endDate);
                        aVal = endA - startA;
                        bVal = endB - startB;
                        break;
                }
                const comparison = aVal > bVal ? 1 : -1;
                return isAsc ? -comparison : comparison;
            });
            renderStreaksTable(pastStreaks);
        }
        
        /**
         * Displays the appropriate view and attaches listeners based on auth state.
         * @param {Object} user The Firebase user object or null.
         */
        let journalUnsubscribe;
        let streakUnsubscribe;
        let pastStreaksUnsubscribe;

        function updateUI(user) {
            currentUser = user;
            
            if (journalUnsubscribe && typeof journalUnsubscribe === 'function') journalUnsubscribe();
            if (streakUnsubscribe && typeof streakUnsubscribe === 'function') streakUnsubscribe();
            if (pastStreaksUnsubscribe && typeof pastStreaksUnsubscribe === 'function') pastStreaksUnsubscribe();
            
            removeAllListeners();

            if (user && user.email) {
                authForms.style.display = 'none';
                dashboardView.classList.add('active');
                
                addListener(setStartDateBtn, 'click', handleSetStartDate);
                addListener(setGoalDateBtn, 'click', handleSetGoalDate);
                addListener(recordFailureBtn, 'click', handleRecordFailure);
                addListener(addJournalBtn, 'click', handleAddJournalEntry);
                addListener(viewAllJournalsBtn, 'click', handleViewMoreJournals);
                addListener(addManualStreakBtn, 'click', handleAddManualStreak);
                addListener(logoutBtn, 'click', handleLogout);

                addListener(manualModalCloseBtn, 'click', () => {
                    manualStartDateInput.value = '';
                    manualEndDateInput.value = '';
                    manualReasonInput.value = '';
                    toggleModal(manualStreakModal, false);
                });
                addListener(manualCancelBtn, 'click', () => {
                    manualStartDateInput.value = '';
                    manualEndDateInput.value = '';
                    manualReasonInput.value = '';
                    toggleModal(manualStreakModal, false);
                });
                addListener(manualSubmitBtn, 'click', submitManualStreak);

                addListener(modalCloseBtn, 'click', () => {
                    failureReasonTextarea.value = '';
                    toggleModal(failureModal, false);
                });
                addListener(modalCancelBtn, 'click', () => {
                    failureReasonTextarea.value = '';
                    toggleModal(failureModal, false);
                });
                addListener(modalSubmitBtn, 'click', submitFailure);

                addListener(journalModalCloseBtn, 'click', () => toggleModal(journalEntryModal, false));
                addListener(journalModalCancelBtn, 'click', () => toggleModal(journalEntryModal, false));
                addListener(journalModalSaveBtn, 'click', handleSaveJournalEntry);
                addListener(journalModalDeleteBtn, 'click', handleDeleteJournalEntry);
                
                addListener(journalListEl, 'click', (e) => {
                    const entryDiv = e.target.closest('.journal-entry');
                    if (entryDiv) {
                        const entryId = entryDiv.dataset.entryId;
                        handleViewJournalEntry(entryId);
                    }
                });
                
                streaksTableHeaders.forEach(header => {
                    addListener(header, 'click', () => sortStreaksTable(header.dataset.sortBy));
                });
                
                addListener(streaksTableBody, 'click', (e) => {
                    if (e.target.classList.contains('view-reason-btn')) {
                        const reason = e.target.dataset.reason;
                    }
                });
                
                tabBtns.forEach(btn => {
                    addListener(btn, 'click', () => {
                        showTab(btn.dataset.tab + '-tab');
                    });
                });

                streakUnsubscribe = loadUserStreakInfo(user);
                journalUnsubscribe = loadJournalEntries(user);
                pastStreaksUnsubscribe = loadPastStreaks(user);
                
            } else {
                authForms.style.display = 'block';
                dashboardView.classList.remove('active');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                
                addListener(loginBtn, 'click', handleLogin);
                addListener(registerBtn, 'click', handleRegister);
                addListener(showLoginLink, 'click', toggleForms);
                addListener(showRegisterLink, 'click', toggleForms);
                
                if (streakInterval) clearInterval(streakInterval);
            }
        }
        

        /**
         * Initializes Firebase services and sets up the authentication listener.
         */
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    updateUI(user);
                });
            } catch (error) {
                console.error('Error during Firebase initialization:', error);
            }
        }

        window.onload = initializeFirebase;
    </script>
</body>
</html>
