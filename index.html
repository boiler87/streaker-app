<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaker</title>
    <!-- FAVICON LINK -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/rynwynk/streaker-app/main/logo%20only.png">
    <!-- GOOGLE FONTS LINK -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        @font-face {
            font-family: 'AppleIIe';
            src: url('https://daniellopes.com.br/apple-ii/AppleIIe.ttf') format('truetype');
        }

        body {
            font-family: 'AppleIIe', monospace;
            background-color: #000;
            color: #27ff47;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            background-color: #000;
            padding: 30px;
            border: 2px solid #27ff47;
            box-shadow: 0 0 10px #27ff47;
            max-width: 800px;
            width: 100%;
        }
        .hidden {
            display: none !important; /* The definitive fix */
        }
        
        .logo-and-title {
            display: flex;
            align-items: center;
            gap: 15px; /* Increased gap */
        }
        .logo-and-title div {
           display: flex;
           flex-direction: column;
        }
        .logo-and-title h2 {
            font-family: 'Press Start 2P', cursive;
            margin-bottom: 5px; /* Space between title and subtitle */
        }
        .subtitle {
            font-size: 0.8em;
            color: #27ff47;
            margin: 0;
        }

        h2 {
            color: #27ff47;
            text-align: left;
            margin: 0;
            font-size: 2em;
        }
        .logo {
            height: 60px; /* Adjusted height */
            width: auto;
            image-rendering: pixelated;
        }
        .header-container {
            margin-bottom: 20px;
        }
        form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        input[type="email"],
        input[type="password"],
        input[type="date"],
        input[type="number"],
        input[type="search"],
        input[type="text"] {
            padding: 12px;
            border: 2px solid #27ff47;
            background-color: #000;
            color: #27ff47;
            flex-grow: 1;
            font-size: 16px;
            font-family: 'AppleIIe', monospace;
        }
        textarea {
            padding: 12px;
            border: 2px solid #27ff47;
            background-color: #000;
            color: #27ff47;
            flex-basis: 100%;
            min-height: 80px;
            resize: vertical;
            font-family: 'AppleIIe', monospace;
            font-size: 16px;
        }
        button {
            padding: 12px 20px;
            border: 2px solid #27ff47;
            background-color: #27ff47;
            color: #000;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #1aff32;
        }
        button:disabled {
            background-color: #111;
            color: #444;
            border-color: #444;
            cursor: not-allowed;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }

        /* --- START LOGIN PAGE REDESIGN --- */
        #auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #auth-container .logo-and-title {
            justify-content: center;
            margin-bottom: 40px;
        }
        
        .terminal-window {
            width: 100%;
            max-width: 450px;
            border: 2px solid #27ff47;
            background-color: #080808;
            padding: 0;
            box-shadow: 0 0 15px rgba(39, 255, 71, 0.5);
        }

        .terminal-header {
            background-color: #27ff47;
            color: #000;
            padding: 5px 10px;
            font-weight: bold;
            text-align: center;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8em;
        }
        
        #auth-form {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }
        
        #auth-form .form-row {
             width: 100%;
        }

        #auth-form label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        #auth-form input {
            width: 100%;
        }
        
        #auth-form .button-group {
            width: 100%;
            justify-content: space-between;
        }

        #auth-form .button-group button {
            flex-grow: 1;
            flex-basis: 0;
        }
        
        .blinking-cursor {
            font-weight: bold;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            from, to { color: transparent; }
            50% { color: #27ff47; }
        }
        /* --- END LOGIN PAGE REDESIGN --- */


        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .error-message {
            color: #ff0000;
            text-align: center;
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #27ff47;
            margin-top: 20px;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border: 1px solid #27ff47;
        }
        th {
            background-color: #111;
            color: #27ff47;
            font-weight: 600;
            cursor: pointer;
        }
        th:hover {
            background-color: #333;
        }
        th .sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
        }
        tr:hover {
            background-color: #001;
        }
        .delete-btn {
            background-color: #ff0000;
            color: #000;
        }
        .delete-btn:hover {
            background-color: #cc0000;
        }
        
        .edit-btn {
            background-color: #27ff47;
            color: #000;
            font-size: 14px;
            padding: 8px 12px;
            margin-right: 5px;
        }
        .edit-btn:hover {
            background-color: #1aff32;
        }

        .save-btn {
            background-color: #27ff47;
            color: #000;
        }
        .save-btn:hover {
            background-color: #1aff32;
        }
        .cancel-btn {
            background-color: #ff0000;
            color: #000;
        }
        .cancel-btn:hover {
            background-color: #cc0000;
        }

        .end-streak-btn {
            background-color: #27ff47;
            color: #000;
            font-size: 14px;
            padding: 8px 12px;
        }
        .end-streak-btn:hover {
            background-color: #1aff32;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        #user-profile-display {
            word-break: break-all;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .username-change-section {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }
        #new-username-input {
            flex-grow: 1;
            font-size: 0.9em;
            padding: 8px;
        }
        #save-username-btn {
            padding: 8px 12px;
            font-size: 0.9em;
        }
        #username-status {
            flex-basis: 100%;
            text-align: left;
            margin: 5px 0 0 0;
            font-size: 0.8em;
        }

        #refresh-public-data-btn, .logout-btn {
            width: 100%;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .toggle-switch label {
            cursor: pointer;
            white-space: nowrap;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            width: 40px;
            height: 20px;
            background-color: #333;
            border: 1px solid #27ff47;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: #27ff47;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: #111;
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        #public-link-container {
            margin-top: 10px;
        }
        #public-link-display {
            width: 100%;
            padding: 5px;
            background: #111;
            border: 1px solid #27ff47;
            color: #27ff47;
            font-size: 0.8em;
            word-break: break-all;
        }
        

        .view-more-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .stats-section-header {
            margin-top: 40px;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .stat-card {
            background-color: #111;
            padding: 20px;
            border: 2px solid #27ff47;
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #27ff47;
            text-align: center;
        }
        
        .stat-card p {
            font-size: 2em;
            font-weight: bold;
            color: #27ff47;
        }

        .progress-bar-container {
            width: 100%;
            height: 20px;
            border: 1px solid #27ff47;
            background-color: #000;
            margin-top: 10px;
        }
        .progress-bar {
            height: 100%;
            background-color: #27ff47;
            transition: width 0.5s ease-in-out;
        }
        .progress-text {
            font-size: 1.5em;
            margin-top: 10px;
        }
        
        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-buttons button {
            background-color: #111;
            color: #27ff47;
            border: 2px solid #27ff47;
        }
        .tab-buttons button.active {
            background-color: #27ff47;
            color: #000;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
            text-align: center;
        }
        .badge-card {
            background-color: #111;
            padding: 20px;
            border: 2px solid #27ff47;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .badge-icon {
            font-size: 3em;
            color: #444;
            transition: color 0.5s ease;
        }
        .badge-icon.unlocked {
            color: #27ff47;
            text-shadow: 0 0 10px #27ff47;
        }
        .badge-name {
            margin-top: 10px;
            font-weight: bold;
        }

        .journal-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            border: 2px solid #27ff47;
            padding: 15px;
        }
        .journal-entry {
            background-color: #111;
            border: 2px solid #27ff47;
            padding: 20px;
            margin-bottom: 20px;
        }
        .journal-entry-date {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .journal-entry-text {
            white-space: pre-wrap;
            line-height: 1.5;
        }
        .journal-entry-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        #condensed-calendar-container, #public-condensed-calendar-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            border: 2px solid #27ff47;
            padding: 15px;
        }
        .month-grid-container {
            padding: 10px;
        }
        .month-grid-title {
            text-align: center;
            font-size: 1em;
            margin-bottom: 10px;
        }
        .month-grid-dow, .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }
        .month-grid-dow div {
            text-align: center;
            font-size: 0.7em;
        }
        .month-grid-day {
            width: 100%;
            padding-bottom: 100%;
            position: relative;
            background-color: #1a1a1a;
        }
        .month-grid-day.active {
            background-color: #27ff47;
        }
        .month-grid-day.end {
            background-color: #ff8c00;
        }
        .month-grid-day.end-and-start {
             background: linear-gradient(135deg, #ff8c00 49%, #27ff47 51%);
        }
        .month-grid-day.goal-day {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .month-grid-day.goal-day::after {
            content: 'ðŸŽ¯';
            font-size: 0.8em;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .year-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .year-nav h2 {
            margin: 0;
        }
        .year-nav button {
            padding: 5px 10px;
            font-size: 1.2em;
            line-height: 1;
        }

        .dashboard-top-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        #goal-progress-container.stat-card {
             padding: 15px;
        }

        .goal-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .goal-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .goal-inputs label {
            font-size: 0.9em;
        }
        .goal-inputs input {
            flex-grow: 1;
            min-width: 80px;
            padding: 8px;
        }
        .goal-inputs span {
            font-style: italic;
        }


        @media (max-width: 800px) {
             .three-month-view {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 700px) { 
            .dashboard-top-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
            }
            form {
                flex-direction: column;
            }
            .button-group {
                flex-direction: column;
            }
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #27ff47;
                margin-bottom: 15px;
            }
            td {
                border: none;
                border-bottom: 1px solid #27ff47;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            td:before {
                position: absolute;
                top: 0;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                content: attr(data-label);
                text-align: left;
                font-weight: bold;
                color: #27ff47;
            }
            td:last-child {
                border-bottom: 0;
            }
            .delete-btn {
                width: 100%;
                margin-top: 10px;
            }
            .start-date-cell:before { content: "Start Date"; }
            .end-date-cell:before { content: "End Date"; }
            .duration-cell:before { content: "Duration"; }
            .actions-cell:before { content: "Actions"; }

            .journal-controls {
                flex-direction: column;
            }
            .calendar-day {
                height: 40px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>

    <!-- NEW: Loading Screen -->
    <div id="loading-container" class="container" style="text-align: center; padding: 50px;">
        <p>LOADING STREAKER...</p>
    </div>
    
    <!-- NEW: Public View Container -->
    <div id="public-view-container" class="container hidden">
        <!-- Public, read-only content will be rendered here by JavaScript -->
    </div>


    <!-- Login/Signup Section -->
    <div id="auth-container" class="container hidden">
        <div class="logo-and-title" style="margin-bottom: 20px;">
            <img src="https://raw.githubusercontent.com/rynwynk/streaker-app/main/logo%20only.png" alt="Streaker Logo" class="logo">
            <div>
                <h2>Streaker</h2>
                <p class="subtitle">Satisfied Through Denial</p>
            </div>
        </div>
        <div class="terminal-window">
            <div class="terminal-header">USER AUTHENTICATION</div>
            <form id="auth-form">
                <div class="form-row hidden">
                    <label for="username-input">USERNAME:</label>
                    <input type="text" id="username-input" placeholder="ENTER USERNAME" autocomplete="username">
                </div>
                 <div class="form-row">
                    <label for="email-input">EMAIL:</label>
                    <input type="email" id="email-input" placeholder="ENTER EMAIL" required autocomplete="email">
                 </div>
                 <div class="form-row">
                    <label for="password-input">PASSWORD:</label>
                    <input type="password" id="password-input" placeholder="ENTER PASSWORD" required autocomplete="current-password">
                 </div>
                 <div style="width: 100%; text-align: left;">
                    > <span class="blinking-cursor">_</span>
                 </div>
                <div class="button-group">
                    <button type="submit" id="main-auth-btn">Log In</button>
                    <button type="button" id="toggle-auth-mode-btn">Sign Up</button>
                </div>
            </form>
        </div>
        <p id="auth-error" class="error-message"></p>
    </div>

    <!-- Main App Section -->
    <div id="main-app-container" class="container hidden">
        <div class="header">
            <div class="logo-and-title">
                <img src="https://raw.githubusercontent.com/rynwynk/streaker-app/main/logo%20only.png" alt="Streaker Logo" class="logo">
                <div>
                    <h2>Streaker</h2>
                    <p class="subtitle">Satisfied Through Denial</p>
                </div>
            </div>
        </div>

        <div class="tab-buttons">
            <button id="dashboard-tab-btn" class="active">Dashboard</button>
            <button id="logbook-tab-btn">Stats</button>
            <button id="achievements-tab-btn">Achievements</button>
            <button id="journal-tab-btn">Journal</button>
            <button id="about-tab-btn">About</button>
            <button id="profile-tab-btn">Profile</button>
        </div>

        <!-- Dashboard Container -->
        <div id="dashboard-container">
             <div class="dashboard-top-grid">
                <div class="stat-card">
                    <h3>Current Streak</h3>
                    <p id="current-streak-duration-stat">0d 0h 0m</p>
                </div>
                <div id="goal-progress-container" class="stat-card">
                    <h3>Goal Progress</h3>
                    <div id="progress-bar-container" class="progress-bar-container" style="margin-top: 15px;">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                    <p id="progress-text" class="progress-text" style="font-size: 1.2em; margin-top: 5px;">0%</p>
                    <p id="goal-date" style="font-size: 0.8em; margin-top: 5px; min-height: 1em;"></p>
                    <div class="goal-inputs">
                        <div class="goal-input-group">
                            <label for="goal-input">Days:</label>
                            <input type="number" id="goal-input" placeholder="e.g., 30">
                        </div>
                         <span>OR</span>
                        <div class="goal-input-group">
                             <label for="goal-date-input">Date:</label>
                             <input type="date" id="goal-date-input">
                        </div>
                    </div>
                     <button id="set-goal-btn" style="width: 100%; margin-top: 15px;">Set Goal</button>
                </div>
            </div>
            
            <h2 class="stats-section-header" style="text-align: left;">Log Book</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center;">
                <form id="entry-form" style="flex-grow: 1; margin-bottom: 0; display: flex; flex-wrap: wrap; gap: 10px;">
                    <input type="date" id="start-date-input" required style="flex-grow: 1;">
                    <input type="date" id="end-date-input" style="flex-grow: 1;">
                    <button type="submit">Add Entry</button>
                </form>
                <button id="export-btn" style="height: fit-content;">Export to CSV</button>
            </div>
            
            <table id="log-table">
                <thead>
                    <tr>
                        <th data-sort-key="startDate">Start Date <span class="sort-icon"></span></th>
                        <th data-sort-key="endDate">End Date <span class="sort-icon"></span></th>
                        <th data-sort-key="duration">Duration <span class="sort-icon"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div id="view-more-container" class="view-more-container hidden">
                <button id="view-more-btn">View More</button>
            </div>
        </div>

        <!-- Stats Container (formerly Logbook) -->
        <div id="logbook-container" class="hidden">
            <div id="stats-container">
                <h2 class="stats-section-header">All-Time Stats</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Days This Year</h3>
                        <p id="total-days-year-stat">0 days</p>
                    </div>
                    <div class="stat-card">
                        <h3>Longest Streak</h3>
                        <p id="longest-streak-stat">0 days</p>
                    </div>
                    <div class="stat-card">
                        <h3>Average Duration</h3>
                        <p id="avg-duration-stat">0d 0h</p>
                    </div>
                </div>
                <div class="stats-section-header year-nav">
                    <button id="prev-year-btn" title="Previous Year">&lt;</button>
                    <h2 style="margin: 0;">Year in Review (<span id="current-year-label"></span>)</h2>
                    <button id="next-year-btn" title="Next Year">&gt;</button>
                </div>
                <div id="condensed-calendar-container"></div>
                 <p style="text-align: center; font-size: 0.8em; margin-top: 15px;">
                    <span style="display: inline-block; width: 12px; height: 12px; background-color: #27ff47;"></span> Active
                    <span style="display: inline-block; width: 12px; height: 12px; background-color: #ff8c00; margin-left: 15px;"></span> Ended
                    <span style="display: inline-block; width: 12px; height: 12px; background: linear-gradient(135deg, #ff8c00 49%, #27ff47 51%); margin-left: 15px;"></span> Ended & Restarted
                     <span style="margin-left: 15px;">ðŸŽ¯ Goal</span>
                </p>
            </div>
        </div>

        <!-- Achievements Container -->
        <div id="achievements-container" class="hidden">
            <h2 class="stats-section-header">My Achievements</h2>
            <div id="my-achievements-grid" class="achievements-grid">
            </div>

            <h2 class="stats-section-header">Available Badges</h2>
            <div id="available-badges-grid" class="achievements-grid">
            </div>
        </div>

        <!-- Journal Container -->
        <div id="journal-container" class="hidden">
            <h2 class="stats-section-header" style="text-align: left;">Journal</h2>
            <form id="journal-form">
                <textarea id="journal-input" placeholder="Write your journal entry here..."></textarea>
                <button type="submit">Submit Entry</button>
            </form>

            <div class="journal-controls">
                <input type="search" id="journal-search-input" placeholder="Search entries...">
                <input type="date" id="journal-filter-start-date" title="Filter start date">
                <input type="date" id="journal-filter-end-date" title="Filter end date">
                <button id="journal-filter-clear-btn">Clear</button>
            </div>

            <div id="journal-entries-container">
            </div>
        </div>

        <!-- NEW: About Container -->
        <div id="about-container" class="hidden" style="line-height: 1.8;">
            <h2 class="stats-section-header" style="text-align: left;">About Streaker</h2>
            <p>
                Welcome to Streaker, your digital companion for building unbreakable habits. This app is built on a simple philosophy: consistency is the key to achieving any goal. The retro interface is designed to be simple and distraction-free, helping you focus on what truly matters: showing up every single day.
            </p>
            <p>
                As the motto says, "Satisfied Through Denial." The only time to act is now.
            </p>

            <h3 class="stats-section-header" style="text-align: left; margin-top: 30px;">How It Works</h3>
            
            <h4>The Dashboard</h4>
            <p>
                This is your command center. It gives you an at-a-glance view of your progress and motivation for the day.
            </p>
            <ul>
                <li><strong>Current Streak:</strong> The main stat shows you exactly how long you've been on your current run.</li>
                <li><strong>Goal Progress:</strong> Set a goal by either a number of days or a target date. The progress bar will show you how close you are to achieving it.</li>
            </ul>

            <h4>The Logbook</h4>
            <p>
                This is your official record. Here you can add, manage, and analyze your streaks.
            </p>
            <ul>
                <li><strong>Add an Entry:</strong> Select a start date and an optional end date to log a new streak. You can only have one active (no end date) streak at a time.</li>
                <li><strong>All-Time Stats:</strong> See your longest streak, average streak duration, and total days streaked this year.</li>
                <li><strong>Export to CSV:</strong> Download all your log data for your personal records.</li>
            </ul>

            <h4>Achievements</h4>
            <p>
                Earn badges as your current streak grows longer. This page shows you the badges you've earned on this run and which ones are coming up next. Your achievements reset when a streak ends, giving you a fresh goal for the next one.
            </p>
            
            <h4>The Journal</h4>
            <p>
                Track your thoughts, feelings, and progress. Write down your successes and your struggles. You can search your entries by keyword or filter them by date to find exactly what you're looking for.
            </p>

            <h3 class="stats-section-header" style="text-align: left; margin-top: 30px;">Troubleshooting</h3>
            <h4>Why isn't my "Average Duration" showing on my public profile?</h4>
            <p>
                Your public profile is a snapshot of your data. When new features like "Average Duration" are added, your existing public snapshot needs to be updated. To fix this, simply open your profile dropdown (the ðŸ‘¤ icon), make sure your profile is public, and click the "Refresh Public Data" button. This will sync all your latest stats.
            </p>
        </div>
        
        <!-- NEW: Profile Container -->
        <div id="profile-container" class="hidden">
            <h2 class="stats-section-header" style="text-align: left;">Profile Settings</h2>
            
            <div class="stat-card" style="margin-top: 20px;">
                <h3>Current User</h3>
                <p id="user-profile-display" style="font-size: 1em;"></p>
            </div>

            <div class="stat-card" style="margin-top: 20px;">
                <h3>Change Username</h3>
                <div class="username-change-section" style="margin-top: 10px;">
                    <input type="text" id="new-username-input" placeholder="New username">
                    <button id="save-username-btn">Save</button>
                    <p id="username-status" class="error-message" style="margin: 10px 0 0 0;"></p>
                </div>
            </div>

            <div class="stat-card" style="margin-top: 20px;">
                 <h3>Public Profile</h3>
                 <div class="sharing-section" style="border-top: none; padding: 0; margin-top: 10px;">
                    <div class="toggle-switch">
                        <label for="public-profile-toggle">Enable Public Profile</label>
                        <label class="slider-container">
                            <input type="checkbox" id="public-profile-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="public-link-container" class="hidden">
                        <input type="text" id="public-link-display" readonly>
                        <button id="refresh-public-data-btn" style="margin-top: 10px;">Refresh Public Data</button>
                    </div>
                </div>
            </div>

             <div class="stat-card" style="margin-top: 20px;">
                <h3>Account</h3>
                <button id="new-logout-btn" class="logout-btn" style="margin-top: 10px;">Log Out</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Journal Modal -->
    <div id="journal-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>


    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <script>
        // Your Firebase project's configuration object
        const firebaseConfig = {
          apiKey: "AIzaSyCxPG9RfxihL-Rfhu7fPSP95QDld6QMuik",
          authDomain: "streaker-1658d.firebaseapp.com",
          projectId: "streaker-1658d",
          storageBucket: "streaker-1658d.appspot.com",
          messagingSenderId: "12701860115",
          appId: "1:12701860115:web:0d4dcba33fd234df97dae6",
          measurementId: "G-XKE790N7ZL"
        };
        
        // This log is for debugging purposes.
        console.log("Firebase config:", firebaseConfig);

        // Initialize Firebase
        if (firebaseConfig.apiKey) {
            try {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully.");
            } catch (error)
                {
                console.error("Firebase initialization failed:", error.message);
                console.warn("This may be because you have not created a Firestore database for your project. Please follow the instructions in the Firebase console.");
            }
        } else {
            console.error("Firebase config is missing or invalid. Please ensure you have pasted your config correctly.");
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const authContainer = document.getElementById('auth-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const authForm = document.getElementById('auth-form');
        const toggleAuthModeBtn = document.getElementById('toggle-auth-mode-btn');
        const mainAuthBtn = document.getElementById('main-auth-btn');
        const usernameInput = document.getElementById('username-input');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');

        const newLogoutBtn = document.getElementById('new-logout-btn');
        const exportBtn = document.getElementById('export-btn');
        
        const dashboardTabBtn = document.getElementById('dashboard-tab-btn');
        const logbookTabBtn = document.getElementById('logbook-tab-btn');
        const achievementsTabBtn = document.getElementById('achievements-tab-btn');
        const journalTabBtn = document.getElementById('journal-tab-btn');
        const aboutTabBtn = document.getElementById('about-tab-btn');
        const profileTabBtn = document.getElementById('profile-tab-btn');

        const dashboardContainer = document.getElementById('dashboard-container');
        const logbookContainer = document.getElementById('logbook-container');
        const achievementsContainer = document.getElementById('achievements-container');
        const journalContainer = document.getElementById('journal-container');
        const aboutContainer = document.getElementById('about-container');
        const profileContainer = document.getElementById('profile-container');

        // Logbook elements
        const entryForm = document.getElementById('entry-form');
        const logTableBody = document.querySelector('#log-table tbody');
        const authError = document.getElementById('auth-error');
        const startDateInput = document.getElementById('start-date-input');
        const endDateInput = document.getElementById('end-date-input');
        const tableHeaders = document.querySelectorAll('#log-table th[data-sort-key]');
        const viewMoreBtn = document.getElementById('view-more-btn');
        const viewMoreContainer = document.getElementById('view-more-container');
        const longestStreakStat = document.getElementById('longest-streak-stat');
        const currentStreakDurationStat = document.getElementById('current-streak-duration-stat');
        const avgDurationStat = document.getElementById('avg-duration-stat');
        const totalDaysYearStat = document.getElementById('total-days-year-stat');
        
        // Goal elements
        const goalInput = document.getElementById('goal-input');
        const goalDateInput = document.getElementById('goal-date-input');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const goalDate = document.getElementById('goal-date');

        // Achievements elements
        const myAchievementsGrid = document.getElementById('my-achievements-grid');
        const availableBadgesGrid = document.getElementById('available-badges-grid');

        // Journal elements
        const journalForm = document.getElementById('journal-form');
        const journalInput = document.getElementById('journal-input');
        const journalEntriesContainer = document.getElementById('journal-entries-container');
        const journalSearchInput = document.getElementById('journal-search-input');
        const journalFilterStartDate = document.getElementById('journal-filter-start-date');
        const journalFilterEndDate = document.getElementById('journal-filter-end-date');
        const journalFilterClearBtn = document.getElementById('journal-filter-clear-btn');

        // NEW: Profile elements
        const userProfileDisplay = document.getElementById('user-profile-display');
        const publicProfileToggle = document.getElementById('public-profile-toggle');
        const publicLinkContainer = document.getElementById('public-link-container');
        const publicLinkDisplay = document.getElementById('public-link-display');
        const refreshPublicDataBtn = document.getElementById('refresh-public-data-btn');
        
        // NEW: Username change elements
        const newUsernameInput = document.getElementById('new-username-input');
        const saveUsernameBtn = document.getElementById('save-username-btn');
        const usernameStatus = document.getElementById('username-status');


        // NEW: Journal Modal elements
        const journalModal = document.getElementById('journal-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        
        // NEW: Chart, Loading, and Public View containers
        const loadingContainer = document.getElementById('loading-container');
        const publicViewContainer = document.getElementById('public-view-container');
        
        let isSignupMode = false;
        let durationIntervals = {};
        let userLogs = [];
        let allJournalEntries = []; // Holds all journal entries for client-side filtering
        let sortState = {
            key: 'startDate',
            direction: 'desc'
        };
        let visibleLogEntriesCount = 5;
        let ongoingStreakInterval = null;
        let currentEditingLogId = null;
        let displayedYear = new Date().getFullYear(); // For year-in-review calendar
        let userData = {}; // To store user doc data like username, last check-in
        let mainAppListenersAdded = false; // Flag to ensure listeners are only added once
        let isUpdatingGoal = false; // Flag to prevent goal input loops
        
        function parseDate(dateInput) {
            if (!dateInput) return null;
            if (dateInput && typeof dateInput.toDate === 'function') return dateInput.toDate();
            if (dateInput instanceof Date) return dateInput;
            if (typeof dateInput === 'number') {
                const dateFromNum = new Date(dateInput);
                return isNaN(dateFromNum.getTime()) ? null : dateFromNum;
            }
            const date = new Date(dateInput + "T00:00:00");
            return isNaN(date.getTime()) ? null : date;
        }

        // Helper function to format date
        function formatDate(dateInput) {
            const date = parseDate(dateInput);
            if (!date) return 'Invalid Date';

            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        function formatFullDate(date) {
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Function to calculate duration in minutes
        function calculateDurationInMinutes(startDate, endDate) {
            const start = parseDate(startDate);
            const end = parseDate(endDate) || new Date();

            if (!start || !end) {
                 console.error("Invalid date passed to calculateDurationInMinutes", { startDate, endDate });
                 return 0;
            }

            const diff = end - start;
            return Math.floor(diff / (1000 * 60));
        }

        // Function to calculate and format duration
        function calculateDuration(startDateInput, endDateInput) {
            const start = parseDate(startDateInput);
            const end = endDateInput !== null && endDateInput !== undefined ? parseDate(endDateInput) : new Date();

            if ((startDateInput !== null && startDateInput !== undefined && !start) || 
                (endDateInput !== null && endDateInput !== undefined && !end)) {
                console.error("Invalid date passed to calculateDuration", { startDateInput, endDateInput });
                return { totalMilliseconds: 0, formatted: "Invalid", days: 0, minutes: 0, hours: 0 };
            }
            
            if (!start) {
                return { totalMilliseconds: 0, formatted: "0d 0h 0m", days: 0, minutes: 0, hours: 0 };
            }

            const diff = end - start;
            
            if (isNaN(diff)) { 
                console.error("NaN detected in duration calculation", {start, end});
                return { totalMilliseconds: 0, formatted: "Invalid", days: 0, minutes: 0, hours: 0 };
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            return { totalMilliseconds: diff, formatted: `${days}d ${hours}h ${minutes}m`, days: days, minutes: minutes, hours: hours };
        }
        
        // --- START FIX ---
        // This new helper function is specifically for formatting a duration that is already calculated in milliseconds.
        // This avoids the bug where the main `calculateDuration` function was being misused and returning 0.
        function formatDurationFromMs(ms) {
            if (isNaN(ms) || ms < 0) {
                return { formatted: "0d 0h 0m", days: 0, hours: 0, minutes: 0 };
            }
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            return { formatted: `${days}d ${hours}h ${minutes}m`, days, hours, minutes };
        }
        // --- END FIX ---


        // Function to update live duration
        function updateLiveDuration(docId, startDate) {
            if (durationIntervals[docId]) {
                clearInterval(durationIntervals[docId]);
            }
            const durationCell = document.querySelector(`tr[data-id="${docId}"] .duration-cell`);
            if (durationCell) {
                durationIntervals[docId] = setInterval(() => {
                    durationCell.textContent = calculateDuration(startDate, null).formatted;
                }, 60000); // Update every minute
            }
        }
        
        // Function to calculate total days in a streak for the current year
        function calculateTotalDaysThisYear() {
            const currentYear = new Date().getFullYear();
            let totalDays = 0;

            userLogs.forEach(doc => {
                const log = doc.data();
                const startDate = parseDate(log.startDate);
                const endDate = parseDate(log.endDate) || new Date();

                if (!startDate) return;

                if (startDate.getFullYear() > currentYear && endDate.getFullYear() > currentYear) return;

                const startOfYear = new Date(currentYear, 0, 1);
                const endOfYear = new Date(currentYear, 11, 31, 23, 59, 59);

                const streakStart = startDate < startOfYear ? startOfYear : startDate;
                const streakEnd = endDate > endOfYear ? endOfYear : endDate;
                
                if (streakEnd > streakStart) {
                    const diffTime = Math.abs(streakEnd - streakStart);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    totalDays += diffDays;
                }
            });
            return totalDays;
        }

        // Function to update goal progress bar
        function updateGoalProgress(goal) {
            const currentStreak = userLogs.find(doc => !doc.data().endDate);
            const currentDays = currentStreak ? calculateDuration(currentStreak.data().startDate, null).days : 0;
            const goalDays = goal || 0;

            if (!goalDays || goalDays <= 0) {
                progressBar.style.width = '0%';
                progressText.textContent = `0%`;
                return;
            }

            const progressPercentage = Math.min((currentDays / goalDays) * 100, 100);
            progressBar.style.width = `${progressPercentage}%`;
            
            const remainingDays = Math.max(0, goalDays - currentDays);
            
            if (remainingDays > 0) {
                progressText.textContent = `${Math.round(progressPercentage)}% (${remainingDays} ${remainingDays === 1 ? 'day' : 'days'} remaining)`;
            } else {
                progressText.textContent = `${Math.round(progressPercentage)}% (Goal reached!)`;
            }
        }

        // Function to calculate and render stats
        function calculateStats() {
            let longestDurationMs = 0;
            let totalCompletedDurationMs = 0;
            let completedEntriesCount = 0;
            let ongoingEntry = null;

            userLogs.forEach(doc => {
                const log = doc.data();
                const duration = calculateDuration(log.startDate, log.endDate);
                if (log.endDate) {
                    totalCompletedDurationMs += duration.totalMilliseconds;
                    completedEntriesCount++;
                } else {
                    ongoingEntry = log;
                }
                
                if (duration.totalMilliseconds > longestDurationMs) {
                    longestDurationMs = duration.totalMilliseconds;
                }
            });

            // --- START FIX ---
            // The function now calls the new `formatDurationFromMs` helper to correctly format the pre-calculated milliseconds.
            // This prevents the stats from being incorrectly displayed as 0.
            const longestDuration = formatDurationFromMs(longestDurationMs);
            longestStreakStat.textContent = `${longestDuration.days} days`;
            
            if (completedEntriesCount > 0) {
                const avgMs = totalCompletedDurationMs / completedEntriesCount;
                const avgDuration = formatDurationFromMs(avgMs);
                avgDurationStat.textContent = `${avgDuration.days}d ${avgDuration.hours}h`;
            } else {
                avgDurationStat.textContent = "0d 0h";
            }
            // --- END FIX ---

            if (ongoingEntry) {
                if (ongoingStreakInterval) clearInterval(ongoingStreakInterval);
                const update = () => {
                    const currentDuration = calculateDuration(ongoingEntry.startDate, null);
                    currentStreakDurationStat.textContent = currentDuration.formatted;
                    const goalDays = parseInt(goalInput.value, 10);
                    if (!isNaN(goalDays)) {
                        updateGoalProgress(goalDays);
                    }
                };
                update();
                ongoingStreakInterval = setInterval(update, 60000);
            } else {
                if (ongoingStreakInterval) clearInterval(ongoingStreakInterval);
                currentStreakDurationStat.textContent = "0d 0h 0m";
                if(userData && userData.goal) {
                    updateGoalProgress(userData.goal);
                }
            }
            
            totalDaysYearStat.textContent = `${calculateTotalDaysThisYear()} days`;
            renderCondensedCalendar(displayedYear, userLogs, goalDateInput.value, '#condensed-calendar-container', '#current-year-label');
        }

        // Display log entries
        function renderLogs() {
            logTableBody.innerHTML = '';
            Object.values(durationIntervals).forEach(clearInterval);
            durationIntervals = {};
            
            const sortedLogs = userLogs.slice().sort((a, b) => {
                const aData = a.data();
                const bData = b.data();
                let aVal, bVal;

                if (sortState.key === 'duration') {
                    aVal = calculateDurationInMinutes(aData.startDate, aData.endDate);
                    bVal = calculateDurationInMinutes(bData.startDate, bData.endDate);
                } else {
                    aVal = aData[sortState.key] ? new Date(aData[sortState.key]).getTime() : 0;
                    bVal = bData[sortState.key] ? new Date(bData[sortState.key]).getTime() : 0;
                }
                
                if (isNaN(aVal)) aVal = 0;
                if (isNaN(bVal)) bVal = 0;

                if (sortState.direction === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });

            const visibleLogs = sortedLogs.slice(0, visibleLogEntriesCount);

            visibleLogs.forEach(doc => {
                const log = doc.data();
                const row = document.createElement('tr');
                row.dataset.id = doc.id;

                const startDateFormatted = formatDate(log.startDate);
                const endDateFormatted = log.endDate ? formatDate(log.endDate) : `<button class="end-streak-btn">End Streak</button>`;
                const duration = calculateDuration(log.startDate, log.endDate).formatted;
                
                if (doc.id === currentEditingLogId) {
                     row.innerHTML = `
                         <td class="start-date-cell" data-label="Start Date"><input type="date" value="${log.startDate || ''}" class="edit-input" /></td>
                         <td class="end-date-cell" data-label="End Date"><input type="date" value="${log.endDate || ''}" class="edit-input" /></td>
                         <td class="duration-cell" data-label="Duration">${duration}</td>
                         <td data-label="Actions" class="actions-cell">
                             <button class="save-btn">Save</button>
                             <button class="cancel-btn">Cancel</button>
                         </td>
                     `;
                } else {
                    row.innerHTML = `
                        <td class="start-date-cell" data-label="Start Date">${startDateFormatted}</td>
                        <td class="end-date-cell" data-label="End Date">${endDateFormatted}</td>
                        <td class="duration-cell" data-label="Duration">${duration}</td>
                        <td data-label="Actions" class="actions-cell">
                            <button class="edit-btn">Edit</button>
                            <button class="delete-btn">Delete</button>
                        </td>
                    `;
                }

                logTableBody.appendChild(row);

                if (!log.endDate) {
                    updateLiveDuration(doc.id, log.startDate);
                }
            });

            viewMoreContainer.classList.toggle('hidden', userLogs.length <= visibleLogEntriesCount);

            tableHeaders.forEach(header => {
                const icon = header.querySelector('.sort-icon');
                if (header.dataset.sortKey === sortState.key) {
                    icon.textContent = sortState.direction === 'asc' ? 'â–²' : 'â–¼';
                } else {
                    icon.textContent = '';
                }
            });
        }
        
        // Function to render achievements
        function renderAchievements() {
            myAchievementsGrid.innerHTML = '';
            availableBadgesGrid.innerHTML = '';
            
            const ongoingEntry = userLogs.find(doc => !doc.data().endDate);
            const currentStreakDays = ongoingEntry ? calculateDuration(ongoingEntry.data().startDate, null).days : 0;
            
            const achievements = [
                { name: "7-Day Streak", days: 7, icon: 'â­' },
                { name: "2-Week Streak", days: 14, icon: 'ðŸ“…' },
                { name: "30-Day Streak", days: 30, icon: 'ðŸ†' },
                { name: "90-Day Streak", days: 90, icon: 'ðŸ›¡ï¸' },
                { name: "100-Day Streak", days: 100, icon: 'ðŸ’¯' },
                { name: "One-Year Victor", days: 365, icon: 'ðŸ…' },
            ];

            achievements.forEach(achievement => {
                const unlocked = currentStreakDays >= achievement.days;
                const grid = unlocked ? myAchievementsGrid : availableBadgesGrid;
                const badge = document.createElement('div');
                badge.className = 'badge-card';
                badge.innerHTML = `
                    <div class="badge-icon ${unlocked ? 'unlocked' : ''}">${achievement.icon}</div>
                    <div class="badge-name">${achievement.name}</div>
                `;
                grid.appendChild(badge);
            });
            
            if (myAchievementsGrid.children.length === 0) {
                myAchievementsGrid.innerHTML = '<p style="font-style: italic; color: #aaa;">Keep going! You haven\'t earned any badges yet on this streak.</p>';
            }

            if (availableBadgesGrid.children.length === 0 && ongoingEntry) {
                 availableBadgesGrid.innerHTML = '<p style="font-style: italic; color: #aaa;">Congratulations! You have collected all available badges for this streak!</p>';
            }
        }
        
        function renderCondensedCalendar(year, allLogs, goalDateString, containerSelector, yearLabelSelector) {
            const container = document.querySelector(containerSelector);
            const yearLabel = document.querySelector(yearLabelSelector);
            if(!container || !yearLabel) return;
            
            container.innerHTML = '';
            yearLabel.textContent = year;

            const activeDays = new Set();
            const endDays = new Set();
            const startDays = new Set();

            allLogs.forEach(doc => {
                const log = doc.data ? doc.data() : doc;
                const logStart = parseDate(log.startDate);
                if (!logStart) return;

                const logEnd = parseDate(log.endDate) || new Date();
                
                if (logStart.getFullYear() === year) {
                    startDays.add(logStart.toISOString().split('T')[0]);
                }

                if (log.endDate && logEnd.getFullYear() === year) {
                     endDays.add(logEnd.toISOString().split('T')[0]);
                }

                for (let d = new Date(logStart); d <= logEnd; d.setDate(d.getDate() + 1)) {
                    if (d.getFullYear() === year) {
                        activeDays.add(d.toISOString().split('T')[0]);
                    }
                }
            });

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            for(let month = 0; month < 12; month++) {
                const monthContainer = document.createElement('div');
                monthContainer.className = 'month-grid-container';
                monthContainer.innerHTML = `
                    <h3 class="month-grid-title">${monthNames[month]}</h3>
                    <div class="month-grid-dow">
                        ${['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d => `<div>${d}</div>`).join('')}
                    </div>
                `;
                const monthGrid = document.createElement('div');
                monthGrid.className = 'month-grid';

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for(let i=0; i<firstDayOfMonth; i++) {
                    monthGrid.appendChild(document.createElement('div'));
                }

                for(let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'month-grid-day';
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    dayCell.title = dateString;

                    const isEndDay = endDays.has(dateString);
                    const isActiveDay = activeDays.has(dateString);
                    const isStartDay = startDays.has(dateString);

                    if (isEndDay && isStartDay) dayCell.classList.add('end-and-start');
                    else if (isEndDay) dayCell.classList.add('end');
                    else if (isActiveDay) dayCell.classList.add('active');
                    
                    if (dateString === goalDateString) dayCell.classList.add('goal-day');

                    monthGrid.appendChild(dayCell);
                }
                monthContainer.appendChild(monthGrid);
                container.appendChild(monthContainer);
            }
        }

        function applyAndRenderJournalFilters() {
            const searchTerm = journalSearchInput.value.toLowerCase();
            const startDate = journalFilterStartDate.value;
            const endDate = journalFilterEndDate.value;

            const filteredEntries = allJournalEntries.filter(doc => {
                const entry = doc.data();
                if (!entry.date || typeof entry.date.toDate !== 'function') return false;
                
                const entryDate = entry.date.toDate();
                const textMatch = (entry.text || '').toLowerCase().includes(searchTerm);
                const startDateMatch = !startDate || entryDate >= new Date(startDate);
                const endDateMatch = !endDate || entryDate <= new Date(new Date(endDate).setHours(23, 59, 59));
                
                return textMatch && startDateMatch && endDateMatch;
            });
            
            renderJournalEntries(filteredEntries);
        }

        function renderJournalEntries(journalDocs) {
            journalEntriesContainer.innerHTML = '';
            if (journalDocs.length === 0) {
                journalEntriesContainer.innerHTML = '<p style="text-align: center; margin-top: 20px;">No entries to display.</p>';
                return;
            }

            journalDocs.forEach(doc => {
                const entry = doc.data();
                const entryDiv = document.createElement('div');
                entryDiv.className = 'journal-entry';
                entryDiv.dataset.id = doc.id;

                entryDiv.innerHTML = `
                    <div class="journal-entry-date">${formatFullDate(entry.date.toDate())}</div>
                    <div class="journal-entry-content"><p class="journal-entry-text">${entry.text}</p></div>
                    <div class="journal-entry-actions">
                        <button class="edit-btn">Edit</button>
                        <button class="delete-btn">Delete</button>
                    </div>
                `;
                journalEntriesContainer.appendChild(entryDiv);
            });
        }
        
        function exportToCsv() {
            if (userLogs.length === 0) {
                alert("No data to export.");
                return;
            }

            const rows = userLogs.map(doc => {
                const log = doc.data();
                const duration = calculateDuration(log.startDate, log.endDate);
                return [log.startDate || '', log.endDate || '', duration.formatted];
            });

            let csvContent = "data:text/csv;charset=utf-8,Start Date,End Date,Duration\n" 
                + rows.map(e => e.join(",")).join("\n");

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "streaker_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function updatePublicData(user) {
            if (!user) {
                alert('Cannot update public data. You must be logged in.');
                return;
            }
            
            const userDoc = await db.collection('users').doc(user.uid).get();
            const currentData = userDoc.exists ? userDoc.data() : {};

            const logsSnapshot = await db.collection('users').doc(user.uid).collection('logs').get();
            const currentLogs = logsSnapshot.docs;
            
            const ongoingEntry = currentLogs.find(doc => doc.data() && !doc.data().endDate);
            const currentStreakStartDate = ongoingEntry ? ongoingEntry.data().startDate : null;
            const currentStreakDays = ongoingEntry ? calculateDuration(ongoingEntry.data().startDate, null).days : 0;

            let longestDurationMs = 0;
            let totalCompletedDurationMs = 0;
            let completedEntriesCount = 0;

            currentLogs.forEach(doc => {
                const log = doc.data();
                if(!log || !log.startDate) return;
                const duration = calculateDuration(log.startDate, log.endDate);
                if (duration.totalMilliseconds > longestDurationMs) {
                    longestDurationMs = duration.totalMilliseconds;
                }
                if (log.endDate) {
                    totalCompletedDurationMs += duration.totalMilliseconds;
                    completedEntriesCount++;
                }
            });
            const longestStreakDays = formatDurationFromMs(longestDurationMs).days;
            
            let avgDurationFormatted = "0d 0h";
            if (completedEntriesCount > 0) {
                const avgMs = totalCompletedDurationMs / completedEntriesCount;
                const avgDuration = formatDurationFromMs(avgMs);
                avgDurationFormatted = `${avgDuration.days}d ${avgDuration.hours}h`;
            }

            const publicLogs = currentLogs
                .filter(doc => doc.data() && doc.data().startDate)
                .map(doc => ({
                    startDate: doc.data().startDate,
                    endDate: doc.data().endDate || null
                }));

            const achievementsConfig = [
                { name: "7-Day Streak", days: 7, icon: 'â­' },
                { name: "2-Week Streak", days: 14, icon: 'ðŸ“…' },
                { name: "30-Day Streak", days: 30, icon: 'ðŸ†' },
                { name: "90-Day Streak", days: 90, icon: 'ðŸ›¡ï¸' },
                { name: "100-Day Streak", days: 100, icon: 'ðŸ’¯' },
                { name: "One-Year Victor", days: 365, icon: 'ðŸ…' },
            ];

            const unlockedAchievements = achievementsConfig
                .filter(achievement => currentStreakDays >= achievement.days)
                .map(({ name, icon }) => ({ name, icon }));


            const publicData = {
                displayName: currentData.username || user.email || 'Anonymous User',
                currentStreakStartDate,
                longestStreakDays,
                averageStreakDuration: avgDurationFormatted,
                goalDate: currentData.goalDate || null,
                logs: publicLogs,
                unlockedAchievements,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('publicProfiles').doc(user.uid).set(publicData);
                alert('Your public profile has been updated!');
            } catch (error) {
                console.error("Error updating public profile:", error);
                alert('Could not update public profile. Check console for errors.');
            }
        }
        
        async function handleUpdateUsername() {
            const user = auth.currentUser;
            if (!user) return;

            const newUsername = newUsernameInput.value.trim();
            usernameStatus.textContent = '';

            if (!newUsername) return;
            if (newUsername.length < 3 || newUsername.length > 15 || /\s/.test(newUsername)) {
                usernameStatus.textContent = "Must be 3-15 characters, no spaces.";
                return;
            }
            if (userData && userData.username && newUsername.toLowerCase() === userData.username.toLowerCase()) {
                return;
            }
            
            const newUsernameLower = newUsername.toLowerCase();
            const usernamesCollection = db.collection('usernames');
            const userRef = db.collection('users').doc(user.uid);

            try {
                await db.runTransaction(async (transaction) => {
                    const newUsernameRef = usernamesCollection.doc(newUsernameLower);
                    const newUsernameDoc = await transaction.get(newUsernameRef);

                    if (newUsernameDoc.exists) throw "This username is already taken.";
                    
                    if (userData.username) {
                        const oldUsernameRef = usernamesCollection.doc(userData.username.toLowerCase());
                        transaction.delete(oldUsernameRef);
                    }

                    transaction.set(newUsernameRef, { uid: user.uid });
                    transaction.update(userRef, { username: newUsername });
                });
                
                usernameStatus.style.color = '#27ff47';
                usernameStatus.textContent = "Username updated!";
                newUsernameInput.value = '';

            } catch (error) {
                console.error("Error updating username: ", error);
                usernameStatus.style.color = '#ff0000';
                usernameStatus.textContent = typeof error === 'string' ? error : "An error occurred.";
            } finally {
                 setTimeout(() => usernameStatus.textContent = '', 3000);
            }
        }


        function setAuthMode(isSignup) {
            isSignupMode = isSignup;
            authError.textContent = '';
            usernameInput.parentElement.classList.toggle('hidden', !isSignup);
            mainAuthBtn.textContent = isSignup ? 'Create Account' : 'Log In';
            toggleAuthModeBtn.textContent = isSignup ? 'Back to Log In' : 'Sign Up';
            passwordInput.setAttribute('autocomplete', isSignup ? 'new-password' : 'current-password');
        }
        
        toggleAuthModeBtn.addEventListener('click', () => setAuthMode(!isSignupMode));

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            const username = usernameInput.value.trim();
            authError.textContent = '';

            try {
                if (isSignupMode) {
                    if (!username || username.length < 3 || username.length > 15 || /\s/.test(username)) {
                        throw new Error("Username must be 3-15 characters with no spaces.");
                    }
                    const usernameDoc = await db.collection('usernames').doc(username.toLowerCase()).get();
                    if (usernameDoc.exists) throw new Error("This username is already taken.");

                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    const userRef = db.collection('users').doc(user.uid);
                    const usernameRef = db.collection('usernames').doc(username.toLowerCase());
                    
                    const batch = db.batch();
                    batch.set(userRef, { username, email: user.email, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    batch.set(usernameRef, { uid: user.uid });
                    await batch.commit();
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                authError.textContent = error.message;
            }
        });

        exportBtn.addEventListener('click', exportToCsv);
        
        function setActiveTab(activeTab) {
            const tabs = {
                dashboard: { btn: dashboardTabBtn, container: dashboardContainer },
                stats: { btn: logbookTabBtn, container: logbookContainer },
                achievements: { btn: achievementsTabBtn, container: achievementsContainer },
                journal: { btn: journalTabBtn, container: journalContainer },
                about: { btn: aboutTabBtn, container: aboutContainer },
                profile: { btn: profileTabBtn, container: profileContainer },
            };
            Object.values(tabs).forEach(t => {
                t.container.classList.add('hidden');
                t.btn.classList.remove('active');
            });
            if(tabs[activeTab]) {
                tabs[activeTab].container.classList.remove('hidden');
                tabs[activeTab].btn.classList.add('active');
                if(activeTab === 'achievements') renderAchievements();
            }
        }
        
        function addMainAppEventListeners() {
            if (mainAppListenersAdded) return;

            document.querySelector('.tab-buttons').addEventListener('click', (e) => {
                if(e.target.id === 'dashboard-tab-btn') setActiveTab('dashboard');
                else if(e.target.id === 'logbook-tab-btn') setActiveTab('stats');
                else if(e.target.id === 'achievements-tab-btn') setActiveTab('achievements');
                else if(e.target.id === 'journal-tab-btn') setActiveTab('journal');
                else if(e.target.id === 'about-tab-btn') setActiveTab('about');
                else if(e.target.id === 'profile-tab-btn') setActiveTab('profile');
            });
            
            newLogoutBtn.addEventListener('click', () => auth.signOut());

            publicProfileToggle.addEventListener('change', async (e) => {
                const isPublic = e.target.checked;
                const user = auth.currentUser;
                if (!user) return;
                try {
                    await db.collection('users').doc(user.uid).update({ isPublic });
                    publicLinkContainer.classList.toggle('hidden', !isPublic);
                } catch (error) {
                    console.error("Error updating public profile status:", error);
                }
            });
            
            refreshPublicDataBtn.addEventListener('click', () => updatePublicData(auth.currentUser));
            saveUsernameBtn.addEventListener('click', handleUpdateUsername);

            tableHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const key = header.dataset.sortKey;
                    if (sortState.key === key) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.key = key;
                        sortState.direction = 'desc';
                    }
                    renderLogs();
                });
            });

            viewMoreBtn.addEventListener('click', () => {
                visibleLogEntriesCount += 10;
                renderLogs();
            });
            
            goalInput.addEventListener('input', () => {
                if (isUpdatingGoal) return;
                isUpdatingGoal = true;

                const goalDays = parseInt(goalInput.value, 10);
                
                if (goalDays > 0) {
                    updateGoalProgress(goalDays); // Update progress bar
                    const currentStreak = userLogs.find(doc => !doc.data().endDate);
                    if (currentStreak) {
                        const projectedDate = new Date(currentStreak.data().startDate);
                        projectedDate.setDate(projectedDate.getDate() + goalDays);
                        const formattedDate = projectedDate.toISOString().split('T')[0];
                        
                        goalDateInput.value = formattedDate; 

                        goalDate.textContent = `Goal of ${goalDays} days reached on: ${formatDate(formattedDate)}`;
                        renderCondensedCalendar(displayedYear, userLogs, formattedDate, '#condensed-calendar-container', '#current-year-label');
                    } else {
                        goalDateInput.value = ''; // Clear date if no active streak
                        goalDate.textContent = 'Start a streak to see goal date.';
                        renderCondensedCalendar(displayedYear, userLogs, null, '#condensed-calendar-container', '#current-year-label');
                    }
                } else {
                    // Clear everything if input is invalid
                    goalDateInput.value = '';
                    updateGoalProgress(null);
                    goalDate.textContent = '';
                    renderCondensedCalendar(displayedYear, userLogs, null, '#condensed-calendar-container', '#current-year-label');
                }
                isUpdatingGoal = false;
            });

            goalDateInput.addEventListener('input', () => {
                if (isUpdatingGoal) return;
                isUpdatingGoal = true;

                const goalDateValue = goalDateInput.value;
                goalInput.value = ''; // Mutually exclusive

                if (goalDateValue) {
                    const currentStreak = userLogs.find(doc => !doc.data().endDate);
                    if (currentStreak) {
                        const startDate = new Date(currentStreak.data().startDate + "T00:00:00");
                        const targetDate = new Date(goalDateValue + "T00:00:00");
                        const totalGoalDays = Math.ceil((targetDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));

                        if (totalGoalDays > 0) {
                            goalInput.value = totalGoalDays; // Set the days input for consistency
                            updateGoalProgress(totalGoalDays);
                             goalDate.textContent = `Goal set for: ${formatDate(goalDateValue)}`;
                        } else {
                             updateGoalProgress(null);
                             goalDate.textContent = 'Date must be in the future.';
                        }
                    } else {
                        updateGoalProgress(null);
                        goalDate.textContent = 'Start a streak to set a goal date.';
                    }
                    renderCondensedCalendar(displayedYear, userLogs, goalDateValue, '#condensed-calendar-container', '#current-year-label');
                } else {
                    // Clear everything if input is invalid
                    updateGoalProgress(null);
                    goalDate.textContent = '';
                    renderCondensedCalendar(displayedYear, userLogs, null, '#condensed-calendar-container', '#current-year-label');
                }

                isUpdatingGoal = false;
            });
            
            document.getElementById('set-goal-btn').addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) return;
                
                const goalDays = goalInput.value ? parseInt(goalInput.value, 10) : null;
                const goalDateValue = goalDateInput.value || null;

                const goalData = {
                    goal: goalDays,
                    goalDate: goalDateValue
                };
                
                await db.collection('users').doc(user.uid).set(goalData, { merge: true });
            });

            document.getElementById('prev-year-btn').addEventListener('click', () => {
                displayedYear--;
                renderCondensedCalendar(displayedYear, userLogs, userData.goalDate, '#condensed-calendar-container', '#current-year-label');
            });
            document.getElementById('next-year-btn').addEventListener('click', () => {
                if (displayedYear < new Date().getFullYear()) {
                    displayedYear++;
                    renderCondensedCalendar(displayedYear, userLogs, userData.goalDate, '#condensed-calendar-container', '#current-year-label');
                }
            });
            
            journalSearchInput.addEventListener('input', applyAndRenderJournalFilters);
            journalFilterStartDate.addEventListener('change', applyAndRenderJournalFilters);
            journalFilterEndDate.addEventListener('change', applyAndRenderJournalFilters);
            journalFilterClearBtn.addEventListener('click', () => {
                journalSearchInput.value = '';
                journalFilterStartDate.value = '';
                journalFilterEndDate.value = '';
                applyAndRenderJournalFilters();
            });

            entryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const user = auth.currentUser;
                
                const hasOngoing = userLogs.some(doc => !doc.data().endDate);
                if (hasOngoing && !endDate) {
                    alert("You can only have one ongoing streak at a time.");
                    return;
                }
                if (endDate && startDate > endDate) {
                    alert("End date cannot be before start date.");
                    return;
                }

                if (user && startDate) {
                    await db.collection('users').doc(user.uid).collection('logs').add({ startDate, endDate: endDate || null });
                    entryForm.reset();
                }
            });

            journalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = journalInput.value.trim();
                const user = auth.currentUser;

                if (user && text) {
                    await db.collection('users').doc(user.uid).collection('journal').add({
                        text,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    journalInput.value = '';
                }
            });
            
            logTableBody.addEventListener('click', async (e) => {
                const user = auth.currentUser;
                if (!user) return;
                const row = e.target.closest('tr');
                if (!row) return;
                const docId = row.dataset.id;
                const logRef = db.collection('users').doc(user.uid).collection('logs').doc(docId);

                if (e.target.classList.contains('delete-btn')) {
                    if (confirm('Are you sure you want to delete this entry?')) {
                       await logRef.delete();
                    }
                } else if (e.target.classList.contains('edit-btn')) {
                    currentEditingLogId = docId;
                    renderLogs();
                } else if (e.target.classList.contains('save-btn')) {
                    const newStartDate = row.querySelector('.start-date-cell input').value;
                    const newEndDate = row.querySelector('.end-date-cell input').value;
                    if (newEndDate && newStartDate > newEndDate) {
                        alert("End date cannot be before start date.");
                        return;
                    }
                    await logRef.update({ startDate: newStartDate, endDate: newEndDate || null });
                    currentEditingLogId = null;
                } else if (e.target.classList.contains('cancel-btn')) {
                    currentEditingLogId = null;
                    renderLogs();
                } else if (e.target.classList.contains('end-streak-btn')) {
                    const currentDate = new Date().toISOString().split('T')[0];
                    await logRef.update({ endDate: currentDate });
                }
            });

            journalEntriesContainer.addEventListener('click', async (e) => {
                const user = auth.currentUser;
                if (!user) return;
                const entryDiv = e.target.closest('.journal-entry');
                if (!entryDiv) return;
                const docId = entryDiv.dataset.id;
                const entryRef = db.collection('users').doc(user.uid).collection('journal').doc(docId);
                
                if (e.target.classList.contains('delete-btn')) {
                    if(confirm('Delete this journal entry?')) await entryRef.delete();
                } else if (e.target.classList.contains('edit-btn')) {
                    const contentDiv = entryDiv.querySelector('.journal-entry-content');
                    const currentText = contentDiv.querySelector('p').textContent;
                    contentDiv.innerHTML = `<textarea class="journal-edit-area">${currentText}</textarea><button class="save-btn">Save</button>`;
                } else if (e.target.classList.contains('save-btn')) {
                    const newText = entryDiv.querySelector('.journal-edit-area').value.trim();
                    if (newText) await entryRef.update({ text: newText });
                }
            });
            
            mainAppListenersAdded = true;
        }


        function initializeAppForUser(user) {
            authContainer.classList.add('hidden');
            mainAppContainer.classList.remove('hidden');
            addMainAppEventListeners();

            const logsCollection = db.collection('users').doc(user.uid).collection('logs');
            const journalCollection = db.collection('users').doc(user.uid).collection('journal');
            const userDocRef = db.collection('users').doc(user.uid);

            logsCollection.orderBy('startDate', 'desc').onSnapshot(snapshot => {
                userLogs = snapshot.docs.filter(doc => doc.data().startDate);
                renderLogs();
                calculateStats();
                renderAchievements();
            });
            
            journalCollection.orderBy('date', 'desc').onSnapshot(snapshot => {
                allJournalEntries = snapshot.docs;
                applyAndRenderJournalFilters(); 
            });

            userDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    userData = doc.data();
                    userProfileDisplay.textContent = userData.username || user.email;
                    
                    const isPublic = !!userData.isPublic;
                    publicProfileToggle.checked = isPublic;
                    publicLinkContainer.classList.toggle('hidden', !isPublic);
                    if(isPublic) {
                        publicLinkDisplay.value = `${window.location.origin}${window.location.pathname}?user=${user.uid}`;
                    }

                    if (!isUpdatingGoal) {
                        goalInput.value = userData.goal || '';
                        goalDateInput.value = userData.goalDate || '';
                        
                        if (userData.goal) {
                            updateGoalProgress(userData.goal);
                            const currentStreak = userLogs.find(doc => !doc.data().endDate);
                            if (currentStreak) {
                                const projectedDate = new Date(currentStreak.data().startDate);
                                projectedDate.setDate(projectedDate.getDate() + userData.goal);
                                const formattedDate = projectedDate.toISOString().split('T')[0];
                                goalDate.textContent = `Goal of ${userData.goal} days reached on: ${formatDate(formattedDate)}`;
                                renderCondensedCalendar(displayedYear, userLogs, formattedDate, '#condensed-calendar-container', '#current-year-label');
                            } else { 
                                goalDate.textContent = 'Start a streak to see goal date.';
                                renderCondensedCalendar(displayedYear, userLogs, null, '#condensed-calendar-container', '#current-year-label');
                            } 
                        } else if (userData.goalDate) {
                            const currentStreak = userLogs.find(doc => !doc.data().endDate);
                            if(currentStreak){
                                const startDate = new Date(currentStreak.data().startDate + "T00:00:00");
                                const targetDate = new Date(userData.goalDate + "T00:00:00");
                                const totalGoalDays = Math.ceil((targetDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));
                                if (totalGoalDays > 0) {
                                    updateGoalProgress(totalGoalDays);
                                }
                            }
                            goalDate.textContent = `Goal set for: ${formatDate(userData.goalDate)}`;
                            renderCondensedCalendar(displayedYear, userLogs, userData.goalDate, '#condensed-calendar-container', '#current-year-label');
                        } else {
                            updateGoalProgress(null);
                            goalDate.textContent = '';
                            renderCondensedCalendar(displayedYear, userLogs, null, '#condensed-calendar-container', '#current-year-label');
                        }
                    }
                }
            });
            
            setActiveTab('dashboard');
        }

        function showLoginScreen() {
            [mainAppContainer, publicViewContainer].forEach(c => c.classList.add('hidden'));
            authContainer.classList.remove('hidden');
            setAuthMode(false);
        }

        function renderPublicView(data, year) {
            const currentStreakHTML = calculateDuration(data.currentStreakStartDate, null).formatted;

            const achievementsHTML = data.unlockedAchievements && data.unlockedAchievements.length > 0
                ? data.unlockedAchievements.map(ach => `
                    <div class="badge-card">
                        <div class="badge-icon unlocked">${ach.icon}</div>
                        <div class="badge-name">${ach.name}</div>
                    </div>`).join('')
                : '<p style="text-align:center; font-style: italic; color: #aaa; grid-column: 1 / -1;">No achievements on current streak.</p>';
            
            publicViewContainer.innerHTML = `
                <div class="header">
                    <div class="logo-and-title">
                        <img src="https://raw.githubusercontent.com/rynwynk/streaker-app/main/logo%20only.png" alt="Streaker Logo" class="logo">
                        <div><h2>Streaker</h2><p class="subtitle">Satisfied Through Denial</p></div>
                    </div>
                </div>
                <h2 class="stats-section-header" style="margin-top:0;">Public Profile for ${data.displayName}</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>Current Streak</h3><p id="public-current-streak">${currentStreakHTML}</p></div>
                    <div class="stat-card"><h3>Longest Streak</h3><p>${data.longestStreakDays} days</p></div>
                    <div class="stat-card"><h3>Average Streak</h3><p>${data.averageStreakDuration || '0d 0h'}</p></div>
                </div>
                <h2 class="stats-section-header">Achievements</h2>
                <div class="achievements-grid">${achievementsHTML}</div>
                
                <div class="stats-section-header year-nav">
                    <button id="public-prev-year-btn" title="Previous Year">&lt;</button>
                    <h2 style="margin: 0;">Year in Review (<span id="public-year-label"></span>)</h2>
                    <button id="public-next-year-btn" title="Next Year">&gt;</button>
                </div>
                <div id="public-condensed-calendar-container"></div>
                 <p style="text-align: center; font-size: 0.8em; margin-top: 15px;">
                    <span style="display: inline-block; width: 12px; height: 12px; background-color: #27ff47;"></span> Active
                    <span style="display: inline-block; width: 12px; height: 12px; background-color: #ff8c00; margin-left: 15px;"></span> Ended
                    <span style="display: inline-block; width: 12px; height: 12px; background: linear-gradient(135deg, #ff8c00 49%, #27ff47 51%); margin-left: 15px;"></span> Ended & Restarted
                     <span style="margin-left: 15px;">ðŸŽ¯ Goal</span>
                </p>
                `;

            renderCondensedCalendar(year, data.logs, data.goalDate, '#public-condensed-calendar-container', '#public-year-label');
            
            const publicPrevBtn = document.getElementById('public-prev-year-btn');
            const publicNextBtn = document.getElementById('public-next-year-btn');
            
            publicNextBtn.disabled = year >= new Date().getFullYear();
            
            const urlParams = new URLSearchParams(window.location.search);
            const publicUserId = urlParams.get('user');

            publicPrevBtn.addEventListener('click', () => {
                window.location.search = `?user=${publicUserId}&year=${year - 1}`;
            });
            publicNextBtn.addEventListener('click', () => {
                window.location.search = `?user=${publicUserId}&year=${year + 1}`;
            });

            if (data.currentStreakStartDate) {
                setInterval(() => {
                    const el = document.getElementById('public-current-streak');
                    if(el) el.textContent = calculateDuration(data.currentStreakStartDate, null).formatted;
                }, 60000);
            }
        }


        async function startApp() {
            const urlParams = new URLSearchParams(window.location.search);
            const publicUserId = urlParams.get('user');
            const publicYear = parseInt(urlParams.get('year'), 10) || new Date().getFullYear();
            
            auth.onAuthStateChanged(async user => {
                loadingContainer.classList.add('hidden');
                if (publicUserId) {
                    publicViewContainer.classList.remove('hidden');
                    try {
                        const doc = await db.collection('publicProfiles').doc(publicUserId).get();
                        if (doc.exists) {
                            renderPublicView(doc.data(), publicYear);
                        } else {
                            publicViewContainer.innerHTML = '<p style="text-align:center;">This public profile does not exist or has been disabled.</p>';
                        }
                    } catch (error) {
                        console.error("Error loading public profile:", error);
                        publicViewContainer.innerHTML = '<p style="text-align:center;">Could not load public profile.</p>';
                    }
                } else if (user) {
                    initializeAppForUser(user);
                } else {
                    showLoginScreen();
                }
            });
        }
        
        startApp();
    </script>
</body>
</html>

