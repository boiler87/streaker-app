<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaker</title>
    <!-- Use Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Google Fonts for the heading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Shade&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Apply the Inter font as the default for the body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* Apply the new Bungee Shade font to the heading */
        .streaker-heading {
            font-family: 'Bungee Shade', cursive;
        }

        /* Styling for the modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Basic styling for the progress bar container */
        .progress-bar-container {
            background-color: #e5e7eb;
        }

        /* Styling for the progress bar itself */
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
            background-color: #10b981; /* Green color for progress */
        }
        
        /* Custom scrollbar for better UX */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Styling for the draggable cards */
        .card {
            cursor: grab;
            user-select: none;
        }
        .card:active {
            cursor: grabbing;
        }

        /* Hide scrollbar on body when modal is open */
        body.modal-open {
            overflow: hidden;
        }

        /* Custom tab styles to create the integrated look */
        .tab-link {
            padding: 0.75rem 1rem;
            font-weight: 500;
            cursor: pointer;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            margin-bottom: -2px; /* Pulls the tab up to cover the border */
        }
        .tab-link.active {
            color: #1f2937;
            background-color: #f3f4f6;
            border-bottom: 2px solid transparent; /* Hide the bottom border to blend with the page */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Header with app title and logo -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-50">
        <div class="container mx-auto flex items-center">
            <img src="https://github.com/rynwynk/streaker-app/blob/main/logo%20only.png?raw=true" alt="Streaker App Logo" class="h-10 w-auto mr-4">
            <h1 class="text-3xl font-bold text-gray-800 streaker-heading h-10 flex items-center">Streaker</h1>
        </div>
    </header>

    <!-- Navigation Tabs below the header with added vertical space -->
    <div class="bg-white sticky top-16 z-40 mt-2">
        <nav class="container mx-auto flex space-x-8 px-4 border-b border-gray-200">
            <a href="#home" id="home-tab" class="tab-link active">Home</a>
            <a href="#stats" id="stats-tab" class="tab-link bg-white">Stats</a>
            <a href="#journal" id="journal-tab" class="tab-link bg-white">Journal</a>
        </nav>
    </div>

    <main class="flex-grow container mx-auto p-4 md:p-8">
        <!-- Home Page Section -->
        <section id="home-page" class="space-y-6">
            <p class="text-gray-600 mb-4">You can drag and drop these cards to reorganize your dashboard, or hide them by clicking the 'x' in the top right corner.</p>
            
            <!-- Restore All Cards button moved to the top -->
            <div class="flex justify-center mb-6">
                <button id="restore-cards-btn" class="hidden bg-gray-600 text-white px-6 py-3 rounded-lg text-lg font-bold shadow-md hover:bg-gray-700 transition duration-300">Restore All Cards</button>
            </div>
            
            <!-- Cards Container for Drag and Drop -->
            <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Card components will be dynamically rendered here by JavaScript -->
            </div>
        </section>

        <!-- Stats Page Section -->
        <section id="stats-page" class="hidden space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">Streak History</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                <table id="stats-table" class="w-full text-left table-auto border-collapse">
                    <thead>
                        <tr class="bg-gray-100 border-b border-gray-200">
                            <th class="p-4 text-sm font-semibold text-gray-600 cursor-pointer hover:bg-gray-200 transition duration-300 rounded-tl-xl" data-sort="startDate">Start Date</th>
                            <th class="p-4 text-sm font-semibold text-gray-600 cursor-pointer hover:bg-gray-200 transition duration-300" data-sort="endDate">End Date</th>
                            <th class="p-4 text-sm font-semibold text-gray-600 cursor-pointer hover:bg-gray-200 transition duration-300" data-sort="duration">Duration (Days)</th>
                            <th class="p-4 text-sm font-semibold text-gray-600 rounded-tr-xl">Reason</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table-body" class="divide-y divide-gray-200">
                        <!-- Table rows will be dynamically rendered here by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Manual Add Streak button -->
            <div class="flex justify-center mt-8">
                <button id="add-streak-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg text-lg font-bold shadow-md hover:bg-blue-700 transition duration-300">Add Streak Manually</button>
            </div>
        </section>

        <!-- Journal Page Section -->
        <section id="journal-page" class="hidden space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-6">Journal Entries</h2>

            <!-- Journal Controls (Filters, Search) -->
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <input type="text" id="journal-search" placeholder="Search entries..." class="flex-grow p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="journal-month-filter" class="p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Filter by Month</option>
                </select>
            </div>
            
            <!-- Journal Entry Form -->
            <div class="bg-white p-6 rounded-xl shadow-lg mt-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Add New Entry</h3>
                <input type="text" id="journal-title" placeholder="Title" class="w-full p-3 mb-4 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <textarea id="journal-body" placeholder="Write your thoughts here..." class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="8" maxlength="1000"></textarea>
                <div class="flex justify-end space-x-4 mt-4">
                    <button id="journal-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition duration-300">Cancel</button>
                    <button id="journal-submit-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition duration-300">Submit</button>
                </div>
            </div>

            <!-- Journal Posts Container -->
            <div id="journal-posts-container" class="space-y-4 mt-6">
                <!-- Journal posts will be dynamically rendered here -->
            </div>

            <div class="flex justify-center mt-6">
                <button id="journal-view-more-btn" class="hidden bg-gray-600 text-white px-6 py-3 rounded-lg text-lg font-bold shadow-md hover:bg-gray-700 transition duration-300">View More</button>
            </div>
        </section>

    </main>

    <!-- Modal for Record Failure -->
    <div id="failure-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 z-50 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg space-y-4">
            <h3 class="text-xl font-bold text-gray-800">Record a Failure</h3>
            <p class="text-gray-600">Please enter a reason for the streak's end:</p>
            <textarea id="failure-reason" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="e.g., 'Got sick and couldn't keep going'"></textarea>
            <div class="flex justify-end space-x-4 mt-4">
                <button id="cancel-failure-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition duration-300">Cancel</button>
                <button id="submit-failure-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition duration-300">Submit</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Manual Add Streak -->
    <div id="manual-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 z-50 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg space-y-4">
            <h3 class="text-xl font-bold text-gray-800">Add Past Streak</h3>
            <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">Start Date:</label>
                <input type="date" id="manual-start-date" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <label class="block text-sm font-medium text-gray-700">End Date:</label>
                <input type="date" id="manual-end-date" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <label class="block text-sm font-medium text-gray-700">Reason:</label>
                <textarea id="manual-reason" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="e.g., 'Completed challenge'"></textarea>
            </div>
            <div class="flex justify-end space-x-4 mt-4">
                <button id="cancel-manual-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition duration-300">Cancel</button>
                <button id="submit-manual-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg text-lg font-bold shadow-md hover:bg-blue-700 transition duration-300">Submit</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Viewing Streak Reason -->
    <div id="reason-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 z-50 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg space-y-4">
            <h3 class="text-xl font-bold text-gray-800">Reason for Failure</h3>
            <p id="reason-text" class="text-gray-600 whitespace-pre-wrap"></p>
            <div class="flex justify-end mt-4">
                <button id="close-reason-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition duration-300">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Viewing/Editing Journal Entry -->
    <div id="journal-view-modal" class="hidden fixed inset-0 flex items-center justify-center p-4 z-50 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg space-y-4 max-h-screen overflow-y-auto">
            <h3 id="journal-view-title" class="text-xl font-bold text-gray-800"></h3>
            <p id="journal-view-body" class="text-gray-600 whitespace-pre-wrap"></p>
            <div class="flex justify-end space-x-4 mt-4">
                <button id="journal-edit-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition duration-300">Edit</button>
                <button id="journal-close-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 transition duration-300">Close</button>
            </div>
        </div>
    </div>


    <script>
        // --- Drag and Drop Functions ---
        let draggedItem = null;
        let cardsContainer = null;

        function handleDragOver(e) {
            e.preventDefault();
            const afterElement = getDragAfterElement(cardsContainer, e.clientY);
            const currentDragged = draggedItem;
            if (afterElement == null) {
                cardsContainer.appendChild(currentDragged);
            } else {
                cardsContainer.insertBefore(currentDragged, afterElement);
            }
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.card:not(.hidden)')].filter(card => card.id !== draggedItem.id);
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // Function to show/hide the restore button based on the number of hidden cards
        function toggleRestoreButtonVisibility() {
            const hiddenCards = document.querySelectorAll('.card.hidden');
            const restoreButton = document.getElementById('restore-cards-btn');
            if (hiddenCards.length > 0) {
                restoreButton.classList.remove('hidden');
            } else {
                restoreButton.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Element References ---
            const homePage = document.getElementById('home-page');
            const statsPage = document.getElementById('stats-page');
            const journalPage = document.getElementById('journal-page');
            const homeTab = document.getElementById('home-tab');
            const statsTab = document.getElementById('stats-tab');
            const journalTab = document.getElementById('journal-tab');
            cardsContainer = document.getElementById('cards-container');
            const recordFailureBtn = document.getElementById('record-failure-btn');
            const restoreCardsBtn = document.getElementById('restore-cards-btn');
            const failureModal = document.getElementById('failure-modal');
            const failureReasonInput = document.getElementById('failure-reason');
            const submitFailureBtn = document.getElementById('submit-failure-btn');
            const cancelFailureBtn = document.getElementById('cancel-failure-btn');
            const statsTableBody = document.getElementById('stats-table-body');
            const statsTable = document.getElementById('stats-table');
            const reasonModal = document.getElementById('reason-modal');
            const reasonText = document.getElementById('reason-text');
            const closeReasonBtn = document.getElementById('close-reason-btn');
            const addStreakBtn = document.getElementById('add-streak-btn');
            const manualModal = document.getElementById('manual-modal');
            const manualStartDateInput = document.getElementById('manual-start-date');
            const manualEndDateInput = document.getElementById('manual-end-date');
            const manualReasonInput = document.getElementById('manual-reason');
            const submitManualBtn = document.getElementById('submit-manual-btn');
            const cancelManualBtn = document.getElementById('cancel-manual-btn');
            const journalTitleInput = document.getElementById('journal-title');
            const journalBodyInput = document.getElementById('journal-body');
            const journalSubmitBtn = document.getElementById('journal-submit-btn');
            const journalCancelBtn = document.getElementById('journal-cancel-btn');
            const journalPostsContainer = document.getElementById('journal-posts-container');
            const journalViewMoreBtn = document.getElementById('journal-view-more-btn');
            const journalViewModal = document.getElementById('journal-view-modal');
            const journalViewTitle = document.getElementById('journal-view-title');
            const journalViewBody = document.getElementById('journal-view-body');
            const journalEditBtn = document.getElementById('journal-edit-btn');
            const journalCloseBtn = document.getElementById('journal-close-btn');
            const journalMonthFilter = document.getElementById('journal-month-filter');
            const journalSearchInput = document.getElementById('journal-search');


            // --- App State ---
            let startDate = null;
            let goalDate = null;
            let streaksData = [];
            let journalEntries = [];
            let currentSortColumn = null;
            let sortDirection = 'asc';
            let postsToShow = 5;
            let editingEntryId = null;
            
            // Helper function to format date string to "Month Day, Year"
            function formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString + 'T00:00:00'); // Add time to prevent timezone issues
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }

            // --- Date and Time Utilities ---
            function getDaysElapsed(start, end) {
                if (!start || !end) return 0;
                const oneDay = 1000 * 60 * 60 * 24;
                const diffTime = Math.abs(new Date(end) - new Date(start));
                const diffDays = Math.ceil(diffTime / oneDay);
                return diffDays;
            }

            function getDaysThisYear() {
                if (!startDate) return 0;
                const now = new Date();
                const start = new Date(startDate);
                const startOfYear = new Date(now.getFullYear(), 0, 1); // January 1st of the current year

                // If the streak started before this year, the counter for this year starts from Jan 1st
                const effectiveStart = start < startOfYear ? startOfYear : start;
                
                // If the streak started in the future, return 0
                if (effectiveStart > now) return 0;

                const oneDay = 1000 * 60 * 60 * 24;
                const diffTime = Math.abs(now - effectiveStart);
                const diffDays = Math.floor(diffTime / oneDay); // Use floor for a whole number of full days
                return diffDays;
            }

            // --- Card Data and Rendering ---
            const cards = [
                {
                    id: 'counter',
                    title: 'Current Streak',
                    content: `
                        <p id="counter-display" class="text-4xl font-extrabold text-gray-800">00:00:00</p>
                        <p class="text-sm font-medium text-gray-500 mt-2">Days, hours, and minutes elapsed</p>
                    `
                },
                {
                    id: 'start-date',
                    title: 'Start Date',
                    content: `
                        <span id="start-date-display" class="text-lg font-medium text-gray-800"></span>
                        <input type="date" id="start-date-input" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm mt-2 hidden">
                        <div class="flex justify-center mt-2">
                            <button id="edit-start-date-btn" class="text-sm font-medium text-blue-500 hover:text-blue-700 transition duration-300">Edit</button>
                        </div>
                    `
                },
                {
                    id: 'goal-date',
                    title: 'Goal Date',
                    content: `
                        <span id="goal-date-display" class="text-lg font-medium text-gray-800"></span>
                        <input type="date" id="goal-date-input" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm mt-2 hidden">
                        <div class="flex justify-center mt-2">
                            <button id="edit-goal-date-btn" class="text-sm font-medium text-blue-500 hover:text-blue-700 transition duration-300">Edit</button>
                        </div>
                    `
                },
                {
                    id: 'progress',
                    title: 'Progress to Goal',
                    content: `
                        <div class="progress-bar-container w-full h-8 rounded-full overflow-hidden">
                            <div id="progress-bar-fill" class="progress-bar-fill h-full rounded-full" style="width: 0%;"></div>
                        </div>
                        <p id="progress-text" class="text-sm text-gray-500 mt-2 text-center font-medium">0% complete</p>
                    `
                },
                {
                    id: 'total-days-this-year',
                    title: 'Total Days This Year',
                    content: `
                        <p id="total-days-this-year-display" class="text-6xl font-extrabold text-gray-800">0</p>
                        <p class="text-sm font-medium text-gray-500 mt-2">Days since Jan 1</p>
                    `
                },
                {
                    id: 'longest-streak',
                    title: 'Longest Streak',
                    content: `
                        <p id="longest-streak-display" class="text-6xl font-extrabold text-gray-800">0</p>
                        <p class="text-sm font-medium text-gray-500 mt-2">Days ever</p>
                    `
                },
                {
                    id: 'average-streak',
                    title: 'Average Streak',
                    content: `
                        <p id="average-streak-display" class="text-6xl font-extrabold text-gray-800">0</p>
                        <p class="text-sm font-medium text-gray-500 mt-2">Days on average</p>
                    `
                },
                {
                    id: 'record-failure',
                    title: 'Ended Streak?',
                    content: `<button id="record-failure-btn" class="bg-red-600 text-white px-6 py-3 rounded-lg text-lg font-bold shadow-md hover:bg-red-700 transition duration-300">Record Failure</button>`
                }
            ];

            function renderCards() {
                cardsContainer.innerHTML = ''; // Clear existing cards
                cards.forEach(cardData => {
                    const card = document.createElement('div');
                    card.id = `card-${cardData.id}`;
                    card.className = 'card bg-white p-6 rounded-xl shadow-lg flex flex-col space-y-4';
                    card.setAttribute('draggable', 'true');
                    card.setAttribute('data-card-id', cardData.id);
                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-700">${cardData.title}</h3>
                            <button class="hide-card-btn text-gray-400 hover:text-gray-600 transition duration-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <div class="flex-grow flex flex-col items-center justify-center text-center">
                            ${cardData.content}
                        </div>
                    `;
                    cardsContainer.appendChild(card);
                });
            }

            // --- Home Page Logic ---
            function updateAllCards() {
                updateCounter();
                updateProgress();
                updateTotalDaysThisYear();
                updateStreakStats();
            }

            function updateCounter() {
                const counterDisplay = document.getElementById('counter-display');
                if (counterDisplay && startDate) {
                    const now = new Date();
                    const start = new Date(startDate);
                    const diffTime = now - start;
                    
                    const totalSeconds = Math.floor(diffTime / 1000);
                    const totalMinutes = Math.floor(totalSeconds / 60);
                    const totalHours = Math.floor(totalMinutes / 60);
                    const totalDays = Math.floor(totalHours / 24);
                    
                    const minutes = totalMinutes % 60;
                    const hours = totalHours % 24;
                    const days = totalDays;

                    const daysString = days.toString().padStart(2, '0');
                    const hoursString = hours.toString().padStart(2, '0');
                    const minutesString = minutes.toString().padStart(2, '0');

                    counterDisplay.textContent = `${daysString}:${hoursString}:${minutesString}`;
                } else if (counterDisplay) {
                    counterDisplay.textContent = '00:00:00';
                }
            }

            function updateProgress() {
                const progressBar = document.getElementById('progress-bar-fill');
                const progressText = document.getElementById('progress-text');
                if (progressBar && startDate && goalDate) {
                    const start = new Date(startDate);
                    const goal = new Date(goalDate);
                    const now = new Date();

                    if (goal < start) {
                        progressBar.style.width = '0%';
                        progressText.textContent = 'Invalid dates';
                        return;
                    }

                    const totalTime = goal - start;
                    const elapsed = now - start;

                    let percentage = (elapsed / totalTime) * 100;
                    percentage = Math.max(0, Math.min(100, percentage)); // Clamp between 0 and 100
                    
                    progressBar.style.width = `${percentage}%`;
                    progressText.textContent = `${percentage.toFixed(0)}% complete`;
                } else if (progressBar) {
                    progressBar.style.width = '0%';
                    progressText.textContent = 'Set a goal';
                }
            }
            
            function updateTotalDaysThisYear() {
                const totalDaysDisplay = document.getElementById('total-days-this-year-display');
                if (totalDaysDisplay) {
                    const days = getDaysThisYear();
                    totalDaysDisplay.textContent = days;
                }
            }
            
            function updateStreakStats() {
                const longestStreakDisplay = document.getElementById('longest-streak-display');
                const averageStreakDisplay = document.getElementById('average-streak-display');
                
                let longest = 0;
                let totalDuration = 0;
                if (streaksData.length > 0) {
                    streaksData.forEach(streak => {
                        longest = Math.max(longest, streak.duration);
                        totalDuration += streak.duration;
                    });
                    const average = totalDuration / streaksData.length;
                    averageStreakDisplay.textContent = average.toFixed(0);
                } else {
                    averageStreakDisplay.textContent = '0';
                }
                longestStreakDisplay.textContent = longest;
            }

            // --- Stats Page Logic ---
            function renderStatsTable() {
                statsTableBody.innerHTML = ''; // Clear table
                const sortedStreaks = [...streaksData].sort((a, b) => {
                    if (currentSortColumn === 'duration') {
                        return sortDirection === 'asc' ? a.duration - b.duration : b.duration - a.duration;
                    }
                    const dateA = new Date(a[currentSortColumn]);
                    const dateB = new Date(b[currentSortColumn]);
                    return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                });
            
                if (sortedStreaks.length === 0) {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="4" class="p-4 text-center text-gray-500">No streak data available.</td>`;
                    statsTableBody.appendChild(noDataRow);
                    return;
                }
            
                sortedStreaks.forEach(streak => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition duration-300';
                    row.innerHTML = `
                        <td class="p-4">${streak.startDate}</td>
                        <td class="p-4">${streak.endDate}</td>
                        <td class="p-4">${streak.duration}</td>
                        <td class="p-4">
                            ${streak.reason ? `<button class="view-reason-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-sm font-medium hover:bg-gray-300 transition duration-300" data-reason="${encodeURIComponent(streak.reason)}">View</button>` : 'N/A'}
                        </td>
                    `;
                    statsTableBody.appendChild(row);
                });
            }

            // --- Journal Page Logic ---
            function renderJournalPosts(filteredEntries = null) {
                journalPostsContainer.innerHTML = '';
                
                // Sort by ID, descending (most recent first)
                const sortedEntries = (filteredEntries || journalEntries).sort((a, b) => b.id - a.id);
                const entriesToDisplay = sortedEntries.slice(0, postsToShow);

                if (entriesToDisplay.length === 0) {
                    journalPostsContainer.innerHTML = `<p class="text-center text-gray-500">No journal entries found.</p>`;
                } else {
                    entriesToDisplay.forEach(entry => {
                        const postCard = document.createElement('div');
                        postCard.className = 'bg-white p-6 rounded-xl shadow-lg flex justify-between items-center';
                        postCard.innerHTML = `
                            <div>
                                <h4 class="text-lg font-semibold text-gray-700">${entry.title}</h4>
                                <p class="text-sm text-gray-500">${entry.date}</p>
                            </div>
                            <button class="view-journal-post-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-sm font-medium hover:bg-gray-300 transition duration-300" data-id="${entry.id}">View</button>
                        `;
                        journalPostsContainer.appendChild(postCard);
                    });
                }
                
                // Show/hide "View More" button
                if (sortedEntries.length > postsToShow) {
                    journalViewMoreBtn.classList.remove('hidden');
                } else {
                    journalViewMoreBtn.classList.add('hidden');
                }
            }

            function populateMonthFilter() {
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const years = [...new Set(journalEntries.map(e => new Date(e.date).getFullYear()))].sort((a, b) => b - a);
                
                journalMonthFilter.innerHTML = `<option value="">Filter by Month</option>`;
                years.forEach(year => {
                    months.forEach((month, index) => {
                        const monthValue = `${year}-${String(index + 1).padStart(2, '0')}`;
                        const option = document.createElement('option');
                        option.value = monthValue;
                        option.textContent = `${month} ${year}`;
                        journalMonthFilter.appendChild(option);
                    });
                });
            }

            // --- Modal Functions ---
            function showModal(modal) {
                modal.classList.remove('hidden');
                document.body.classList.add('modal-open');
            }

            function hideModal(modal) {
                modal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }
            
            function resetFailureForm() {
                failureReasonInput.value = '';
            }

            function resetManualForm() {
                manualStartDateInput.value = '';
                manualEndDateInput.value = '';
                manualReasonInput.value = '';
            }

            function resetJournalForm() {
                journalTitleInput.value = '';
                journalBodyInput.value = '';
                editingEntryId = null;
                journalSubmitBtn.textContent = 'Submit';
                journalSubmitBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                journalSubmitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
            
            function setActiveTab(tabId) {
                // Remove active class from all tabs
                document.querySelectorAll('.tab-link').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Add active class to the selected tab
                const selectedTab = document.getElementById(tabId);
                selectedTab.classList.add('active');
            }
            
            function showPage(pageId) {
                // Hide all pages
                document.querySelectorAll('section').forEach(page => page.classList.add('hidden'));
                
                // Show the selected page
                const activePage = document.getElementById(pageId);
                if (activePage) {
                    activePage.classList.remove('hidden');
                }
            }
            
            // Function to update the date card display
            function updateDateCardDisplay(cardId, date) {
                const card = document.getElementById(`card-${cardId}`);
                if (!card) return;

                const displaySpan = card.querySelector(`#${cardId}-date-display`);
                const input = card.querySelector(`#${cardId}-date-input`);
                const editBtn = card.querySelector(`#edit-${cardId}-btn`);

                if (displaySpan && input && editBtn) {
                    displaySpan.textContent = formatDate(date);
                    input.value = date;
                    
                    displaySpan.classList.remove('hidden');
                    editBtn.classList.remove('hidden');
                    input.classList.add('hidden');
                }
            }
            
            // Function to toggle the date input visibility on a card
            function toggleDateInputVisibility(cardId, showInput) {
                const card = document.getElementById(`card-${cardId}`);
                if (!card) return;
                
                const displaySpan = card.querySelector(`#${cardId}-date-display`);
                const input = card.querySelector(`#${cardId}-date-input`);
                const editBtn = card.querySelector(`#edit-${cardId}-btn`);

                if (showInput) {
                    displaySpan.classList.add('hidden');
                    editBtn.classList.add('hidden');
                    input.classList.remove('hidden');
                    input.focus();
                } else {
                    displaySpan.classList.remove('hidden');
                    editBtn.classList.remove('hidden');
                    input.classList.add('hidden');
                }
            }


            // --- Event Listeners ---
            
            // Drag and Drop event listeners attached to the container
            cardsContainer = document.getElementById('cards-container');
            cardsContainer.addEventListener('dragstart', (event) => {
                draggedItem = event.target;
                setTimeout(() => {
                    event.target.style.opacity = '0.5';
                }, 0);
            });

            cardsContainer.addEventListener('dragend', (event) => {
                event.target.style.opacity = '1';
                draggedItem = null;
            });
            
            cardsContainer.addEventListener('dragover', handleDragOver);

            // Navigation
            homeTab.addEventListener('click', (e) => {
                e.preventDefault();
                showPage('home-page');
                setActiveTab('home-tab');
            });

            statsTab.addEventListener('click', (e) => {
                e.preventDefault();
                showPage('stats-page');
                setActiveTab('stats-tab');
                renderStatsTable();
                updateStreakStats();
            });

            journalTab.addEventListener('click', (e) => {
                e.preventDefault();
                showPage('journal-page');
                setActiveTab('journal-tab');
                renderJournalPosts();
                populateMonthFilter();
            });

            // Date Input Handlers
            document.addEventListener('click', (event) => {
                const target = event.target;
                // Handle "Edit" button clicks
                if (target.id === 'edit-start-date-btn') {
                    toggleDateInputVisibility('start-date', true);
                } else if (target.id === 'edit-goal-date-btn') {
                    toggleDateInputVisibility('goal-date', true);
                }
            });

            document.addEventListener('change', (event) => {
                const target = event.target;
                if (target.id === 'start-date-input') {
                    startDate = target.value;
                    updateDateCardDisplay('start-date', startDate);
                    updateAllCards();
                } else if (target.id === 'goal-date-input') {
                    goalDate = target.value;
                    updateDateCardDisplay('goal-date', goalDate);
                    updateAllCards();
                }
            });
            
            // Record Failure Modal
            document.addEventListener('click', (event) => {
                if(event.target.id === 'record-failure-btn'){
                    if (!startDate) {
                        alert('Please select a start date first.');
                        return;
                    }
                    showModal(failureModal);
                }
            });

            cancelFailureBtn.addEventListener('click', () => {
                hideModal(failureModal);
                resetFailureForm();
            });

            submitFailureBtn.addEventListener('click', () => {
                const reason = failureReasonInput.value.trim();
                const now = new Date();
                const duration = getDaysElapsed(startDate, now);
                
                streaksData.push({
                    startDate: startDate,
                    endDate: now.toISOString().split('T')[0],
                    duration: duration,
                    reason: reason || 'N/A'
                });
                
                // Set the start date for the new streak to the current day
                const today = new Date();
                const todayISO = today.toISOString().split('T')[0];
                startDate = todayISO;
                
                updateDateCardDisplay('start-date', startDate);
                updateAllCards();

                hideModal(failureModal);
                resetFailureForm();
            });

            // Manual Streak Modal
            document.addEventListener('click', (event) => {
                if(event.target.id === 'add-streak-btn'){
                    showModal(manualModal);
                }
            });
            

            cancelManualBtn.addEventListener('click', () => {
                hideModal(manualModal);
                resetManualForm();
            });
            
            submitManualBtn.addEventListener('click', () => {
                const manualStartDate = manualStartDateInput.value;
                const manualEndDate = manualEndDateInput.value;
                const manualReason = manualReasonInput.value;

                if (!manualStartDate || !manualEndDate) {
                    alert('Please enter both start and end dates.');
                    return;
                }
                if (new Date(manualStartDate) > new Date(manualEndDate)) {
                    alert('Start date cannot be after end date.');
                    return;
                }
                
                const duration = getDaysElapsed(manualStartDate, manualEndDate);
                
                streaksData.push({
                    startDate: manualStartDate,
                    endDate: manualEndDate,
                    duration: duration,
                    reason: manualReason || 'N/A'
                });
                
                hideModal(manualModal);
                resetManualForm();
                renderStatsTable(); // Re-render the stats table with the new data
            });

            // Reason Modal
            statsTable.addEventListener('click', (event) => {
                const targetBtn = event.target.closest('.view-reason-btn');
                if (targetBtn) {
                    const reason = decodeURIComponent(targetBtn.dataset.reason);
                    reasonText.textContent = reason;
                    showModal(reasonModal);
                }
            });
            
            closeReasonBtn.addEventListener('click', () => {
                hideModal(reasonModal);
            });

            // Sorting for Stats Table
            statsTable.querySelector('thead').addEventListener('click', (event) => {
                const targetHeader = event.target.closest('th');
                if (targetHeader && targetHeader.dataset.sort) {
                    const column = targetHeader.dataset.sort;
                    if (currentSortColumn === column) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortColumn = column;
                        sortDirection = 'asc';
                    }
                    renderStatsTable();
                }
            });

            // Card functionality (hide/drag)
            cardsContainer.addEventListener('click', (event) => {
                const hideBtn = event.target.closest('.hide-card-btn');
                if (hideBtn) {
                    const card = hideBtn.closest('.card');
                    card.classList.toggle('hidden');
                    toggleRestoreButtonVisibility(); // Check and update button visibility
                }
            });
            
            // Restore all cards functionality
            restoreCardsBtn.addEventListener('click', () => {
                const hiddenCards = document.querySelectorAll('.card.hidden');
                hiddenCards.forEach(card => {
                    card.classList.remove('hidden');
                });
                toggleRestoreButtonVisibility();
            });

            cardsContainer.addEventListener('dragstart', (event) => {
                draggedItem = event.target;
                setTimeout(() => {
                    event.target.style.opacity = '0.5';
                }, 0);
            });

            cardsContainer.addEventListener('dragend', (event) => {
                event.target.style.opacity = '1';
                draggedItem = null;
            });
            

            // Journal Entry Submission
            journalSubmitBtn.addEventListener('click', () => {
                const title = journalTitleInput.value.trim();
                const body = journalBodyInput.value.trim();
                if (title && body) {
                    const today = new Date().toISOString().split('T')[0];
                    if (editingEntryId) {
                        const entryIndex = journalEntries.findIndex(entry => entry.id === editingEntryId);
                        if (entryIndex !== -1) {
                            journalEntries[entryIndex].title = title;
                            journalEntries[entryIndex].body = body;
                            // Do not update the ID, but update the date string for display
                            journalEntries[entryIndex].date = today;
                        }
                    } else {
                        const newEntry = {
                            id: Date.now(), // Use a unique timestamp for consistent sorting
                            title: title,
                            body: body,
                            date: today
                        };
                        journalEntries.push(newEntry);
                    }
                    resetJournalForm();
                    renderJournalPosts();
                    populateMonthFilter();
                } else {
                    alert('Please enter both a title and a body for your journal entry.');
                }
            });

            journalCancelBtn.addEventListener('click', () => {
                resetJournalForm();
            });

            // Journal Posts View/Edit
            journalPostsContainer.addEventListener('click', (event) => {
                const viewBtn = event.target.closest('.view-journal-post-btn');
                if (viewBtn) {
                    const postId = parseInt(viewBtn.dataset.id);
                    const entry = journalEntries.find(e => e.id === postId);
                    if (entry) {
                        journalViewTitle.textContent = entry.title;
                        journalViewBody.textContent = entry.body;
                        journalEditBtn.dataset.id = entry.id;
                        showModal(journalViewModal);
                    }
                }
            });

            journalCloseBtn.addEventListener('click', () => {
                hideModal(journalViewModal);
            });

            journalEditBtn.addEventListener('click', (event) => {
                const postId = parseInt(event.target.dataset.id);
                const entry = journalEntries.find(e => e.id === postId);
                if (entry) {
                    journalTitleInput.value = entry.title;
                    journalBodyInput.value = entry.body;
                    editingEntryId = postId;
                    journalSubmitBtn.textContent = 'Save Changes';
                    journalSubmitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    journalSubmitBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
                    hideModal(journalViewModal);
                }
            });

            // Journal Filtering and Searching
            journalMonthFilter.addEventListener('change', () => {
                const selectedMonth = journalMonthFilter.value;
                const filteredEntries = selectedMonth
                    ? journalEntries.filter(entry => entry.date.startsWith(selectedMonth))
                    : journalEntries;
                postsToShow = 5; // Reset post count on filter change
                renderJournalPosts(filteredEntries);
            });
            
            journalSearchInput.addEventListener('input', () => {
                const searchTerm = journalSearchInput.value.toLowerCase();
                const filteredEntries = journalEntries.filter(entry =>
                    entry.title.toLowerCase().includes(searchTerm) || entry.body.toLowerCase().includes(searchTerm)
                );
                postsToShow = 5; // Reset post count on search
                renderJournalPosts(filteredEntries);
            });

            // View More Button
            journalViewMoreBtn.addEventListener('click', () => {
                postsToShow += 5;
                renderJournalPosts();
            });


            // --- Initial Setup ---
            // Set up initial navigation state
            showPage('home-page');
            setActiveTab('home-tab');

            // Set default dates
            const defaultStartDate = '2025-08-17';
            const defaultGoalDate = '2025-12-31';
            startDate = defaultStartDate;
            goalDate = defaultGoalDate;

            renderCards();
            
            // Set initial display for date cards
            updateDateCardDisplay('start-date', startDate);
            updateDateCardDisplay('goal-date', goalDate);

            setInterval(updateAllCards, 1000); // Update the counter every second
            updateAllCards();
        });
    </script>
</body>
</html>
