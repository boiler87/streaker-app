<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaker</title>
    <!-- FAVICON LINK -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/rynwynk/streaker-app/main/logo%20only.png">
    <!-- GOOGLE FONTS LINK -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        @font-face {
            font-family: 'AppleIIe';
            src: url('https://daniellopes.com.br/apple-ii/AppleIIe.ttf') format('truetype');
        }

        body {
            font-family: 'AppleIIe', monospace;
            background-color: #000;
            color: #27ff47;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            background-color: #000;
            padding: 30px;
            border: 2px solid #27ff47;
            box-shadow: 0 0 10px #27ff47;
            max-width: 800px;
            width: 100%;
        }
        .hidden {
            display: none !important; /* The definitive fix */
        }
        
        .logo-and-title {
            display: flex;
            align-items: center;
            gap: 15px; /* Increased gap */
        }
        .logo-and-title div {
           display: flex;
           flex-direction: column;
        }
        .logo-and-title h2 {
            font-family: 'Press Start 2P', cursive;
            margin-bottom: 5px; /* Space between title and subtitle */
        }
        .subtitle {
            font-size: 0.8em;
            color: #27ff47;
            margin: 0;
        }

        h2 {
            color: #27ff47;
            text-align: left;
            margin: 0;
            font-size: 2em;
        }
        .logo {
            height: 60px; /* Adjusted height */
            width: auto;
            image-rendering: pixelated;
        }
        .header-container {
            margin-bottom: 20px;
        }
        form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        input[type="email"],
        input[type="password"],
        input[type="date"],
        input[type="number"],
        input[type="search"],
        input[type="text"] {
            padding: 12px;
            border: 2px solid #27ff47;
            background-color: #000;
            color: #27ff47;
            flex-grow: 1;
            font-size: 16px;
            font-family: 'AppleIIe', monospace;
        }
        textarea {
            padding: 12px;
            border: 2px solid #27ff47;
            background-color: #000;
            color: #27ff47;
            flex-basis: 100%;
            min-height: 80px;
            resize: vertical;
            font-family: 'AppleIIe', monospace;
            font-size: 16px;
        }
        button {
            padding: 12px 20px;
            border: 2px solid #27ff47;
            background-color: #27ff47;
            color: #000;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #1aff32;
        }
        button:disabled {
            background-color: #111;
            color: #444;
            border-color: #444;
            cursor: not-allowed;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }

        /* --- START LOGIN PAGE REDESIGN --- */
        #auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #auth-container .logo-and-title {
            justify-content: center;
            margin-bottom: 40px;
        }
        
        .terminal-window {
            width: 100%;
            max-width: 450px;
            border: 2px solid #27ff47;
            background-color: #080808;
            padding: 0;
            box-shadow: 0 0 15px rgba(39, 255, 71, 0.5);
        }

        .terminal-header {
            background-color: #27ff47;
            color: #000;
            padding: 5px 10px;
            font-weight: bold;
            text-align: center;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8em;
        }
        
        #auth-form {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
        }
        
        #auth-form .form-row {
             width: 100%;
        }

        #auth-form label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        #auth-form input {
            width: 100%;
        }
        
        #auth-form .button-group {
            width: 100%;
            justify-content: space-between;
        }

        #auth-form .button-group button {
            flex-grow: 1;
            flex-basis: 0;
        }
        
        .blinking-cursor {
            font-weight: bold;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            from, to { color: transparent; }
            50% { color: #27ff47; }
        }
        /* --- END LOGIN PAGE REDESIGN --- */


        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .error-message {
            color: #ff0000;
            text-align: center;
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #27ff47;
            margin-top: 20px;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border: 1px solid #27ff47;
        }
        th {
            background-color: #111;
            color: #27ff47;
            font-weight: 600;
            cursor: pointer;
        }
        th:hover {
            background-color: #333;
        }
        th .sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
        }
        tr:hover {
            background-color: #001;
        }
        .delete-btn {
            background-color: #ff0000;
            color: #000;
        }
        .delete-btn:hover {
            background-color: #cc0000;
        }
        
        .edit-btn {
            background-color: #27ff47;
            color: #000;
            font-size: 14px;
            padding: 8px 12px;
            margin-right: 5px;
        }
        .edit-btn:hover {
            background-color: #1aff32;
        }

        .save-btn {
            background-color: #27ff47;
            color: #000;
        }
        .save-btn:hover {
            background-color: #1aff32;
        }
        .cancel-btn {
            background-color: #ff0000;
            color: #000;
        }
        .cancel-btn:hover {
            background-color: #cc0000;
        }

        .end-streak-btn {
            background-color: #27ff47;
            color: #000;
            font-size: 14px;
            padding: 8px 12px;
        }
        .end-streak-btn:hover {
            background-color: #1aff32;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .profile-dropdown-container {
            position: relative;
        }
        .profile-btn {
            font-size: 1.5em;
            background: none;
            border: 2px solid #27ff47;
            color: #27ff47;
            padding: 5px 10px;
            cursor: pointer;
            line-height: 1;
        }
        .profile-btn:hover {
            background-color: #111;
        }
        .profile-dropdown {
            position: absolute;
            top: 120%;
            right: 0;
            background-color: #000;
            border: 2px solid #27ff47;
            box-shadow: 0 0 10px #27ff47;
            z-index: 100;
            min-width: 275px;
        }
        .dropdown-section {
            padding: 15px;
            border-bottom: 2px solid #27ff47;
        }
        .profile-dropdown > div:last-child {
            border-bottom: none;
        }

        #user-profile-display {
            word-break: break-all;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .username-change-section {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }
        #new-username-input {
            flex-grow: 1;
            font-size: 0.9em;
            padding: 8px;
        }
        #save-username-btn {
            padding: 8px 12px;
            font-size: 0.9em;
        }
        #username-status {
            flex-basis: 100%;
            text-align: left;
            margin: 5px 0 0 0;
            font-size: 0.8em;
        }

        #refresh-public-data-btn, .logout-btn {
            width: 100%;
        }

        .dropdown-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .toggle-switch label {
            cursor: pointer;
            white-space: nowrap;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            width: 40px;
            height: 20px;
            background-color: #333;
            border: 1px solid #27ff47;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: #27ff47;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: #111;
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        #public-link-container {
            margin-top: 10px;
        }
        #public-link-display {
            width: 100%;
            padding: 5px;
            background: #111;
            border: 1px solid #27ff47;
            color: #27ff47;
            font-size: 0.8em;
            word-break: break-all;
        }
        

        .view-more-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .stats-section-header {
            margin-top: 40px;
            text-align: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .stat-card {
            background-color: #111;
            padding: 20px;
            border: 2px solid #27ff47;
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #27ff47;
            text-align: center;
        }
        
        .stat-card p {
            font-size: 2em;
            font-weight: bold;
            color: #27ff47;
        }

        .progress-bar-container {
            width: 100%;
            height: 20px;
            border: 1px solid #27ff47;
            background-color: #000;
            margin-top: 10px;
        }
        .progress-bar {
            height: 100%;
            background-color: #27ff47;
            transition: width 0.5s ease-in-out;
        }
        .progress-text {
            font-size: 1.5em;
            margin-top: 10px;
        }
        
        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-buttons button {
            background-color: #111;
            color: #27ff47;
            border: 2px solid #27ff47;
        }
        .tab-buttons button.active {
            background-color: #27ff47;
            color: #000;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
            text-align: center;
        }
        .badge-card {
            background-color: #111;
            padding: 20px;
            border: 2px solid #27ff47;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .badge-icon {
            font-size: 3em;
            color: #444;
            transition: color 0.5s ease;
        }
        .badge-icon.unlocked {
            color: #27ff47;
            text-shadow: 0 0 10px #27ff47;
        }
        .badge-name {
            margin-top: 10px;
            font-weight: bold;
        }

        .journal-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            border: 2px solid #27ff47;
            padding: 15px;
        }
        .journal-entry {
            background-color: #111;
            border: 2px solid #27ff47;
            padding: 20px;
            margin-bottom: 20px;
        }
        .journal-entry-date {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .journal-entry-text {
            white-space: pre-wrap;
            line-height: 1.5;
        }
        .journal-entry-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        #condensed-calendar-container, #public-condensed-calendar-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            border: 2px solid #27ff47;
            padding: 15px;
        }
        .month-grid-container {
            padding: 10px;
        }
        .month-grid-title {
            text-align: center;
            font-size: 1em;
            margin-bottom: 10px;
        }
        .month-grid-dow, .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }
        .month-grid-dow div {
            text-align: center;
            font-size: 0.7em;
        }
        .month-grid-day {
            width: 100%;
            padding-bottom: 100%;
            position: relative;
            background-color: #1a1a1a;
        }
        .month-grid-day.active {
            background-color: #27ff47;
        }
        .month-grid-day.end {
            background-color: #27ff47;
        }
        .year-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .year-nav h2 {
            margin: 0;
        }
        .year-nav button {
            padding: 5px 10px;
            font-size: 1.2em;
            line-height: 1;
        }

        .dashboard-top-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        #goal-progress-container.stat-card {
             padding: 15px;
        }

        .goal-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .goal-inputs label {
            font-size: 0.9em;
        }
        .goal-inputs input {
            flex-grow: 1;
            min-width: 80px;
            padding: 8px;
        }
        .goal-inputs span {
            font-style: italic;
        }


        @media (max-width: 800px) {
             .three-month-view {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 700px) { 
            .dashboard-top-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
            }
            form {
                flex-direction: column;
            }
            .button-group {
                flex-direction: column;
            }
            table, thead, tbody, th, td, tr {
                display: block;
            }
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid #27ff47;
                margin-bottom: 15px;
            }
            td {
                border: none;
                border-bottom: 1px solid #27ff47;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            td:before {
                position: absolute;
                top: 0;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                content: attr(data-label);
                text-align: left;
                font-weight: bold;
                color: #27ff47;
            }
            td:last-child {
                border-bottom: 0;
            }
            .delete-btn {
                width: 100%;
                margin-top: 10px;
            }
            .start-date-cell:before { content: "Start Date"; }
            .end-date-cell:before { content: "End Date"; }
            .duration-cell:before { content: "Duration"; }
            .actions-cell:before { content: "Actions"; }

            .journal-controls {
                flex-direction: column;
            }
            .calendar-day {
                height: 40px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>

    <!-- NEW: Loading Screen -->
    <div id="loading-container" class="container" style="text-align: center; padding: 50px;">
        <p>LOADING STREAKER...</p>
    </div>
    
    <!-- NEW: Public View Container -->
    <div id="public-view-container" class="container hidden">
        <!-- Public, read-only content will be rendered here by JavaScript -->
    </div>


    <!-- Login/Signup Section -->
    <div id="auth-container" class="container hidden">
        <div class="logo-and-title" style="margin-bottom: 20px;">
            <img src="https://raw.githubusercontent.com/rynwynk/streaker-app/main/logo%20only.png" alt="Streaker Logo" class="logo">
            <div>
                <h2>Streaker</h2>
                <p class="subtitle">Satisfied Through Denial</p>
            </div>
        </div>
        <div class="terminal-window">
            <div class="terminal-header">USER AUTHENTICATION</div>
            <form id="auth-form">
                <div class="form-row hidden">
                    <label for="username-input">USERNAME:</label>
                    <input type="text" id="username-input" placeholder="ENTER USERNAME" autocomplete="username">
                </div>
                 <div class="form-row">
                    <label for="email-input">EMAIL:</label>
                    <input type="email" id="email-input" placeholder="ENTER EMAIL" required autocomplete="email">
                 </div>
                 <div class="form-row">
                    <label for="password-input">PASSWORD:</label>
                    <input type="password" id="password-input" placeholder="ENTER PASSWORD" required autocomplete="current-password">
                 </div>
                 <div style="width: 100%; text-align: left;">
                    > <span class="blinking-cursor">_</span>
                 </div>
                <div class="button-group">
                    <button type="submit" id="main-auth-btn">Log In</button>
                    <button type="button" id="toggle-auth-mode-btn">Sign Up</button>
                </div>
            </form>
        </div>
        <p id="auth-error" class="error-message"></p>
    </div>

    <!-- Main App Section -->
    <div id="main-app-container" class="container hidden">
        <div class="header">
            <div class="logo-and-title">
                <img src="https://raw.githubusercontent.com/rynwynk/streaker-app/main/logo%20only.png" alt="Streaker Logo" class="logo">
                <div>
                    <h2>Streaker</h2>
                    <p class="subtitle">Satisfied Through Denial</p>
                </div>
            </div>
            <div class="nav-buttons">
                <div class="profile-dropdown-container">
                    <button id="profile-btn" class="profile-btn">ðŸ‘¤</button>
                    <div id="profile-dropdown" class="profile-dropdown hidden">
                        <div class="dropdown-section">
                            <p id="user-profile-display"></p>
                        </div>
                        <div class="dropdown-section username-change-section">
                            <input type="text" id="new-username-input" placeholder="New username">
                            <button id="save-username-btn">Save</button>
                            <p id="username-status" class="error-message"></p>
                        </div>
                        <div class="dropdown-section dropdown-actions">
                            <div class="sharing-section" style="border-top: none; padding: 0; margin: 0;">
                                <div class="toggle-switch">
                                    <label for="public-profile-toggle">Enable Public Profile</label>
                                    <label class="slider-container">
                                        <input type="checkbox" id="public-profile-toggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div id="public-link-container" class="hidden">
                                    <input type="text" id="public-link-display" readonly>
                                    <button id="refresh-public-data-btn">Refresh Public Data</button>
                                </div>
                            </div>
                            <button id="new-logout-btn" class="logout-btn" style="margin: 0;">Log Out</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-buttons">
            <button id="dashboard-tab-btn" class="active">Dashboard</button>
            <button id="logbook-tab-btn">Stats</button>
            <button id="achievements-tab-btn">Achievements</button>
            <button id="journal-tab-btn">Journal</button>
            <button id="about-tab-btn">About</button>
        </div>

        <!-- Dashboard Container -->
        <div id="dashboard-container">
             <div class="dashboard-top-grid">
                <div class="stat-card">
                    <h3>Current Streak</h3>
                    <p id="current-streak-duration-stat">0d 0h 0m</p>
                </div>
                <div id="goal-progress-container" class="stat-card">
                    <h3>Goal Progress</h3>
                    <div id="progress-bar-container" class="progress-bar-container" style="margin-top: 15px;">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                    <p id="progress-text" class="progress-text" style="font-size: 1.2em; margin-top: 5px;">0%</p>
                    <p id="goal-date" style="font-size: 0.8em; margin-top: 5px; min-height: 1em;"></p>
                    <div class="goal-inputs">
                         <label for="goal-input">Days:</label>
                         <input type="number" id="goal-input" placeholder="e.g., 30">
                         <span>OR</span>
                         <label for="goal-date-input">Date:</label>
                         <input type="date" id="goal-date-input">
                    </div>
                </div>
            </div>
            
            <h2 class="stats-section-header" style="text-align: left;">Log Book</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center;">
                <form id="entry-form" style="flex-grow: 1; margin-bottom: 0; display: flex; flex-wrap: wrap; gap: 10px;">
                    <input type="date" id="start-date-input" required style="flex-grow: 1;">
                    <input type="date" id="end-date-input" style="flex-grow: 1;">
                    <button type="submit">Add Entry</button>
                </form>
                <button id="export-btn" style="height: fit-content;">Export to CSV</button>
            </div>
            
            <table id="log-table">
                <thead>
                    <tr>
                        <th data-sort-key="startDate">Start Date <span class="sort-icon"></span></th>
                        <th data-sort-key="endDate">End Date <span class="sort-icon"></span></th>
                        <th data-sort-key="duration">Duration <span class="sort-icon"></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div id="view-more-container" class="view-more-container hidden">
                <button id="view-more-btn">View More</button>
            </div>
        </div>

        <!-- Stats Container (formerly Logbook) -->
        <div id="logbook-container" class="hidden">
            <div id="stats-container">
                <h2 class="stats-section-header">All-Time Stats</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Days This Year</h3>
                        <p id="total-days-year-stat">0 days</p>
                    </div>
                    <div class="stat-card">
                        <h3>Longest Streak</h3>
                        <p id="longest-streak-stat">0 days</p>
                    </div>
                    <div class="stat-card">
                        <h3>Average Duration</h3>
                        <p id="avg-duration-stat">0d 0h</p>
                    </div>
                </div>
                <div class="stats-section-header year-nav">
                    <button id="prev-year-btn" title="Previous Year">&lt;</button>
                    <h2 style="margin: 0;">Year in Review (<span id="current-year-label"></span>)</h2>
                    <button id="next-year-btn" title="Next Year">&gt;</button>
                </div>
                <div id="condensed-calendar-container"></div>
            </div>
        </div>

        <!-- Achievements Container -->
        <div id="achievements-container" class="hidden">
            <h2 class="stats-section-header">My Achievements</h2>
            <div id="my-achievements-grid" class="achievements-grid">
            </div>

            <h2 class="stats-section-header">Available Badges</h2>
            <div id="available-badges-grid" class="achievements-grid">
            </div>
        </div>

        <!-- Journal Container -->
        <div id="journal-container" class="hidden">
            <h2 class="stats-section-header" style="text-align: left;">Journal</h2>
            <form id="journal-form">
                <textarea id="journal-input" placeholder="Write your journal entry here..."></textarea>
                <button type="submit">Submit Entry</button>
            </form>

            <div class="journal-controls">
                <input type="search" id="journal-search-input" placeholder="Search entries...">
                <input type="date" id="journal-filter-start-date" title="Filter start date">
                <input type="date" id="journal-filter-end-date" title="Filter end date">
                <button id="journal-filter-clear-btn">Clear</button>
            </div>

            <div id="journal-entries-container">
            </div>
        </div>

        <!-- NEW: About Container -->
        <div id="about-container" class="hidden" style="line-height: 1.8;">
            <h2 class="stats-section-header" style="text-align: left;">About Streaker</h2>
            <p>
                Welcome to Streaker, your digital companion for building unbreakable habits. This app is built on a simple philosophy: consistency is the key to achieving any goal. The retro interface is designed to be simple and distraction-free, helping you focus on what truly matters: showing up every single day.
            </p>
            <p>
                As the motto says, "Satisfied Through Denial." The only time to act is now.
            </p>

            <h3 class="stats-section-header" style="text-align: left; margin-top: 30px;">How It Works</h3>
            
            <h4>The Dashboard</h4>
            <p>
                This is your command center. It gives you an at-a-glance view of your progress and motivation for the day.
            </p>
            <ul>
                <li><strong>Current Streak:</strong> The main stat shows you exactly how long you've been on your current run.</li>
                <li><strong>Goal Progress:</strong> Set a goal by either a number of days or a target date. The progress bar will show you how close you are to achieving it.</li>
            </ul>

            <h4>The Logbook</h4>
            <p>
                This is your official record. Here you can add, manage, and analyze your streaks.
            </p>
            <ul>
                <li><strong>Add an Entry:</strong> Select a start date and an optional end date to log a new streak. You can only have one active (no end date) streak at a time.</li>
                <li><strong>All-Time Stats:</strong> See your longest streak, average streak duration, and total days streaked this year.</li>
                <li><strong>Export to CSV:</strong> Download all your log data for your personal records.</li>
            </ul>

            <h4>Achievements</h4>
            <p>
                Earn badges as your current streak grows longer. This page shows you the badges you've earned on this run and which ones are coming up next. Your achievements reset when a streak ends, giving you a fresh goal for the next one.
            </p>
            
            <h4>The Journal</h4>
            <p>
                Track your thoughts, feelings, and progress. Write down your successes and your struggles. You can search your entries by keyword or filter them by date to find exactly what you're looking for.
            </p>

            <h3 class="stats-section-header" style="text-align: left; margin-top: 30px;">Troubleshooting</h3>
            <h4>Why isn't my "Average Duration" showing on my public profile?</h4>
            <p>
                Your public profile is a snapshot of your data. When new features like "Average Duration" are added, your existing public snapshot needs to be updated. To fix this, simply open your profile dropdown (the ðŸ‘¤ icon), make sure your profile is public, and click the "Refresh Public Data" button. This will sync all your latest stats.
            </p>
        </div>
    </div>
    
    <!-- NEW: Journal Modal -->
    <div id="journal-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>


    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <script>
        // Your Firebase project's configuration object
        const firebaseConfig = {
          apiKey: "AIzaSyCxPG9RfxihL-Rfhu7fPSP95QDld6QMuik",
          authDomain: "streaker-1658d.firebaseapp.com",
          projectId: "streaker-1658d",
          storageBucket: "streaker-1658d.appspot.com",
          messagingSenderId: "12701860115",
          appId: "1:12701860115:web:0d4dcba33fd234df97dae6",
          measurementId: "G-XKE790N7ZL"
        };
        
        // This log is for debugging purposes.
        console.log("Firebase config:", firebaseConfig);

        // Initialize Firebase
        if (firebaseConfig.apiKey) {
            try {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully.");
            } catch (error)
                {
                console.error("Firebase initialization failed:", error.message);
                console.warn("This may be because you have not created a Firestore database for your project. Please follow the instructions in the Firebase console.");
            }
        } else {
            console.error("Firebase config is missing or invalid. Please ensure you have pasted your config correctly.");
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM elements
        const authContainer = document.getElementById('auth-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const authForm = document.getElementById('auth-form');
        const toggleAuthModeBtn = document.getElementById('toggle-auth-mode-btn');
        const mainAuthBtn = document.getElementById('main-auth-btn');
        const usernameInput = document.getElementById('username-input');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');

        const newLogoutBtn = document.getElementById('new-logout-btn');
        const exportBtn = document.getElementById('export-btn');
        
        const dashboardTabBtn = document.getElementById('dashboard-tab-btn');
        const logbookTabBtn = document.getElementById('logbook-tab-btn');
        const achievementsTabBtn = document.getElementById('achievements-tab-btn');
        const journalTabBtn = document.getElementById('journal-tab-btn');
        const aboutTabBtn = document.getElementById('about-tab-btn');

        const dashboardContainer = document.getElementById('dashboard-container');
        const logbookContainer = document.getElementById('logbook-container');
        const achievementsContainer = document.getElementById('achievements-container');
        const journalContainer = document.getElementById('journal-container');
        const aboutContainer = document.getElementById('about-container');

        // Logbook elements
        const entryForm = document.getElementById('entry-form');
        const logTableBody = document.querySelector('#log-table tbody');
        const authError = document.getElementById('auth-error');
        const startDateInput = document.getElementById('start-date-input');
        const endDateInput = document.getElementById('end-date-input');
        const tableHeaders = document.querySelectorAll('#log-table th[data-sort-key]');
        const viewMoreBtn = document.getElementById('view-more-btn');
        const viewMoreContainer = document.getElementById('view-more-container');
        const longestStreakStat = document.getElementById('longest-streak-stat');
        const currentStreakDurationStat = document.getElementById('current-streak-duration-stat');
        const avgDurationStat = document.getElementById('avg-duration-stat');
        const totalDaysYearStat = document.getElementById('total-days-year-stat');
        const condensedCalendarContainer = document.getElementById('condensed-calendar-container');
        const currentYearLabel = document.getElementById('current-year-label');
        
        // Goal elements
        const goalInput = document.getElementById('goal-input');
        const goalDateInput = document.getElementById('goal-date-input');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const goalDate = document.getElementById('goal-date');

        // Achievements elements
        const myAchievementsGrid = document.getElementById('my-achievements-grid');
        const availableBadgesGrid = document.getElementById('available-badges-grid');

        // Journal elements
        const journalForm = document.getElementById('journal-form');
        const journalInput = document.getElementById('journal-input');
        const journalEntriesContainer = document.getElementById('journal-entries-container');
        const journalSearchInput = document.getElementById('journal-search-input');
        const journalFilterStartDate = document.getElementById('journal-filter-start-date');
        const journalFilterEndDate = document.getElementById('journal-filter-end-date');
        const journalFilterClearBtn = document.getElementById('journal-filter-clear-btn');

        // NEW: Profile Dropdown elements
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const userProfileDisplay = document.getElementById('user-profile-display');
        const publicProfileToggle = document.getElementById('public-profile-toggle');
        const publicLinkContainer = document.getElementById('public-link-container');
        const publicLinkDisplay = document.getElementById('public-link-display');
        const refreshPublicDataBtn = document.getElementById('refresh-public-data-btn');
        
        // NEW: Username change elements
        const newUsernameInput = document.getElementById('new-username-input');
        const saveUsernameBtn = document.getElementById('save-username-btn');
        const usernameStatus = document.getElementById('username-status');


        // NEW: Journal Modal elements
        const journalModal = document.getElementById('journal-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        
        // NEW: Chart, Loading, and Public View containers
        const loadingContainer = document.getElementById('loading-container');
        const publicViewContainer = document.getElementById('public-view-container');
        
        let isSignupMode = false;
        let durationIntervals = {};
        let userLogs = [];
        let allJournalEntries = []; // Holds all journal entries for client-side filtering
        let sortState = {
            key: 'startDate',
            direction: 'desc'
        };
        let visibleLogEntriesCount = 5;
        let ongoingStreakInterval = null;
        let currentEditingLogId = null;
        let displayedYear = new Date().getFullYear(); // For year-in-review calendar
        let userData = {}; // To store user doc data like username, last check-in
        let mainAppListenersAdded = false; // Flag to ensure listeners are only added once

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
        
        function formatFullDate(date) {
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Function to calculate duration in minutes
        function calculateDurationInMinutes(startDate, endDate) {
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date();
            const diff = end - start;
            return Math.floor(diff / (1000 * 60));
        }

        // Function to calculate and format duration
        function calculateDuration(startDate, endDate) {
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date();
            const diff = end - start;

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            return { totalMilliseconds: diff, formatted: `${days}d ${hours}h ${minutes}m`, days: days, minutes: minutes, hours: hours };
        }

        // Function to update live duration
        function updateLiveDuration(docId, startDate) {
            if (durationIntervals[docId]) {
                clearInterval(durationIntervals[docId]);
            }
            const durationCell = document.querySelector(`tr[data-id="${docId}"] .duration-cell`);
            if (durationCell) {
                durationIntervals[docId] = setInterval(() => {
                    durationCell.textContent = calculateDuration(startDate, null).formatted;
                }, 60000); // Update every minute
            }
        }
        
        // Function to calculate total days in a streak for the current year
        function calculateTotalDaysThisYear() {
            const currentYear = new Date().getFullYear();
            let totalDays = 0;

            userLogs.forEach(doc => {
                const log = doc.data();
                const [s_year, s_month, s_day] = log.startDate.split('-').map(Number);
                const startDate = new Date(s_year, s_month - 1, s_day);

                let endDate;
                if (log.endDate) {
                    const [e_year, e_month, e_day] = log.endDate.split('-').map(Number);
                    endDate = new Date(e_year, e_month - 1, e_day);
                } else {
                    endDate = new Date();
                }

                if (startDate.getFullYear() > currentYear) return;

                const startOfYear = new Date(currentYear, 0, 1);
                const endOfYear = new Date(currentYear, 11, 31, 23, 59, 59);

                const streakStart = Math.max(startDate, startOfYear);
                const streakEnd = Math.min(endDate, endOfYear);
                
                if (streakEnd > streakStart) {
                    const diffTime = Math.abs(streakEnd - streakStart);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    totalDays += diffDays;
                }
            });
            return totalDays;
        }

        // Function to update goal progress bar
        function updateGoalProgress(goal) {
            const currentStreak = userLogs.find(doc => !doc.data().endDate);
            const currentDays = currentStreak ? calculateDuration(currentStreak.data().startDate, null).days : 0;
            const goalDays = goal || 0;

            if (!goalDays || goalDays <= 0) {
                progressBar.style.width = '0%';
                progressText.textContent = `0%`;
                goalDate.textContent = '';
                return;
            }

            const progressPercentage = Math.min((currentDays / goalDays) * 100, 100);
            progressBar.style.width = `${progressPercentage}%`;
            
            // Calculate and display projected goal date
            const remainingDays = Math.max(0, goalDays - currentDays);
            
            if (remainingDays > 0) {
                progressText.textContent = `${Math.round(progressPercentage)}% (${remainingDays} ${remainingDays === 1 ? 'day' : 'days'} remaining)`;
            } else {
                progressText.textContent = `${Math.round(progressPercentage)}% (Goal reached!)`;
            }

            const projectedDate = new Date();
            projectedDate.setDate(projectedDate.getDate() + remainingDays);

            const year = projectedDate.getFullYear();
            const month = String(projectedDate.getMonth() + 1).padStart(2, '0');
            const day = String(projectedDate.getDate()).padStart(2, '0');
            const formattedProjectedDate = `${year}-${month}-${day}`;

            goalDate.textContent = `Goal of ${goalDays} days reached on: ${formatDate(formattedProjectedDate)}`;
            if (progressPercentage >= 100) {
                goalDate.textContent = `Goal achieved!`;
            }
        }

        // Function to calculate and render stats
        function calculateStats() {
            let longestDurationMs = 0;
            let totalCompletedDurationMs = 0;
            let completedEntriesCount = 0;
            let ongoingEntry = null;

            userLogs.forEach(doc => {
                const log = doc.data();
                const duration = calculateDuration(log.startDate, log.endDate);
                if (log.endDate) {
                    totalCompletedDurationMs += duration.totalMilliseconds;
                    completedEntriesCount++;
                } else {
                    ongoingEntry = log;
                }
                
                if (duration.totalMilliseconds > longestDurationMs) {
                    longestDurationMs = duration.totalMilliseconds;
                }
            });

            // Update Longest Streak
            const longestDuration = calculateDuration(null, longestDurationMs);
            longestStreakStat.textContent = `${longestDuration.days} days`;
            
            // Update Average Duration
            if (completedEntriesCount > 0) {
                const avgMs = totalCompletedDurationMs / completedEntriesCount;
                const avgDuration = calculateDuration(null, avgMs);
                avgDurationStat.textContent = `${avgDuration.days}d ${avgDuration.hours}h`;
            } else {
                avgDurationStat.textContent = "0d 0h";
            }

            // Update Current Streak Duration
            if (ongoingEntry) {
                if (ongoingStreakInterval) clearInterval(ongoingStreakInterval);
                ongoingStreakInterval = setInterval(() => {
                    const currentDuration = calculateDuration(ongoingEntry.startDate, null);
                    currentStreakDurationStat.textContent = currentDuration.formatted;
                    updateGoalProgress(parseInt(goalInput.value, 10)); // Update progress bar with live duration
                }, 60000);
                
                const currentDuration = calculateDuration(ongoingEntry.startDate, null);
                currentStreakDurationStat.textContent = currentDuration.formatted;
            } else {
                if (ongoingStreakInterval) clearInterval(ongoingStreakInterval);
                currentStreakDurationStat.textContent = "0d 0h 0m";
            }
            
            // Update Total Days This Year
            totalDaysYearStat.textContent = `${calculateTotalDaysThisYear()} days`;
            
            updateGoalProgress(parseInt(goalInput.value, 10));
            renderCondensedCalendar(displayedYear, userLogs);
        }

        // Display log entries
        function renderLogs() {
            logTableBody.innerHTML = '';
            Object.values(durationIntervals).forEach(clearInterval);
            durationIntervals = {};
            
            const sortedLogs = userLogs.slice().sort((a, b) => {
                const aData = a.data();
                const bData = b.data();
                let aVal, bVal;

                if (sortState.key === 'duration') {
                    aVal = calculateDurationInMinutes(aData.startDate, aData.endDate);
                    bVal = calculateDurationInMinutes(bData.startDate, bData.endDate);
                } else {
                    aVal = aData[sortState.key] ? new Date(aData[sortState.key]).getTime() : 0;
                    bVal = bData[sortState.key] ? new Date(bData[sortState.key]).getTime() : 0;
                }

                if (sortState.direction === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });

            const visibleLogs = sortedLogs.slice(0, visibleLogEntriesCount);

            visibleLogs.forEach(doc => {
                const log = doc.data();
                const row = document.createElement('tr');
                row.dataset.id = doc.id;

                const startDateFormatted = formatDate(log.startDate);
                const endDateFormatted = log.endDate ? formatDate(log.endDate) : `<button class="end-streak-btn">End Streak</button>`;
                const duration = calculateDuration(log.startDate, log.endDate).formatted;
                
                if (doc.id === currentEditingLogId) {
                     const editInputHtml = `
                         <input type="date" value="${log.startDate}" data-field="startDate" class="edit-input" />
                     `;
                     const endDateInputHtml = log.endDate ?
                         `<input type="date" value="${log.endDate}" data-field="endDate" class="edit-input" />` :
                         `<input type="date" value="" data-field="endDate" class="edit-input" />`;
                     
                     row.innerHTML = `
                         <td class="start-date-cell" data-label="Start Date">${editInputHtml}</td>
                         <td class="end-date-cell" data-label="End Date">${endDateInputHtml}</td>
                         <td class="duration-cell" data-label="Duration">${duration}</td>
                         <td data-label="Actions" class="actions-cell">
                             <button class="save-btn">Save</button>
                             <button class="cancel-btn">Cancel</button>
                         </td>
                     `;
                } else {
                    row.innerHTML = `
                        <td class="start-date-cell" data-label="Start Date" data-date="${log.startDate}">${startDateFormatted}</td>
                        <td class="end-date-cell" data-label="End Date" data-date="${log.endDate}">${endDateFormatted}</td>
                        <td class="duration-cell" data-label="Duration">${duration}</td>
                        <td data-label="Actions" class="actions-cell">
                            <button class="edit-btn">Edit</button>
                            <button class="delete-btn">Delete</button>
                        </td>
                    `;
                }

                logTableBody.appendChild(row);

                if (!log.endDate) {
                    updateLiveDuration(doc.id, log.startDate);
                }
            });

            if (userLogs.length > visibleLogEntriesCount) {
                viewMoreContainer.classList.remove('hidden');
            } else {
                viewMoreContainer.classList.add('hidden');
            }

            tableHeaders.forEach(header => {
                const icon = header.querySelector('.sort-icon');
                if (header.dataset.sortKey === sortState.key) {
                    icon.textContent = sortState.direction === 'asc' ? 'â–²' : 'â–¼';
                } else {
                    icon.textContent = '';
                }
            });
        }
        
        // Function to render achievements
        function renderAchievements() {
            myAchievementsGrid.innerHTML = '';
            availableBadgesGrid.innerHTML = '';
            
            const ongoingEntry = userLogs.find(doc => !doc.data().endDate);
            const currentStreakDays = ongoingEntry ? calculateDuration(ongoingEntry.data().startDate, null).days : 0;
            
            const achievements = [
                { name: "7-Day Streak", days: 7, icon: 'â­' },
                { name: "2-Week Streak", days: 14, icon: 'ðŸ“…' },
                { name: "30-Day Streak", days: 30, icon: 'ðŸ†' },
                { name: "90-Day Streak", days: 90, icon: 'ðŸ›¡ï¸' },
                { name: "100-Day Streak", days: 100, icon: 'ðŸ’¯' },
                { name: "One-Month Wonder", days: 30, icon: 'ðŸŒŸ' },
                { name: "Two-Month Trekker", days: 60, icon: 'ðŸš¶â€â™‚ï¸' },
                { name: "Three-Month Triumph", days: 90, icon: 'ðŸŽ‰' },
                { name: "Four-Month Force", days: 120, icon: 'ðŸ’ª' },
                { name: "Five-Month Fighter", days: 150, icon: 'ðŸ¥Š' },
                { name: "Six-Month Soarer", days: 180, icon: 'ðŸ•Šï¸' },
                { name: "Seven-Month Success", days: 210, icon: 'ðŸŽ¯' },
                { name: "Eight-Month Effort", days: 240, icon: 'ðŸ¥‡' },
                { name: "Nine-Month Ninja", days: 270, icon: 'ðŸ¥·' },
                { name: "Ten-Month Titan", days: 300, icon: 'ðŸ‘‘' },
                { name: "Eleven-Month Emperor", days: 330, icon: 'ðŸ‘‘' },
                { name: "One-Year Victor", days: 365, icon: 'ðŸ…' },
            ];
            
            achievements.sort((a, b) => a.days - b.days);

            let hasEarnedBadges = false;

            achievements.forEach(achievement => {
                const unlocked = currentStreakDays >= achievement.days;

                if (unlocked) {
                    hasEarnedBadges = true;
                    const myBadge = document.createElement('div');
                    myBadge.className = 'badge-card';
                    myBadge.innerHTML = `
                        <div class="badge-icon unlocked">${achievement.icon}</div>
                        <div class="badge-name">${achievement.name}</div>
                    `;
                    myAchievementsGrid.appendChild(myBadge);
                } else {
                    const availableBadge = document.createElement('div');
                    availableBadge.className = 'badge-card';
                    availableBadge.innerHTML = `
                        <div class="badge-icon">${achievement.icon}</div>
                        <div class="badge-name">${achievement.name}</div>
                    `;
                    availableBadgesGrid.appendChild(availableBadge);
                }
            });
            
            if (!hasEarnedBadges) {
                myAchievementsGrid.innerHTML = '<p style="font-style: italic; color: #aaa; margin-top: 10px;">Keep going! You haven\'t earned any badges yet on this streak.</p>';
            }

            if (availableBadgesGrid.children.length === 0) {
                 availableBadgesGrid.innerHTML = '<p style="font-style: italic; color: #aaa; margin-top: 10px;">Congratulations! You have collected all available badges for this streak!</p>';
            }
        }
        
        function renderCondensedCalendar(year, allLogs, containerId = '#condensed-calendar-container', yearLabelId = '#current-year-label') {
            const container = document.querySelector(containerId);
            const yearLabel = document.querySelector(yearLabelId);
            if (!container || !yearLabel) return;

            container.innerHTML = '';
            yearLabel.textContent = year;

            const activeDays = new Set();
            const endDays = new Set();
            allLogs.forEach(doc => {
                const log = doc.data();
                const logStart = new Date(log.startDate + "T00:00:00");
                const logEnd = log.endDate ? new Date(log.endDate + "T00:00:00") : new Date();
                
                if (log.endDate) {
                    const endDayDate = new Date(log.endDate + "T00:00:00");
                    if(endDayDate.getFullYear() === year) {
                        endDays.add(log.endDate);
                    }
                }

                for (let d = new Date(logStart); d <= logEnd; d.setDate(d.getDate() + 1)) {
                    if (d.getFullYear() === year) {
                        activeDays.add(d.toISOString().split('T')[0]);
                    }
                }
            });

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            for(let month = 0; month < 12; month++) {
                const monthContainer = document.createElement('div');
                monthContainer.className = 'month-grid-container';

                const monthTitle = document.createElement('h3');
                monthTitle.className = 'month-grid-title';
                monthTitle.textContent = monthNames[month];
                monthContainer.appendChild(monthTitle);

                const dowHeader = document.createElement('div');
                dowHeader.className = 'month-grid-dow';
                ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => {
                    const dowEl = document.createElement('div');
                    dowEl.textContent = d;
                    dowHeader.appendChild(dowEl);
                });
                monthContainer.appendChild(dowHeader);

                const monthGrid = document.createElement('div');
                monthGrid.className = 'month-grid';

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for(let i=0; i<firstDayOfMonth; i++) {
                    const emptyCell = document.createElement('div');
                    monthGrid.appendChild(emptyCell);
                }

                for(let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'month-grid-day';
                    const dayDate = new Date(year, month, day);
                    const dateString = dayDate.toISOString().split('T')[0];
                    dayCell.title = dateString;

                    if (activeDays.has(dateString)) {
                        dayCell.classList.add('active');
                    }
                    if (endDays.has(dateString)) {
                        dayCell.classList.add('end');
                    }
                    monthGrid.appendChild(dayCell);
                }
                monthContainer.appendChild(monthGrid);
                container.appendChild(monthContainer);
            }
        }

        function applyAndRenderJournalFilters() {
            let filteredEntries = [...allJournalEntries];
            
            const searchTerm = journalSearchInput.value.toLowerCase();
            if (searchTerm) {
                filteredEntries = filteredEntries.filter(doc => doc.data().text.toLowerCase().includes(searchTerm));
            }

            const startDate = journalFilterStartDate.value;
            const endDate = journalFilterEndDate.value;
            if (startDate) {
                const startDateTime = new Date(startDate).setHours(0, 0, 0, 0);
                filteredEntries = filteredEntries.filter(doc => doc.data().date.toDate().getTime() >= startDateTime);
            }
            if (endDate) {
                const endDateTime = new Date(endDate).setHours(23, 59, 59, 999);
                filteredEntries = filteredEntries.filter(doc => doc.data().date.toDate().getTime() <= endDateTime);
            }
            
            renderJournalEntries(filteredEntries);
        }

        function renderJournalEntries(journalDocs) {
            journalEntriesContainer.innerHTML = '';
            if (journalDocs.length === 0) {
                journalEntriesContainer.innerHTML = '<p style="text-align: center; margin-top: 20px;">No entries match your search or filter.</p>';
                return;
            }

            journalDocs.forEach(doc => {
                const entry = doc.data();
                const entryDiv = document.createElement('div');
                entryDiv.className = 'journal-entry';
                entryDiv.dataset.id = doc.id;

                const entryDate = entry.date.toDate();
                
                entryDiv.innerHTML = `
                    <div class="journal-entry-date">${formatFullDate(entryDate)}</div>
                    <div class="journal-entry-content">
                        <p class="journal-entry-text">${entry.text}</p>
                    </div>
                    <div class="journal-entry-actions">
                        <button class="edit-btn">Edit</button>
                        <button class="delete-btn">Delete</button>
                    </div>
                `;
                journalEntriesContainer.appendChild(entryDiv);
            });
        }
        
        function exportToCsv() {
            if (userLogs.length === 0) {
                console.log("No data to export.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Start Date,End Date,Duration\n";

            userLogs.forEach(doc => {
                const log = doc.data();
                const startDate = log.startDate || '';
                const endDate = log.endDate || '';
                const duration = calculateDuration(log.startDate, log.endDate).formatted || '';
                csvContent += `${startDate},${endDate},${duration}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "streaker_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function updatePublicData(user) {
            if (!user || !userData.username) {
                alert('Cannot update public data. User or username is missing.');
                return;
            };

            const logsSnapshot = await db.collection('users').doc(user.uid).collection('logs').get();
            const currentLogs = logsSnapshot.docs;
            
            const ongoingEntry = currentLogs.find(doc => !doc.data().endDate);
            const currentStreakStartDate = ongoingEntry ? ongoingEntry.data().startDate : null;
            const currentStreakDays = ongoingEntry ? calculateDuration(ongoingEntry.data().startDate, null).days : 0;

            let longestDurationMs = 0;
            let totalCompletedDurationMs = 0;
            let completedEntriesCount = 0;

            currentLogs.forEach(doc => {
                const log = doc.data();
                const duration = calculateDuration(log.startDate, log.endDate);
                if (duration.totalMilliseconds > longestDurationMs) {
                    longestDurationMs = duration.totalMilliseconds;
                }
                if (log.endDate) {
                    totalCompletedDurationMs += duration.totalMilliseconds;
                    completedEntriesCount++;
                }
            });
            const longestStreakDays = calculateDuration(null, longestDurationMs).days;
            
            let avgDurationFormatted = "0d 0h";
            if (completedEntriesCount > 0) {
                const avgMs = totalCompletedDurationMs / completedEntriesCount;
                const avgDuration = calculateDuration(null, avgMs);
                avgDurationFormatted = `${avgDuration.days}d ${avgDuration.hours}h`;
            }

            const activeDays = new Set();
            const endDays = new Set();
            currentLogs.forEach(doc => {
                const log = doc.data();
                const logStart = new Date(log.startDate + "T00:00:00");
                const logEnd = log.endDate ? new Date(log.endDate + "T00:00:00") : new Date();
                if(log.endDate) endDays.add(log.endDate);
                for (let d = new Date(logStart); d <= logEnd; d.setDate(d.getDate() + 1)) {
                    activeDays.add(d.toISOString().split('T')[0]);
                }
            });

            const achievementsConfig = [
                { name: "7-Day Streak", days: 7, icon: 'â­' },
                { name: "2-Week Streak", days: 14, icon: 'ðŸ“…' },
                { name: "30-Day Streak", days: 30, icon: 'ðŸ†' },
                { name: "90-Day Streak", days: 90, icon: 'ðŸ›¡ï¸' },
                { name: "100-Day Streak", days: 100, icon: 'ðŸ’¯' },
                { name: "One-Month Wonder", days: 30, icon: 'ðŸŒŸ' },
                { name: "Two-Month Trekker", days: 60, icon: 'ðŸš¶â€â™‚ï¸' },
                { name: "Three-Month Triumph", days: 90, icon: 'ðŸŽ‰' },
                { name: "Four-Month Force", days: 120, icon: 'ðŸ’ª' },
                { name: "Five-Month Fighter", days: 150, icon: 'ðŸ¥Š' },
                { name: "Six-Month Soarer", days: 180, icon: 'ðŸ•Šï¸' },
                { name: "Seven-Month Success", days: 210, icon: 'ðŸŽ¯' },
                { name: "Eight-Month Effort", days: 240, icon: 'ðŸ¥‡' },
                { name: "Nine-Month Ninja", days: 270, icon: 'ðŸ¥·' },
                { name: "Ten-Month Titan", days: 300, icon: 'ðŸ‘‘' },
                { name: "Eleven-Month Emperor", days: 330, icon: 'ðŸ‘‘' },
                { name: "One-Year Victor", days: 365, icon: 'ðŸ…' },
            ];

            const unlockedAchievements = achievementsConfig
                .filter(achievement => currentStreakDays >= achievement.days)
                .map(({ name, icon }) => ({ name, icon }));


            const publicData = {
                displayName: userData.username,
                currentStreakStartDate,
                longestStreakDays,
                averageStreakDuration: avgDurationFormatted,
                goalDate: goalDateInput.value || null,
                activeDays: Array.from(activeDays),
                endDays: Array.from(endDays),
                unlockedAchievements,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('publicProfiles').doc(user.uid).set(publicData);
                alert('Your public profile has been updated!');
            } catch (error) {
                console.error("Error updating public profile:", error);
                alert('Could not update public profile. Check console for errors.');
            }
        }
        
        async function handleUpdateUsername() {
            const user = auth.currentUser;
            if (!user || !userData) return;

            const newUsername = newUsernameInput.value.trim();
            const oldUsername = userData.username;
            usernameStatus.textContent = '';

            if (!newUsername) {
                usernameStatus.textContent = "Username cannot be empty.";
                return;
            }
            if (oldUsername && newUsername.toLowerCase() === oldUsername.toLowerCase()) {
                usernameStatus.textContent = "This is your current username.";
                return;
            }
            if (newUsername.length < 3 || newUsername.length > 15 || /\s/.test(newUsername)) {
                usernameStatus.textContent = "Must be 3-15 characters, no spaces.";
                return;
            }
            
            const newUsernameLower = newUsername.toLowerCase();
            const usernamesCollection = db.collection('usernames');

            try {
                await db.runTransaction(async (transaction) => {
                    const newUsernameRef = usernamesCollection.doc(newUsernameLower);
                    const newUsernameDoc = await transaction.get(newUsernameRef);

                    if (newUsernameDoc.exists) {
                        throw "This username is already taken.";
                    }
                    
                    const userRef = db.collection('users').doc(user.uid);

                    if (oldUsername) {
                        const oldUsernameLower = oldUsername.toLowerCase();
                        const oldUsernameRef = usernamesCollection.doc(oldUsernameLower);
                        transaction.delete(oldUsernameRef);
                    }

                    transaction.set(newUsernameRef, { uid: user.uid });
                    transaction.update(userRef, { username: newUsername });
                });
                
                usernameStatus.style.color = '#27ff47';
                usernameStatus.textContent = "Username updated successfully!";
                newUsernameInput.value = '';

            } catch (error) {
                console.error("Error updating username: ", error);
                usernameStatus.style.color = '#ff0000';
                usernameStatus.textContent = typeof error === 'string' ? error : "An error occurred.";
            } finally {
                 setTimeout(() => usernameStatus.textContent = '', 3000);
            }
        }


        function setAuthMode(isSignup) {
            isSignupMode = isSignup;
            authError.textContent = '';
            if (isSignup) {
                usernameInput.parentElement.classList.remove('hidden');
                mainAuthBtn.textContent = 'Create Account';
                toggleAuthModeBtn.textContent = 'Back to Log In';
                passwordInput.setAttribute('autocomplete', 'new-password');
            } else {
                usernameInput.parentElement.classList.add('hidden');
                mainAuthBtn.textContent = 'Log In';
                toggleAuthModeBtn.textContent = 'Sign Up';
                passwordInput.setAttribute('autocomplete', 'current-password');
            }
        }
        
        toggleAuthModeBtn.addEventListener('click', () => setAuthMode(!isSignupMode));

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            const username = usernameInput.value.trim();

            if (isSignupMode) {
                if (!username) {
                    authError.textContent = "Please enter a username.";
                    return;
                }
                if (username.length < 3 || username.length > 15 || /\s/.test(username)) {
                    authError.textContent = "Username must be 3-15 characters with no spaces.";
                    return;
                }

                try {
                    const usernameDoc = await db.collection('usernames').doc(username.toLowerCase()).get();
                    if (usernameDoc.exists) {
                        authError.textContent = "This username is already taken.";
                        return;
                    }

                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    const batch = db.batch();
                    
                    const userRef = db.collection('users').doc(user.uid);
                    batch.set(userRef, {
                        username: username,
                        email: user.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    const usernameRef = db.collection('usernames').doc(username.toLowerCase());
                    batch.set(usernameRef, { uid: user.uid });

                    await batch.commit();

                } catch (error) {
                    authError.textContent = error.message;
                }

            } else {
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    authError.textContent = error.message;
                }
            }
        });

        exportBtn.addEventListener('click', exportToCsv);
        
        function setActiveTab(activeTab) {
            [dashboardContainer, logbookContainer, achievementsContainer, journalContainer, aboutContainer].forEach(c => c.classList.add('hidden'));
            [dashboardTabBtn, logbookTabBtn, achievementsTabBtn, journalTabBtn, aboutTabBtn].forEach(b => b.classList.remove('active'));

            if (activeTab === 'dashboard') {
                dashboardContainer.classList.remove('hidden');
                dashboardTabBtn.classList.add('active');
            } else if (activeTab === 'stats') {
                logbookContainer.classList.remove('hidden');
                logbookTabBtn.classList.add('active');
            } else if (activeTab === 'achievements') {
                achievementsContainer.classList.remove('hidden');
                achievementsTabBtn.classList.add('active');
                renderAchievements();
            } else if (activeTab === 'journal') {
                journalContainer.classList.remove('hidden');
                journalTabBtn.classList.add('active');
            } else if (activeTab === 'about') {
                aboutContainer.classList.remove('hidden');
                aboutTabBtn.classList.add('active');
            }
        }
        
        function addMainAppEventListeners() {
            if (mainAppListenersAdded) return;
            dashboardTabBtn.addEventListener('click', () => setActiveTab('dashboard'));
            logbookTabBtn.addEventListener('click', () => setActiveTab('stats'));
            achievementsTabBtn.addEventListener('click', () => setActiveTab('achievements'));
            journalTabBtn.addEventListener('click', () => setActiveTab('journal'));
            aboutTabBtn.addEventListener('click', () => setActiveTab('about'));
            
            newLogoutBtn.addEventListener('click', () => {
                auth.signOut().then(() => {
                    window.location.reload();
                });
            });

            profileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                usernameStatus.textContent = '';
                newUsernameInput.value = '';
                profileDropdown.classList.toggle('hidden');
            });

            publicProfileToggle.addEventListener('change', async (e) => {
                const isPublic = e.target.checked;
                const user = auth.currentUser;
                if (!user) return;

                publicProfileToggle.disabled = true;

                try {
                    await db.collection('users').doc(user.uid).update({ isPublic });

                    publicLinkContainer.classList.toggle('hidden', !isPublic);
                    if (isPublic) {
                        const publicLink = `${window.location.origin}${window.location.pathname}?user=${user.uid}`;
                        publicLinkDisplay.value = publicLink;
                    }
                } catch (error) {
                    console.error("Error updating public profile status:", error);
                } finally {
                    publicProfileToggle.disabled = false;
                }
            });
            
            refreshPublicDataBtn.addEventListener('click', () => {
                updatePublicData(auth.currentUser);
            });
            
            saveUsernameBtn.addEventListener('click', handleUpdateUsername);


            window.addEventListener('click', (e) => {
                if (!profileDropdown.classList.contains('hidden') && !profileDropdown.contains(e.target) && e.target !== profileBtn) {
                    profileDropdown.classList.add('hidden');
                }
            });


            tableHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const key = header.dataset.sortKey;
                    if (sortState.key === key) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.key = key;
                        sortState.direction = 'asc';
                    }
                    renderLogs();
                });
            });

            viewMoreBtn.addEventListener('click', () => {
                visibleLogEntriesCount += 10;
                renderLogs();
            });
            
            goalInput.addEventListener('input', async (e) => {
                const goalDays = parseInt(e.target.value, 10);
                const user = auth.currentUser;
                if (!user) return;

                if (!isNaN(goalDays) && goalDays > 0) {
                     await db.collection('users').doc(user.uid).set({ goal: goalDays }, { merge: true });
                } else {
                    await db.collection('users').doc(user.uid).set({ goal: null }, { merge: true });
                }
            });

            goalDateInput.addEventListener('input', async (e) => {
                const targetDateStr = e.target.value;
                const user = auth.currentUser;
                if (!user || !targetDateStr) return;
                
                const [year, month, day] = targetDateStr.split('-').map(Number);
                const targetDate = new Date(year, month - 1, day);
                
                const today = new Date();
                targetDate.setHours(0, 0, 0, 0);
                today.setHours(0, 0, 0, 0);

                if (targetDate >= today) {
                    const timeDiff = targetDate.getTime() - today.getTime();
                    const daysFromNow = Math.round(timeDiff / (1000 * 60 * 60 * 24));

                    const currentStreak = userLogs.find(doc => !doc.data().endDate);
                    const currentDays = currentStreak ? calculateDuration(currentStreak.data().startDate, null).days : 0;
                    
                    const totalGoalDays = currentDays + daysFromNow;

                    if (totalGoalDays > 0) {
                        await db.collection('users').doc(user.uid).set({ goal: totalGoalDays }, { merge: true });
                    }
                }
            });

            const prevYearBtn = document.getElementById('prev-year-btn');
            const nextYearBtn = document.getElementById('next-year-btn');

            function updateYearNavButtons() {
                if(nextYearBtn) nextYearBtn.disabled = displayedYear >= new Date().getFullYear();
            }

            if (prevYearBtn) {
                prevYearBtn.addEventListener('click', () => {
                    displayedYear--;
                    renderCondensedCalendar(displayedYear, userLogs);
                    updateYearNavButtons();
                });
            }

            if (nextYearBtn) {
                nextYearBtn.addEventListener('click', () => {
                    displayedYear++;
                    renderCondensedCalendar(displayedYear, userLogs);
                    updateYearNavButtons();
                });
            }

            updateYearNavButtons();


            journalSearchInput.addEventListener('input', applyAndRenderJournalFilters);
            journalFilterStartDate.addEventListener('change', applyAndRenderJournalFilters);
            journalFilterEndDate.addEventListener('change', applyAndRenderJournalFilters);
            journalFilterClearBtn.addEventListener('click', () => {
                journalSearchInput.value = '';
                journalFilterStartDate.value = '';
                journalFilterEndDate.value = '';
                applyAndRenderJournalFilters();
            });
            
            modalCloseBtn.addEventListener('click', () => journalModal.style.display = 'none');
            journalModal.addEventListener('click', (e) => {
                if (e.target === journalModal) {
                    journalModal.style.display = 'none';
                }
            });

            entryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const user = auth.currentUser;
                
                const ongoingEntries = userLogs.filter(doc => !doc.data().endDate);
                if (ongoingEntries.length > 0 && !endDate) {
                    authError.textContent = "You can only have one ongoing streak at a time.";
                    return;
                }

                if (user && startDate) {
                    await db.collection('users').doc(user.uid).collection('logs').add({
                        startDate,
                        endDate: endDate || null,
                    });
                    startDateInput.value = '';
                    endDateInput.value = '';
                    authError.textContent = '';
                }
            });

            journalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = journalInput.value.trim();
                const user = auth.currentUser;

                if (user && text) {
                    await db.collection('users').doc(user.uid).collection('journal').add({
                        text,
                        date: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    journalInput.value = '';
                }
            });
            
            logTableBody.addEventListener('click', async (e) => {
                const user = auth.currentUser;
                if (!user) return;
                const row = e.target.closest('tr');
                if (!row) return;
                const docId = row.dataset.id;
                const logsCollection = db.collection('users').doc(user.uid).collection('logs');

                if (e.target.classList.contains('delete-btn')) {
                    await logsCollection.doc(docId).delete();
                }

                if (e.target.classList.contains('edit-btn')) {
                    currentEditingLogId = docId;
                    renderLogs();
                }

                if (e.target.classList.contains('save-btn')) {
                    const newStartDate = row.querySelector('td.start-date-cell input').value;
                    const newEndDate = row.querySelector('td.end-date-cell input').value;
                    
                    if (newStartDate) {
                        await logsCollection.doc(docId).update({
                            startDate: newStartDate,
                            endDate: newEndDate || null
                        });
                    }
                    currentEditingLogId = null;
                }

                if (e.target.classList.contains('cancel-btn')) {
                    currentEditingLogId = null;
                    renderLogs();
                }

                if (e.target.classList.contains('end-streak-btn')) {
                    const currentDate = new Date().toISOString().split('T')[0];
                    await logsCollection.doc(docId).update({
                        endDate: currentDate
                    });
                }
            });

            journalEntriesContainer.addEventListener('click', async (e) => {
                const user = auth.currentUser;
                if (!user) return;

                const entryDiv = e.target.closest('.journal-entry');
                if (!entryDiv) return;
                const docId = entryDiv.dataset.id;
                const journalCollection = db.collection('users').doc(user.uid).collection('journal');
                
                if (e.target.classList.contains('delete-btn')) {
                    await journalCollection.doc(docId).delete();
                }

                if (e.target.classList.contains('edit-btn')) {
                    const contentDiv = entryDiv.querySelector('.journal-entry-content');
                    const currentText = contentDiv.querySelector('p').textContent;

                    contentDiv.innerHTML = `
                        <textarea class="journal-edit-area" style="width: 100%; min-height: 100px;">${currentText}</textarea>
                        <button class="save-btn">Save</button>
                    `;
                }

                if (e.target.classList.contains('save-btn')) {
                    const newText = entryDiv.querySelector('.journal-edit-area').value.trim();
                    if (newText) {
                        await journalCollection.doc(docId).update({
                            text: newText
                        });
                    }
                }
            });
            
            mainAppListenersAdded = true;
        }


        function initializeAppForUser(user) {
            authContainer.classList.add('hidden');
            mainAppContainer.classList.remove('hidden');
            authError.textContent = '';
            
            addMainAppEventListeners();

            db.collection('users').doc(user.uid).collection('logs')
                .orderBy('startDate', 'desc')
                .onSnapshot(snapshot => {
                    userLogs = snapshot.docs;
                    visibleLogEntriesCount = 5;
                    renderLogs();
                    calculateStats();
                    renderAchievements();
                });
            
            db.collection('users').doc(user.uid).collection('journal')
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    allJournalEntries = snapshot.docs;
                    applyAndRenderJournalFilters(); 
                });

            db.collection('users').doc(user.uid)
                .onSnapshot(async (doc) => {
                    if (doc.exists) {
                        userData = doc.data();
                        
                        userProfileDisplay.textContent = userData.username || user.email;

                        const isPublic = !!userData.isPublic;
                        publicProfileToggle.checked = isPublic;
                        publicLinkContainer.classList.toggle('hidden', !isPublic);
                        if(isPublic) {
                            const publicLink = `${window.location.origin}${window.location.pathname}?user=${user.uid}`;
                            publicLinkDisplay.value = publicLink;
                        }

                        if (userData && userData.goal) {
                            const goalDays = userData.goal;
                            goalInput.value = goalDays;
                            updateGoalProgress(goalDays);
                        } else {
                            goalInput.value = '';
                            goalDateInput.value = '';
                            updateGoalProgress(0);
                        }
                    }
                });
            
            setActiveTab('dashboard');
        }

        function showLoginScreen() {
            authContainer.classList.remove('hidden');
            mainAppContainer.classList.add('hidden');
            publicViewContainer.classList.add('hidden');
            journalModal.style.display = 'none'; 
            if(profileDropdown) profileDropdown.classList.add('hidden');
            Object.values(durationIntervals).forEach(clearInterval);
            durationIntervals = {};
            setAuthMode(false);
        }

        function renderPublicView(data, year) {
            let currentStreakHTML = "N/A";
            if (data.currentStreakStartDate) {
                currentStreakHTML = calculateDuration(data.currentStreakStartDate, null).formatted;
            }

            const achievementsHTML = data.unlockedAchievements && data.unlockedAchievements.length > 0
                ? data.unlockedAchievements.map(ach => `
                    <div class="badge-card">
                        <div class="badge-icon unlocked">${ach.icon}</div>
                        <div class="badge-name">${ach.name}</div>
                    </div>
                `).join('')
                : '<p style="text-align:center; font-style: italic; color: #aaa; grid-column: 1 / -1;">No achievements earned on the current streak.</p>';

            publicViewContainer.innerHTML = `
                <div class="header">
                    <div class="logo-and-title">
                        <img src="https://raw.githubusercontent.com/rynwynk/streaker-app/main/logo%20only.png" alt="Streaker Logo" class="logo">
                        <div>
                            <h2>Streaker</h2>
                            <p class="subtitle">Satisfied Through Denial</p>
                        </div>
                    </div>
                </div>
                <h2 class="stats-section-header" style="margin-top:0;">Public Profile for ${data.displayName || 'Anonymous User'}</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Current Streak</h3>
                        <p id="public-current-streak">${currentStreakHTML}</p>
                    </div>
                    <div class="stat-card">
                        <h3>Longest Streak</h3>
                        <p>${data.longestStreakDays} days</p>
                    </div>
                     <div class="stat-card">
                        <h3>Average Streak</h3>
                        <p>${data.averageStreakDuration || '0d 0h'}</p>
                    </div>
                </div>

                <h2 class="stats-section-header">Achievements</h2>
                <div class="achievements-grid">
                    ${achievementsHTML}
                </div>

                <div class="stats-section-header year-nav">
                    <button id="public-prev-year-btn" title="Previous Year">&lt;</button>
                    <h2 style="margin: 0;">Year in Review (<span id="public-year-label">${year}</span>)</h2>
                    <button id="public-next-year-btn" title="Next Year">&gt;</button>
                </div>
                <div id="public-condensed-calendar-container"></div>
                 <p style="text-align: center; font-size: 0.8em; margin-top: 15px;">
                    <span style="display: inline-block; width: 12px; height: 12px; background-color: #27ff47;"></span> Streak Day
                </p>
            `;
            
            const publicLogs = [];
            if (data.activeDays) {
                data.activeDays.forEach(day => {
                    publicLogs.push({ data: () => ({ startDate: day, endDate: data.endDays.includes(day) ? day : day }) });
                });
            }
            
            renderCondensedCalendar(year, publicLogs, '#public-condensed-calendar-container', '#public-year-label');

            const publicPrevBtn = document.getElementById('public-prev-year-btn');
            const publicNextBtn = document.getElementById('public-next-year-btn');
            const urlParams = new URLSearchParams(window.location.search);
            const publicUserId = urlParams.get('user');
            
            publicNextBtn.disabled = year >= new Date().getFullYear();

            publicPrevBtn.addEventListener('click', () => {
                urlParams.set('year', year - 1);
                urlParams.set('user', publicUserId);
                window.location.search = urlParams.toString();
            });
            publicNextBtn.addEventListener('click', () => {
                urlParams.set('year', year + 1);
                 urlParams.set('user', publicUserId);
                window.location.search = urlParams.toString();
            });

            if (data.currentStreakStartDate) {
                setInterval(() => {
                    const el = document.getElementById('public-current-streak');
                    if(el) {
                        el.textContent = calculateDuration(data.currentStreakStartDate, null).formatted;
                    }
                }, 60000);
            }
        }


        async function startApp() {
            const urlParams = new URLSearchParams(window.location.search);
            const publicUserId = urlParams.get('user');
            const publicYear = parseInt(urlParams.get('year'), 10) || new Date().getFullYear();

            if (publicUserId) {
                // Public view mode
                loadingContainer.classList.add('hidden');
                publicViewContainer.classList.remove('hidden');
                try {
                    const doc = await db.collection('publicProfiles').doc(publicUserId).get();
                    if (doc.exists) {
                        renderPublicView(doc.data(), publicYear);
                    } else {
                        publicViewContainer.innerHTML = '<p style="text-align:center;">This public profile does not exist or has been disabled.</p>';
                    }
                } catch (error) {
                    console.error("Error loading public profile:", error);
                    publicViewContainer.innerHTML = '<p style="text-align:center;">Could not load public profile.</p>';
                }
            } else {
                // Normal authenticated user mode
                auth.onAuthStateChanged(user => {
                    loadingContainer.classList.add('hidden'); 

                    if (user) {
                        initializeAppForUser(user);
                    } else {
                        showLoginScreen();
                    }
                });
            }
        }
        
        startApp();
    </script>
</body>
</html>



